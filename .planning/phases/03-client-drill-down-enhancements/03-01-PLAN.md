---
phase: 03-client-drill-down-enhancements
plan: 01
type: execute
wave: 1
depends_on:
  - "03-00"
files_modified:
  - app/src/components/reports/ReportsContent.tsx
  - app/src/components/reports/ByClientTab.tsx
autonomous: true
requirements:
  - CDR-01

must_haves:
  truths:
    - "Client drill-down shows a topic breakdown horizontal bar chart with hours per topic"
    - "Each topic bar displays hours and percentage of total (e.g. '12.5h (34%)')"
    - "Topics with zero hours are hidden from the chart"
    - "Topic Breakdown and Hours by Employee charts appear side-by-side on desktop, stacked on mobile"
    - "topicName flows from ReportsContent Entry type into ByClientTab Entry type"
  artifacts:
    - path: "app/src/components/reports/ReportsContent.tsx"
      provides: "Entry type with topicName, transformedEntries includes topicName"
      contains: "topicName"
    - path: "app/src/components/reports/ByClientTab.tsx"
      provides: "Topic breakdown chart, side-by-side layout, topics on ClientStats"
      contains: "Topic Breakdown"
  key_links:
    - from: "app/src/components/reports/ReportsContent.tsx"
      to: "app/src/components/reports/ByClientTab.tsx"
      via: "Entry.topicName passed through entries prop"
      pattern: "topicName: e\\.topicName"
    - from: "app/src/components/reports/ByClientTab.tsx"
      to: "app/src/components/reports/charts/BarChart.tsx"
      via: "topic chart data passed to BarChart component"
      pattern: "BarChart.*topicChartData"
---

<objective>
Add topic breakdown chart to client drill-down and restructure the layout with side-by-side charts.

Purpose: Admins need to see how hours are distributed across topics when drilling into a specific client (CDR-01). This also sets up the Entry type with topicName for the next plan's topic column.
Output: Topic breakdown horizontal bar chart with "Xh (Y%)" labels, side-by-side chart layout, topicName flowing through Entry type.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-drill-down-enhancements/03-CONTEXT.md
@.planning/phases/03-client-drill-down-enhancements/03-RESEARCH.md
@app/src/components/reports/ByClientTab.tsx
@app/src/components/reports/ReportsContent.tsx
@app/src/components/reports/charts/BarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add topicName to Entry type and topics to ByClientTab ClientStats</name>
  <files>
    app/src/components/reports/ReportsContent.tsx
    app/src/components/reports/ByClientTab.tsx
  </files>
  <action>
1. In `ReportsContent.tsx`, add `topicName: string` to the local `Entry` interface (around line 49-62).

2. In `ReportsContent.tsx`, update the `transformedEntries` mapping (around line 249-262) to include `topicName: e.topicName` in the mapped object. The raw API entry already has `topicName` (line 82).

3. In `ByClientTab.tsx`, add `topicName: string` to the local `Entry` interface (around line 14-27).

4. In `ByClientTab.tsx`, add `topics` to the local `ClientStats` interface (around line 6-12):
   ```typescript
   topics: { topicName: string; totalHours: number; writtenOffHours: number }[];
   ```
   The parent `ReportsContent.tsx` already passes `data.byClient` which includes `topics: TopicAggregation[]` from the API. The local interface just needs to declare it.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit --pretty 2>&1 | head -50 && npm run test -- --run ByClientTab</automated>
    <manual>No TypeScript errors related to Entry or ClientStats types</manual>
  </verify>
  <done>Entry interface includes topicName in both ReportsContent and ByClientTab. ClientStats in ByClientTab includes topics array. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add topic breakdown chart and restructure drill-down layout</name>
  <files>
    app/src/components/reports/ByClientTab.tsx
  </files>
  <action>
In `ByClientTab.tsx`, refactor the drill-down section (the `if (selectedClient)` block starting around line 76) to add a topic breakdown chart and restructure the layout:

1. **Prepare topic chart data** (after the `employeeChartData` calculation, around line 133-135):
   ```typescript
   const topicChartData = selectedClient.topics
     .filter((t) => t.totalHours > 0)
     .map((t) => {
       const pct = selectedClient.totalHours > 0
         ? Math.round((t.totalHours / selectedClient.totalHours) * 100)
         : 0;
       return {
         name: `${t.topicName}  ${formatHours(t.totalHours)} (${pct}%)`,
         value: t.totalHours,
       };
     })
     .sort((a, b) => b.value - a.value);
   ```
   Include hours and percentage in the `name` field (shown on Y-axis labels in vertical/horizontal-bar layout). This avoids the pitfall of polluting the X-axis numeric ticks with percentage text via `valueFormatter`. Use two spaces before the hours to visually separate topic name from stats.

2. **Restructure layout** — replace the current single "Hours by Employee" chart card + entries table structure with:
   - Header (back button, client name, total hours, revenue) — keep as-is
   - Side-by-side chart section with responsive grid:
     ```tsx
     <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
       {/* Topic Breakdown */}
       <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
         <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
           Topic Breakdown
         </h3>
         <div className="h-64">
           <BarChart data={topicChartData} valueFormatter={formatHours} layout="vertical" />
         </div>
       </div>
       {/* Hours by Employee */}
       <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
         <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
           Hours by Employee
         </h3>
         <div className="h-64">
           <BarChart data={employeeChartData} valueFormatter={formatHours} layout="vertical" />
         </div>
       </div>
     </div>
     ```
   - Keep the entries table section BELOW the charts (it will be replaced in plan 02).

3. **Dynamic chart height** — If there are many topics, the chart should be taller. Use a minimum of `h-64` (256px) but scale up: `Math.max(256, topicChartData.length * 40)` pixels for the topic chart container, using inline `style={{ height }}` instead of the Tailwind class. This ensures labels remain readable when there are 8+ topics. Apply the same scaling to the employee chart for visual consistency.

4. **Section heading for entries** — Update the existing "Recent Entries" heading text to just "Entries" (it will show all entries after plan 02, not just recent ones). Keep the heading wrapper as-is for now.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit --pretty 2>&1 | head -50 && npm run test -- --run ByClientTab</automated>
    <manual>Run dev server, navigate to Reports > By Client > click a client. Verify: (1) Topic Breakdown chart appears with horizontal bars showing "TopicName  Xh (Y%)" labels, (2) Hours by Employee chart appears side-by-side with Topic Breakdown on desktop, (3) Charts stack vertically on narrow screens, (4) Zero-hour topics are hidden.</manual>
  </verify>
  <done>Topic breakdown horizontal bar chart renders in client drill-down showing hours and percentage per topic. Charts are side-by-side on desktop (md breakpoint), stacked on mobile. Zero-hour topics are filtered out. Chart height scales with number of items.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd app && npx tsc --noEmit` — no errors
2. Dev server runs: `npm run dev` — no console errors
3. Visual check: Reports > By Client > click client with entries → Topic Breakdown chart visible with correct data
4. Responsive: Resize browser below md breakpoint → charts stack vertically
5. Edge case: Client with only 1 topic → single bar with "100%" label
</verification>

<success_criteria>
- Topic breakdown chart renders with horizontal bars for each topic
- Each bar's Y-axis label shows "TopicName  Xh (Y%)" format
- Zero-hour topics are not shown
- Topic Breakdown and Hours by Employee are in a responsive 2-column grid
- topicName is available on Entry type (ready for plan 02's topic column)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-drill-down-enhancements/03-01-SUMMARY.md`
</output>
