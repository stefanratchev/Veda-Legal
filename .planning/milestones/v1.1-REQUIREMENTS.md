# v1.1 Requirements — E2E Timesheets

**Milestone:** v1.1 E2E Timesheets
**Goal:** Browser-level regression protection for the revenue-critical timesheet workflow
**Scope:** Table stakes + CI integration
**Defined:** 2026-02-25

## Requirements

### Infrastructure

| ID | Requirement | Priority | Phase Hint |
|----|-------------|----------|------------|
| REQ-01 | Auth bypass via JWT cookie injection using `next-auth/jwt` `encode()` — zero production auth code changes | P0 | Infra |
| REQ-02 | Playwright config with setup project, Chromium-only, serial execution (`workers: 1`), HTML reporter | P0 | Infra |
| REQ-03 | Separate test database (`veda_legal_test`) with seed data (1 user, 2 clients, 2 topics, 3 subtopics) | P0 | Infra |
| REQ-04 | DB fixtures with `TRUNCATE ... CASCADE` cleanup in `beforeEach` for mutable tables | P0 | Infra |
| REQ-05 | Composed test export (`test.extend()`) combining auth + db fixtures | P0 | Infra |
| REQ-06 | `data-testid` attributes on 6 key components: ClientSelect, TopicCascadeSelect, DurationPicker, EntryCard, WeekStrip, submit button | P0 | Infra |
| REQ-07 | `.env.test` with TEST_DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL | P0 | Infra |
| REQ-08 | `test:e2e` and `test:e2e:ui` npm scripts in package.json | P0 | Infra |
| REQ-09 | Playwright artifacts in `.gitignore` (e2e/.auth/, test-results/, playwright-report/) | P0 | Infra |
| REQ-10 | Smoke test: `page.goto('/timesheets')` renders without redirect to `/login` | P0 | Infra |

### Test Coverage

| ID | Requirement | Priority | Phase Hint |
|----|-------------|----------|------------|
| REQ-11 | TimesheetsPage Page Object Model: `createEntry()`, `editEntry()`, `deleteEntry()`, `navigateToDate()`, `submitDay()`, `getEntryRows()` | P0 | Tests |
| REQ-12 | API data factory: `createEntryViaAPI()` using `page.request.post('/api/timesheets')` | P0 | Tests |
| REQ-13 | Create entry test: REGULAR client with subtopic (prefix behavior) | P0 | Tests |
| REQ-14 | Create entry test: INTERNAL client with topic-only (no subtopic) | P0 | Tests |
| REQ-15 | Edit entry test: change description, change hours | P0 | Tests |
| REQ-16 | Edit entry test: cancel discards changes | P0 | Tests |
| REQ-17 | Delete entry test: confirm removes entry | P0 | Tests |
| REQ-18 | Delete entry test: cancel preserves entry | P0 | Tests |
| REQ-19 | WeekStrip navigation: select specific day, verify entries reload | P0 | Tests |
| REQ-20 | WeekStrip navigation: prev/next week arrows shift the week | P0 | Tests |
| REQ-21 | WeekStrip navigation: Today button returns to current day | P0 | Tests |
| REQ-22 | WeekStrip persistence: entry created on day A persists when navigating away and back | P0 | Tests |
| REQ-23 | Submission flow: log 8+ hours via API factory, submit, verify status indicator | P0 | Tests |
| REQ-24 | Submission auto-prompt: modal appears at 8h threshold | P0 | Tests |

### CI Integration

| ID | Requirement | Priority | Phase Hint |
|----|-------------|----------|------------|
| REQ-25 | New `e2e` job in `.github/workflows/ci.yml` | P0 | CI |
| REQ-26 | PostgreSQL 17 service container with `veda_legal_test` database and health check | P0 | CI |
| REQ-27 | Chromium browser caching via `actions/cache@v4` | P0 | CI |
| REQ-28 | `npm run db:migrate` against test database before tests | P0 | CI |
| REQ-29 | Upload `playwright-report/` as artifact on failure | P0 | CI |
| REQ-30 | Existing unit test job unaffected — both jobs run independently | P0 | CI |

### Constraints

- All e2e tests use Playwright locators (role, label, testid) — no CSS class selectors
- Zero `page.waitForTimeout()` calls — use auto-waiting assertions and `waitForResponse()`
- Auth bypass lives entirely in `e2e/` directory — no production code changes except `data-testid` attributes
- Target ~15 e2e tests — do not duplicate unit-tested behavior (965 existing Vitest tests)
- Chromium-only, serial execution — multi-browser and parallel execution deferred

### Out of Scope

- Admin/billing e2e tests (separate milestone)
- Reports e2e tests (Recharts hard to assert on)
- Multi-browser testing (internal app, all Chrome)
- Visual regression testing (dynamic data + Tailwind = false positives)
- Parallel execution (only warranted if >50 tests)
- Accessibility checks (should-have, deferred)
- Test tagging and selective CI execution (should-have, deferred)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| REQ-01 | Phase 5: Test Infrastructure | Complete |
| REQ-02 | Phase 5: Test Infrastructure | Complete |
| REQ-03 | Phase 5: Test Infrastructure | Complete |
| REQ-04 | Phase 5: Test Infrastructure | Complete |
| REQ-05 | Phase 5: Test Infrastructure | Complete |
| REQ-06 | Phase 5: Test Infrastructure | Complete |
| REQ-07 | Phase 5: Test Infrastructure | Complete |
| REQ-08 | Phase 5: Test Infrastructure | Complete |
| REQ-09 | Phase 5: Test Infrastructure | Complete |
| REQ-10 | Phase 5: Test Infrastructure | Complete |
| REQ-11 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-12 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-13 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-14 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-15 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-16 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-17 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-18 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-19 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-20 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-21 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-22 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-23 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-24 | Phase 6: Core Timesheet Workflow Tests | Complete |
| REQ-25 | Phase 7: CI Integration | Complete |
| REQ-26 | Phase 7: CI Integration | Complete |
| REQ-27 | Phase 7: CI Integration | Complete |
| REQ-28 | Phase 7: CI Integration | Complete |
| REQ-29 | Phase 7: CI Integration | Complete |
| REQ-30 | Phase 7: CI Integration | Complete |

---
*30 requirements across 3 categories (Infrastructure: 10, Tests: 14, CI: 6)*
