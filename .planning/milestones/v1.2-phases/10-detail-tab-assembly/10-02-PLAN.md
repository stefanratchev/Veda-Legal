---
phase: 10-detail-tab-assembly
plan: 02
type: tdd
wave: 2
depends_on: [01]
files_modified:
  - app/src/components/reports/DetailTab.tsx
  - app/src/components/reports/DetailTab.test.tsx
autonomous: true
requirements:
  - TABL-01
  - TABL-02
  - TABL-03

must_haves:
  truths:
    - "User sees entry table with Date, Employee, Client, Topic, Subtopic, Description, Hours columns"
    - "Admin additionally sees a Revenue column in the entry table"
    - "Non-admin does NOT see a Revenue column"
    - "User can sort the entry table by clicking column headers"
    - "Entry table defaults to date descending sort (most recent first)"
    - "User can paginate the entry table at 50 entries per page"
    - "Entry table updates when filters change (shows only filtered entries)"
    - "Long descriptions are truncated with ellipsis and show full text on hover"
  artifacts:
    - path: "app/src/components/reports/DetailTab.tsx"
      provides: "Updated DetailTab with entry table section below charts"
      exports: ["DetailTab"]
    - path: "app/src/components/reports/DetailTab.test.tsx"
      provides: "Additional tests for entry table rendering, columns, admin gating"
  key_links:
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/components/ui/DataTable"
      via: "import and render with filtered ReportEntry[], column definitions, pageSize={50}"
      pattern: "DataTable.*data.*columns.*pageSize"
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/components/ui/table-types"
      via: "import ColumnDef type for column definitions"
      pattern: "ColumnDef.*ReportEntry"
---

<objective>
Add the entry table to the DetailTab component with all required columns, admin revenue gating, sorting, pagination at 50 entries per page, and description truncation. Uses TDD to verify column rendering and admin-gated behavior.

Purpose: TABL-01 requires a full entry table with seven columns. TABL-02 requires admin-only Revenue column. TABL-03 requires sorting and pagination at 50/page. This plan completes the Detail tab by adding the table section below the charts.

Output: DetailTab updated with DataTable rendering filtered entries, complete with column definitions and tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-tab-assembly/10-CONTEXT.md
@.planning/phases/10-detail-tab-assembly/10-RESEARCH.md
@.planning/phases/10-detail-tab-assembly/10-01-SUMMARY.md
@app/src/components/reports/DetailTab.tsx
@app/src/components/reports/DetailTab.test.tsx
@app/src/components/ui/DataTable.tsx
@app/src/components/ui/table-types.ts
@app/src/components/reports/ByClientTab.tsx
@app/src/types/reports.ts
@app/src/lib/date-utils.ts
</context>

<feature>
  <name>Entry Table in DetailTab</name>
  <files>app/src/components/reports/DetailTab.tsx, app/src/components/reports/DetailTab.test.tsx</files>
  <behavior>
    The DetailTab (created in Plan 01) gains a DataTable below the charts section showing filtered ReportEntry records.

    **Column definitions (all users):**
    1. Date -- accessor: r.date, sortable, cell: formatted as "20 Dec" style (day + short month)
    2. Employee -- accessor: r.userName, sortable
    3. Client -- accessor: r.clientName, sortable
    4. Topic -- accessor: r.topicName, sortable
    5. Subtopic -- accessor: r.subtopicName, NOT sortable
    6. Description -- accessor: r.description, NOT sortable, cell: truncated with `max-w-xs truncate block` and `title` attribute for hover tooltip
    7. Hours -- accessor: r.hours, sortable, align: right, cell: formatted with formatHours()

    **Admin-only column:**
    8. Revenue -- accessor: r.revenue, sortable, align: right, cell: formatted as EUR (null displays as dash)

    **Table configuration:**
    - `pageSize={50}` (50 entries per page)
    - `defaultSort={{ columnId: "date", direction: "desc" }}` (most recent first)
    - `getRowKey={(entry) => entry.id}`
    - `emptyMessage="No entries match the selected filters"`

    **Data source:** The same `filteredEntries` useMemo from Plan 01 feeds both charts and the table.

    **Revenue column gating:** Build the columns array with a conditional spread:
    ```typescript
    const columns: ColumnDef<ReportEntry>[] = [
      ...baseColumns,
      ...(isAdmin ? [revenueColumn] : []),
    ];
    ```

    Test cases (RED phase):
    - Entry table renders with 7 base columns (Date, Employee, Client, Topic, Subtopic, Description, Hours)
    - Admin sees 8 columns (base + Revenue)
    - Non-admin does NOT see Revenue column
    - Table data comes from filtered entries (passes filteredEntries to DataTable)
    - Default sort is date descending
    - Page size is 50
    - Description column truncates long text with title attribute for hover
    - Date column formats as "20 Dec" style
    - Hours column right-aligned with formatted value
    - Revenue column shows formatted EUR for non-null values and dash for null
    - Table shows empty message when no entries match filters
  </behavior>
  <implementation>
    **Add to DetailTab.tsx (below the chart grid, above the closing div):**

    Import DataTable and ColumnDef:
    ```typescript
    import { DataTable } from "@/components/ui/DataTable";
    import { ColumnDef } from "@/components/ui/table-types";
    ```

    **Column definitions (defined inside the component or via useMemo for the admin conditional):**
    ```typescript
    const columns = useMemo(() => {
      const base: ColumnDef<ReportEntry>[] = [
        {
          id: "date",
          header: "Date",
          accessor: (r) => r.date,
          cell: (r) => (
            <span className="text-[var(--text-secondary)] text-[13px]">
              {formatDateDisplay(r.date)}
            </span>
          ),
        },
        {
          id: "employee",
          header: "Employee",
          accessor: (r) => r.userName,
          cell: (r) => (
            <span className="text-[var(--text-primary)] text-[13px]">{r.userName}</span>
          ),
        },
        {
          id: "client",
          header: "Client",
          accessor: (r) => r.clientName,
          cell: (r) => (
            <span className="text-[var(--text-primary)] text-[13px]">{r.clientName}</span>
          ),
        },
        {
          id: "topic",
          header: "Topic",
          accessor: (r) => r.topicName,
          cell: (r) => (
            <span className="text-[var(--text-secondary)] text-[13px]">{r.topicName}</span>
          ),
        },
        {
          id: "subtopic",
          header: "Subtopic",
          accessor: (r) => r.subtopicName,
          sortable: false,
          cell: (r) => (
            <span className="text-[var(--text-secondary)] text-[13px]">{r.subtopicName || "\u2014"}</span>
          ),
        },
        {
          id: "description",
          header: "Description",
          accessor: (r) => r.description,
          sortable: false,
          cell: (r) => (
            <span
              className="text-[var(--text-secondary)] text-[13px] max-w-xs truncate block"
              title={r.description}
            >
              {r.description}
            </span>
          ),
        },
        {
          id: "hours",
          header: "Hours",
          accessor: (r) => r.hours,
          align: "right" as const,
          cell: (r) => (
            <span className="text-[var(--text-primary)] text-[13px]">{formatHours(r.hours)}</span>
          ),
        },
      ];

      if (isAdmin) {
        base.push({
          id: "revenue",
          header: "Revenue",
          accessor: (r) => r.revenue,
          align: "right" as const,
          cell: (r) => (
            <span className="text-[var(--accent-pink)] text-[13px] font-medium">
              {r.revenue != null ? formatCurrency(r.revenue) : "\u2014"}
            </span>
          ),
        });
      }

      return base;
    }, [isAdmin]);
    ```

    **Helper functions (add to DetailTab.tsx or extract if shared):**
    ```typescript
    function formatDateDisplay(dateStr: string): string {
      const [year, month, day] = dateStr.split("-").map(Number);
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
    }

    function formatCurrency(amount: number): string {
      return new Intl.NumberFormat("en-GB", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount);
    }
    ```

    Note: These formatDateDisplay and formatCurrency functions follow the exact same pattern used in ByClientTab.tsx. They can be defined locally in DetailTab.tsx.

    **DataTable render (add after the chart rows, before closing div):**
    ```tsx
    {/* Entry Table */}
    <DataTable
      data={filteredEntries}
      columns={columns}
      getRowKey={(entry) => entry.id}
      pageSize={50}
      defaultSort={{ columnId: "date", direction: "desc" }}
      emptyMessage="No entries match the selected filters"
    />
    ```

    **Test additions:**
    Extend the existing DetailTab.test.tsx from Plan 01. Tests should verify:
    - DataTable receives filteredEntries as data prop
    - DataTable receives pageSize={50}
    - DataTable receives defaultSort with date desc
    - Column count is 7 for non-admin, 8 for admin
    - Revenue column header only present when isAdmin=true

    Mock DataTable to inspect props:
    ```typescript
    vi.mock("@/components/ui/DataTable", () => ({
      DataTable: (props: Record<string, unknown>) => (
        <div data-testid="data-table" data-page-size={props.pageSize} data-column-count={(props.columns as unknown[]).length}>
          {/* Render minimal to inspect props */}
        </div>
      ),
    }));
    ```
  </implementation>
</feature>

<verification>
```bash
cd app && npm run test -- DetailTab --run
```
All DetailTab tests pass (both chart and table tests). No regressions:
```bash
cd app && npm run test -- --run
```
</verification>

<success_criteria>
- Entry table renders below charts with 7 columns for all users
- Admin sees 8th Revenue column with EUR-formatted values
- Non-admin does not see Revenue column
- Table uses filteredEntries (same data feeding charts) so it updates with filters
- Default sort is date descending (most recent first)
- 50 entries per page with pagination controls
- Long descriptions truncated with ellipsis, full text on hover via title attribute
- Revenue null values display as a dash
- Empty message shown when no entries match filters
- All tests pass including existing suite (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-tab-assembly/10-02-SUMMARY.md`
</output>
