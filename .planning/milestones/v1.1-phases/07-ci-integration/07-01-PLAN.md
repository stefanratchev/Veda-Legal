---
phase: 07-ci-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/playwright.config.ts
  - .github/workflows/ci.yml
autonomous: true
requirements:
  - REQ-25
  - REQ-26
  - REQ-27
  - REQ-28
  - REQ-29
  - REQ-30

must_haves:
  truths:
    - "A new `e2e` job appears in the CI workflow and runs on every PR to `main`"
    - "The e2e job provisions its own PostgreSQL 17 database and executes Playwright tests against a production build"
    - "When e2e tests fail, the HTML report is uploaded as a downloadable artifact"
    - "The existing unit test job continues to run independently and is unaffected"
    - "Chromium browser binary is cached between CI runs to reduce install time"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "e2e job with PostgreSQL service, Chromium caching, artifact upload"
      contains: "e2e:"
    - path: "app/playwright.config.ts"
      provides: "CI-aware webServer command (production build in CI, dev server locally)"
      contains: "process.env.CI"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "app/playwright.config.ts"
      via: "npx playwright test step reads config for webServer command"
      pattern: "npx playwright test"
    - from: ".github/workflows/ci.yml"
      to: "app/e2e/"
      via: "Playwright test runner discovers and executes spec files"
      pattern: "npx playwright test"
    - from: ".github/workflows/ci.yml"
      to: "drizzle-kit push"
      via: "Schema provisioning step before test execution"
      pattern: "npx drizzle-kit push"
---

<objective>
Add a new `e2e` job to the existing CI workflow that provisions a PostgreSQL 17 database, builds the Next.js app, and runs Playwright tests against the production build on every PR to `main`.

Purpose: Catch timesheet workflow regressions before merge -- the e2e tests from Phase 6 run automatically in CI so manual verification isn't needed.
Output: Updated `ci.yml` with `e2e` job, updated `playwright.config.ts` with CI-aware webServer command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ci-integration/07-RESEARCH.md
@.github/workflows/ci.yml
@app/playwright.config.ts
@app/.env.test
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make Playwright config CI-aware for production build</name>
  <files>app/playwright.config.ts</files>
  <action>
Modify the `webServer.command` in `playwright.config.ts` to use a production build in CI and the dev server locally.

Change the webServer block from:
```typescript
webServer: {
  command: "npm run dev -- --port 3001",
```

To:
```typescript
webServer: {
  command: process.env.CI
    ? "npm run start -- --port 3001"
    : "npm run dev -- --port 3001",
```

The rest of the webServer config (`url`, `reuseExistingServer`, `timeout`, `env`) stays unchanged. The existing `reuseExistingServer: !process.env.CI` is already correct (forces fresh server in CI).

**Why:** CI should test against the production build (`next build && next start`) to match real deployment behavior. The build step itself happens separately in the CI workflow before `npx playwright test`, so the webServer only needs to run `next start`. Locally, `npm run dev` is faster for iterative development.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && node -e "const c = require('fs').readFileSync('playwright.config.ts','utf8'); const hasCICheck = c.includes('process.env.CI') && c.includes('npm run start'); const hasDev = c.includes('npm run dev'); console.log(hasCICheck && hasDev ? 'PASS' : 'FAIL')"</automated>
    <manual>Open playwright.config.ts and verify the webServer.command uses a ternary on process.env.CI</manual>
  </verify>
  <done>The webServer command conditionally uses `npm run start -- --port 3001` in CI and `npm run dev -- --port 3001` locally. No other config changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add e2e job to CI workflow with PostgreSQL, Chromium caching, and artifact upload</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add a new `e2e` job to `.github/workflows/ci.yml` as a sibling to the existing `test` job. **Do NOT modify the existing `test` job at all** (REQ-30).

The `e2e` job must include these steps in order:

1. **PostgreSQL 17 service container** (REQ-26):
   ```yaml
   services:
     postgres:
       image: postgres:17
       env:
         POSTGRES_USER: postgres
         POSTGRES_PASSWORD: postgres
         POSTGRES_DB: veda_legal_test
       options: >-
         --health-cmd pg_isready
         --health-interval 10s
         --health-timeout 5s
         --health-retries 5
       ports:
         - 5432:5432
   ```

2. **Checkout** — `actions/checkout@v4`

3. **Setup Node.js 22** — `actions/setup-node@v4` with `cache: 'npm'` and `cache-dependency-path: app/package-lock.json` (matches existing test job)

4. **Install dependencies** — `npm ci` in `./app` with `DATABASE_URL` env var set to `postgresql://postgres:postgres@localhost:5432/veda_legal_test`

5. **Provision test database schema** (REQ-28) — `npx drizzle-kit push --force` in `./app`. **CRITICAL:** Use `drizzle-kit push --force`, NOT `drizzle-kit migrate`. The migration chain is broken for fresh databases (migration 0000 is a no-op from Prisma era, migration 0001 drops `_prisma_migrations` which doesn't exist). `push --force` reads the TypeScript schema definition and applies it directly. Set `DATABASE_URL` env var.

6. **Get Playwright version** for cache key:
   ```yaml
   - name: Get Playwright version
     id: playwright-version
     working-directory: ./app
     run: echo "PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/@playwright/test'].version)")" >> $GITHUB_ENV
   ```

7. **Cache Playwright browsers** (REQ-27) — `actions/cache@v4`:
   ```yaml
   - name: Cache Playwright browsers
     uses: actions/cache@v4
     id: playwright-cache
     with:
       path: ~/.cache/ms-playwright
       key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
   ```

8. **Install Playwright browsers** — conditional on cache miss:
   ```yaml
   - name: Install Playwright browsers
     if: steps.playwright-cache.outputs.cache-hit != 'true'
     working-directory: ./app
     run: npx playwright install --with-deps chromium
   ```

9. **Install Playwright OS dependencies** — conditional on cache hit (browser binary cached but OS deps are NOT cached):
   ```yaml
   - name: Install Playwright OS dependencies
     if: steps.playwright-cache.outputs.cache-hit == 'true'
     working-directory: ./app
     run: npx playwright install-deps chromium
   ```

10. **Build Next.js app** — `npm run build` in `./app` with `DATABASE_URL` env var. This must come BEFORE `npx playwright test` because the Playwright config uses `npm run start` (not `npm run dev`) in CI.

11. **Run Playwright tests** — `npx playwright test` in `./app` with these env vars:
    - `CI: 'true'`
    - `TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/veda_legal_test`
    - `NEXTAUTH_SECRET: test-secret-for-e2e-minimum-32-characters!!`
    - `NEXTAUTH_URL: http://localhost:3001`
    - `DATABASE_URL: postgresql://postgres:postgres@localhost:5432/veda_legal_test`

12. **Upload Playwright report** (REQ-29) — `actions/upload-artifact@v4` with `if: failure()`:
    ```yaml
    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: app/playwright-report/
        retention-days: 30
    ```

Set `timeout-minutes: 15` on the job (generous buffer for build + tests).
Set `runs-on: ubuntu-latest`.
No `needs:` dependency on the `test` job — both jobs run independently (REQ-30).

**Structure:** The existing `test:` job YAML must be completely unchanged. The new `e2e:` job is added as a peer in the `jobs:` block.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets && node -e "const y = require('fs').readFileSync('.github/workflows/ci.yml','utf8'); const checks = [y.includes('e2e:'), y.includes('postgres:17'), y.includes('actions/cache@v4'), y.includes('drizzle-kit push'), y.includes('upload-artifact@v4'), y.includes('if: failure()'), y.includes('playwright-cache'), !y.includes('needs:')]; console.log(checks.every(Boolean) ? 'PASS' : 'FAIL: ' + checks.join(','))"</automated>
    <manual>Review ci.yml — verify e2e job has all 12 steps, existing test job is untouched, no `needs:` dependency between jobs</manual>
  </verify>
  <done>ci.yml has a new `e2e` job with: PostgreSQL 17 service container with health check (REQ-26), Chromium caching via actions/cache@v4 (REQ-27), schema provisioning via drizzle-kit push --force (REQ-28), artifact upload on failure (REQ-29). The existing `test` job is completely unchanged (REQ-30). Both jobs run independently on PRs to main (REQ-25).</done>
</task>

</tasks>

<verification>
1. **Playwright config:** `playwright.config.ts` uses `process.env.CI` ternary for webServer command
2. **CI workflow:** `ci.yml` has both `test` and `e2e` jobs as independent siblings
3. **PostgreSQL:** Service container uses `postgres:17` image with health check and `veda_legal_test` database
4. **Chromium caching:** `actions/cache@v4` with Playwright version-based key, conditional install/deps steps
5. **Schema provisioning:** Uses `drizzle-kit push --force` (NOT migrate) to handle broken migration chain
6. **Artifact upload:** `actions/upload-artifact@v4` with `if: failure()` condition
7. **Existing job untouched:** `test` job YAML is byte-identical to before changes
8. **Local development unaffected:** Running `npm run test:e2e` locally still uses dev server
</verification>

<success_criteria>
- The `e2e` job in ci.yml is syntactically valid YAML
- All 6 requirements (REQ-25 through REQ-30) are addressed
- The existing `test` job is unchanged
- The Playwright config uses production build in CI, dev server locally
- No new npm packages need to be installed (all actions and tools already available)
</success_criteria>

<output>
After completion, create `.planning/phases/07-ci-integration/07-01-SUMMARY.md`
</output>
