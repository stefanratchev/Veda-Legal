---
phase: 03-client-drill-down-enhancements
plan: 00
type: execute
wave: 0
depends_on: []
files_modified:
  - app/src/components/reports/ByClientTab.test.tsx
autonomous: true
requirements:
  - CDR-01
  - CDR-03
  - CDR-04

must_haves:
  truths:
    - "ByClientTab.test.tsx exists with failing test stubs covering CDR-01, CDR-03, CDR-04"
    - "Test stubs describe the expected behaviors before implementation begins"
  artifacts:
    - path: "app/src/components/reports/ByClientTab.test.tsx"
      provides: "Failing test stubs for topic chart, pagination, topic column, sort"
      contains: "Topic Breakdown"
  key_links:
    - from: "app/src/components/reports/ByClientTab.test.tsx"
      to: "app/src/components/reports/ByClientTab.tsx"
      via: "import and render of ByClientTab component"
      pattern: "import.*ByClientTab"
---

<objective>
Create failing test scaffold for ByClientTab drill-down enhancements before implementation begins.

Purpose: Nyquist compliance -- CDR-01, CDR-03, CDR-04 have no automated verification. Tests must exist before implementation so that `npm run test -- --run ByClientTab` can serve as the sampling command (~5s latency) for all subsequent plans.
Output: `ByClientTab.test.tsx` with stub tests that will fail (RED) until plans 03-01 and 03-02 implement the features.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-drill-down-enhancements/03-CONTEXT.md
@.planning/phases/03-client-drill-down-enhancements/03-RESEARCH.md
@app/src/components/reports/ByClientTab.tsx
@app/src/components/reports/charts/RevenueBarChart.test.tsx
@app/src/components/ui/table-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ByClientTab.test.tsx with failing test stubs</name>
  <files>
    app/src/components/reports/ByClientTab.test.tsx
  </files>
  <action>
Create `app/src/components/reports/ByClientTab.test.tsx` with test stubs that exercise the behaviors planned in 03-01 and 03-02. These tests will FAIL initially (RED state) and turn GREEN as implementation proceeds.

**Setup:**
- Import `describe, it, expect, vi` from `vitest` and `render, screen` from `@testing-library/react`
- Import `ByClientTab` from `./ByClientTab`
- Mock `ResizeObserver` globally (needed for Recharts `ResponsiveContainer`):
  ```typescript
  class ResizeObserverMock {
    observe() {}
    unobserve() {}
    disconnect() {}
  }
  global.ResizeObserver = ResizeObserverMock;
  ```

**Test data factory — create helpers at top of file:**

```typescript
function createClient(overrides?: Partial<{ id: string; name: string; totalHours: number; revenue: number | null; employees: { id: string; name: string; hours: number }[]; topics: { topicName: string; totalHours: number; writtenOffHours: number }[] }>): ClientStats {
  return {
    id: "c1",
    name: "Acme Corp",
    totalHours: 20,
    revenue: 5000,
    employees: [{ id: "e1", name: "John Smith", hours: 20 }],
    topics: [
      { topicName: "M&A Advisory", totalHours: 12, writtenOffHours: 0 },
      { topicName: "Company Law", totalHours: 8, writtenOffHours: 0 },
    ],
    ...overrides,
  };
}

function createEntry(overrides?: Partial<Entry>): Entry {
  return {
    id: "entry-1",
    date: "2026-02-20",
    hours: 2,
    description: "Drafted agreement",
    topicName: "M&A Advisory",
    client: { id: "c1", name: "Acme Corp" },
    employee: { id: "e1", name: "John Smith" },
    ...overrides,
  };
}
```

Note: The `ClientStats` and `Entry` interfaces are local to `ByClientTab.tsx` and not exported. Define matching interfaces locally in the test file (or use inline object types). The test factories must match the shapes the component expects AFTER 03-01 adds `topicName` to Entry and `topics` to ClientStats.

**Test stubs (all should be `it(...)` with real assertions — NOT `it.skip` or `it.todo`):**

1. **CDR-01: Topic breakdown chart renders** (describe block: "topic breakdown chart")
   - `it("renders Topic Breakdown heading when client with topics is selected")` — render with `selectedClientId` matching a client that has topics. Assert `screen.getByText("Topic Breakdown")` is in the document.
   - `it("hides zero-hour topics from chart data")` — create a client with one topic at 0 hours and one at 10 hours. Render with that client selected. Assert the zero-hour topic name does NOT appear in the rendered output (`screen.queryByText("Zero Topic")` returns null). NOTE: Recharts may not render bar labels as findable text in JSDOM. If the topic name is only in the SVG, assert via `container.textContent` not containing the zero topic name.
   - `it("shows hours and percentage in topic bar labels")` — create a client with one topic of 12h out of 20h total. Render. Look for text matching the pattern `12h` or `60%` in the rendered output (use `container.textContent` to search since Recharts labels may not be discrete DOM elements findable by `getByText`).

2. **CDR-03: Full entry table with pagination** (describe block: "entry table")
   - `it("renders all entries via DataTable, not limited to 10")` — create 15 entries, render with client selected. Assert all 15 entry descriptions or dates are present in the document (they fit in one page of 50). Verify NO `.slice(0, 10)` behavior by checking that entry #11's description appears.
   - `it("shows pagination when entries exceed page size")` — this test should pass once DataTable is used with pageSize. Create 60 entries (exceeding 50 page size). Render. Assert `screen.getByText(/Page 1 of/)` is in the document (DataTable's pagination text pattern).

3. **CDR-04: Topic column in entry table** (describe block: "entry table columns")
   - `it("renders Topic column header")` — render with a client selected and entries. Assert `screen.getByText("Topic")` is in the document as a column header. Use `screen.getAllByText("Topic")` if "Topic Breakdown" heading also matches, and verify at least one is a table column header.
   - `it("shows topicName in entry rows")` — render with an entry that has topicName "M&A Advisory". Assert that "M&A Advisory" appears in the entry row area (not just the chart).

4. **CDR-03: Default sort** (describe block: "default sort")
   - `it("sorts entries by date descending by default")` — create entries with dates "2026-02-18", "2026-02-20", "2026-02-15". Render. Find all date cells and verify the first rendered date is "2026-02-20" (newest). Use `screen.getAllByText(/Feb|20 Feb/)` or inspect table row order via `container.querySelectorAll('td')`.

All default props: `isAdmin={true}`, `onSelectClient={vi.fn()}`, `selectedClientId="c1"` (matching the client factory).

**IMPORTANT:** These tests WILL FAIL right now because the component doesn't have `topics` on `ClientStats`, `topicName` on `Entry`, or `DataTable` integration. That's intentional — they turn green as 03-01 and 03-02 are implemented.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run ByClientTab 2>&1 | tail -20</automated>
    <manual>Confirm tests exist and FAIL (RED state). Expect TypeScript or assertion failures because the component hasn't been updated yet. The key verification is that the test file runs without syntax errors and produces meaningful failure messages.</manual>
    <sampling_rate>run once after this task commits</sampling_rate>
  </verify>
  <done>ByClientTab.test.tsx exists with 8+ test stubs covering CDR-01 (topic chart renders, zero topics hidden, percentage labels), CDR-03 (all entries rendered, pagination, default sort), CDR-04 (Topic column header, topicName in rows). Tests fail because the component hasn't been updated yet.</done>
</task>

</tasks>

<verification>
1. Test file exists: `ls app/src/components/reports/ByClientTab.test.tsx`
2. Tests run without syntax errors: `cd app && npm run test -- --run ByClientTab` (failures expected, but no parse errors)
3. Test count: at least 8 test stubs present
</verification>

<success_criteria>
- ByClientTab.test.tsx exists and is parseable
- Test stubs cover all three non-dropped requirements: CDR-01, CDR-03, CDR-04
- Tests produce FAIL results (RED state) — they describe behavior not yet implemented
- `npm run test -- --run ByClientTab` runs in ~5 seconds and can serve as the Nyquist sampling command
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-drill-down-enhancements/03-00-SUMMARY.md`
</output>
