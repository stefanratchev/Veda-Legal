---
phase: 05-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/package.json
  - app/.env.test
  - app/.gitignore
  - app/playwright.config.ts
  - app/e2e/fixtures/auth.ts
  - app/e2e/setup/auth.setup.ts
  - app/e2e/helpers/seed-data.ts
  - app/e2e/helpers/global-setup.ts
  - app/e2e/fixtures/db.ts
  - app/e2e/fixtures/test.ts
autonomous: true
requirements:
  - REQ-01
  - REQ-02
  - REQ-03
  - REQ-04
  - REQ-05
  - REQ-07
  - REQ-08
  - REQ-09

must_haves:
  truths:
    - "Running `npm run test:e2e` from app/ launches Playwright and attempts to start a webServer on port 3001"
    - "The auth setup project generates a storageState JSON file with a valid NextAuth JWT cookie"
    - "Global setup seeds 1 user, 2 clients, 2 topics, and 3 subtopics into veda_legal_test"
    - "The DB fixture truncates mutable tables before each test"
    - "Playwright artifacts (e2e/.auth/, test-results/, playwright-report/) are gitignored"
  artifacts:
    - path: "app/playwright.config.ts"
      provides: "Playwright configuration with setup project, Chromium-only, serial, port 3001"
      contains: "defineConfig"
    - path: "app/e2e/fixtures/auth.ts"
      provides: "JWT encode helper using next-auth/jwt"
      exports: ["createSessionToken"]
    - path: "app/e2e/setup/auth.setup.ts"
      provides: "Setup project that writes storageState JSON with JWT cookie"
      contains: "next-auth.session-token"
    - path: "app/e2e/helpers/seed-data.ts"
      provides: "Deterministic test data constants"
      exports: ["TEST_USER", "CLIENTS", "TOPICS", "SUBTOPICS"]
    - path: "app/e2e/helpers/global-setup.ts"
      provides: "Database seeding function for reference data"
      contains: "INSERT INTO"
    - path: "app/e2e/fixtures/db.ts"
      provides: "DB fixture with TRUNCATE CASCADE cleanup"
      contains: "TRUNCATE"
    - path: "app/e2e/fixtures/test.ts"
      provides: "Composed test export combining db fixture + re-exported expect"
      exports: ["test", "expect"]
    - path: "app/.env.test"
      provides: "Test environment variables"
      contains: "TEST_DATABASE_URL"
    - path: "app/package.json"
      provides: "test:e2e and test:e2e:ui npm scripts"
      contains: "test:e2e"
  key_links:
    - from: "app/playwright.config.ts"
      to: "app/e2e/setup/auth.setup.ts"
      via: "setup project dependency"
      pattern: "name.*setup"
    - from: "app/playwright.config.ts"
      to: "app/e2e/helpers/global-setup.ts"
      via: "globalSetup config"
      pattern: "globalSetup"
    - from: "app/playwright.config.ts"
      to: "app/.env.test"
      via: "dotenv.config loading"
      pattern: "dotenv.*\\.env\\.test"
    - from: "app/e2e/setup/auth.setup.ts"
      to: "app/e2e/fixtures/auth.ts"
      via: "import createSessionToken"
      pattern: "createSessionToken"
    - from: "app/e2e/fixtures/test.ts"
      to: "app/e2e/fixtures/db.ts"
      via: "re-export of db fixture test"
      pattern: "import.*db"
---

<objective>
Set up the complete Playwright e2e test infrastructure: install Playwright, configure it with auth bypass via JWT cookie injection, create test database seed data and cleanup fixtures, and wire everything together with proper environment configuration.

Purpose: Provide the foundation that Phase 5's smoke test (Plan 02) and Phase 6's workflow tests will build on. Every piece of infrastructure must work before any spec files can be written.
Output: Playwright config, auth setup project, seed data, DB fixtures, composed test export, .env.test, npm scripts, .gitignore updates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-infrastructure/GOAL.md
@.planning/phases/05-test-infrastructure/05-CONTEXT.md
@.planning/phases/05-test-infrastructure/05-RESEARCH.md
@app/package.json
@app/.gitignore
@app/src/lib/schema.ts
@app/src/lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create config scaffolding</name>
  <files>
    app/package.json
    app/.env.test
    app/.gitignore
  </files>
  <action>
1. Install Playwright as a devDependency:
   ```bash
   cd app && npm install --save-dev @playwright/test
   ```
   Then install the Chromium browser binary:
   ```bash
   cd app && npx playwright install chromium
   ```

2. Add npm scripts to `package.json`:
   ```json
   "test:e2e": "npx playwright test",
   "test:e2e:ui": "npx playwright test --ui"
   ```

3. Create `app/.env.test`:
   ```
   # Test database — MUST be separate from development database
   TEST_DATABASE_URL=postgresql://localhost:5432/veda_legal_test

   # NextAuth config for test environment
   NEXTAUTH_SECRET=test-secret-for-e2e-minimum-32-characters!!
   NEXTAUTH_URL=http://localhost:3001
   ```
   **Note:** `.env.test` should NOT be gitignored — it contains no real secrets (test-only values) and must be committed so other developers and CI can use it.

4. Append Playwright artifact paths to `app/.gitignore`:
   ```
   # Playwright
   /e2e/.auth/
   /test-results/
   /playwright-report/
   ```
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && node -e "const p=require('./package.json'); if(!p.devDependencies['@playwright/test']) throw 'missing playwright'; if(!p.scripts['test:e2e']) throw 'missing script'; console.log('OK')" && test -f .env.test && grep -q 'e2e/.auth' .gitignore && echo "All checks pass"</automated>
  </verify>
  <done>
    - `@playwright/test` is in devDependencies
    - `test:e2e` and `test:e2e:ui` scripts exist in package.json
    - `.env.test` exists with TEST_DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL
    - `.gitignore` includes Playwright artifact paths
    - Chromium browser binary is installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth bypass via JWT cookie injection</name>
  <files>
    app/playwright.config.ts
    app/e2e/fixtures/auth.ts
    app/e2e/setup/auth.setup.ts
  </files>
  <action>
1. Create `app/e2e/fixtures/auth.ts` — JWT encode helper:
   ```typescript
   import { encode } from "next-auth/jwt";

   export async function createSessionToken(
     email: string,
     name: string,
     secret: string
   ): Promise<string> {
     return encode({
       token: {
         email,
         name,
         sub: email,
       },
       secret,
       // salt defaults to "" — matches getToken() decode behavior in middleware
       // maxAge defaults to 30 days — fine for test sessions
     });
   }
   ```

2. Create `app/e2e/setup/auth.setup.ts` — Setup project that writes storageState:
   ```typescript
   import { test as setup } from "@playwright/test";
   import fs from "fs";
   import path from "path";
   import { createSessionToken } from "../fixtures/auth";
   import { TEST_USER } from "../helpers/seed-data";

   const authFile = path.join(__dirname, "../.auth/user.json");

   setup("generate auth state", async () => {
     const secret = process.env.NEXTAUTH_SECRET!;
     const token = await createSessionToken(
       TEST_USER.email,
       TEST_USER.name,
       secret
     );

     const storageState = {
       cookies: [
         {
           name: "next-auth.session-token",
           value: token,
           domain: "localhost",
           path: "/",
           expires: -1,
           httpOnly: true,
           secure: false,
           sameSite: "Lax" as const,
         },
       ],
       origins: [],
     };

     fs.mkdirSync(path.dirname(authFile), { recursive: true });
     fs.writeFileSync(authFile, JSON.stringify(storageState, null, 2));
   });
   ```

3. Create `app/playwright.config.ts`:
   ```typescript
   import { defineConfig, devices } from "@playwright/test";
   import dotenv from "dotenv";
   import path from "path";

   dotenv.config({ path: path.resolve(__dirname, ".env.test") });

   export default defineConfig({
     testDir: "./e2e/specs",
     fullyParallel: false,
     forbidOnly: !!process.env.CI,
     retries: process.env.CI ? 1 : 0,
     workers: 1,
     reporter: process.env.CI ? "html" : "list",
     globalSetup: require.resolve("./e2e/helpers/global-setup"),

     use: {
       baseURL: "http://localhost:3001",
       trace: "on-first-retry",
       screenshot: "only-on-failure",
     },

     projects: [
       {
         name: "setup",
         testDir: "./e2e/setup",
         testMatch: /.*\.setup\.ts/,
       },
       {
         name: "chromium",
         use: {
           ...devices["Desktop Chrome"],
           storageState: path.join(__dirname, "e2e/.auth/user.json"),
         },
         dependencies: ["setup"],
       },
     ],

     webServer: {
       command: "npm run dev -- --port 3001",
       url: "http://localhost:3001",
       reuseExistingServer: !process.env.CI,
       timeout: 120_000,
       env: {
         DATABASE_URL: process.env.TEST_DATABASE_URL!,
         NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET!,
         NEXTAUTH_URL: "http://localhost:3001",
       },
     },
   });
   ```

**Critical details (from research):**
- Cookie name MUST be `next-auth.session-token` (no `__Secure-` prefix for http://localhost)
- Do NOT pass `salt` parameter to `encode()` — the default `""` matches middleware's decode behavior
- `secure: false` on the cookie because NEXTAUTH_URL is http, not https
- `webServer.env.DATABASE_URL` points at TEST_DATABASE_URL so the Next.js server uses the test database
- Port 3001 per user decision to avoid conflicts with dev server on 3000
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && test -f playwright.config.ts && test -f e2e/fixtures/auth.ts && test -f e2e/setup/auth.setup.ts && node -e "require('next-auth/jwt')" && echo "All auth files exist and next-auth/jwt is importable"</automated>
  </verify>
  <done>
    - `playwright.config.ts` exists with setup project, Chromium-only, serial, port 3001, globalSetup, webServer config
    - `e2e/fixtures/auth.ts` exports `createSessionToken` using `next-auth/jwt` encode
    - `e2e/setup/auth.setup.ts` generates storageState JSON with JWT cookie named `next-auth.session-token`
    - No production auth code is modified
  </done>
</task>

<task type="auto">
  <name>Task 3: Create seed data, global setup, DB fixture, and composed test export</name>
  <files>
    app/e2e/helpers/seed-data.ts
    app/e2e/helpers/global-setup.ts
    app/e2e/fixtures/db.ts
    app/e2e/fixtures/test.ts
  </files>
  <action>
1. Create `app/e2e/helpers/seed-data.ts` — Deterministic test data constants:
   - Use `createId()` from `@paralleldrive/cuid2` for IDs (same format as production)
   - TEST_USER: email `test@vedalegal.bg`, name `Elena Petrova`, position ADMIN, status ACTIVE
   - CLIENTS: `Balkanova Industries` (REGULAR, ACTIVE), `Veda Legal (Internal)` (INTERNAL, ACTIVE)
   - TOPICS: `Corporate Advisory` (REGULAR, ACTIVE, displayOrder 1), `Firm Administration` (INTERNAL, ACTIVE, displayOrder 2)
   - SUBTOPICS (all under Corporate Advisory):
     - `Client correspondence:` (isPrefix: true, displayOrder 1)
     - `Drafting shareholder agreement` (isPrefix: false, displayOrder 2)
     - `Legal research:` (isPrefix: true, displayOrder 3)
   - Names are obviously-fake but realistic per user decision

2. Create `app/e2e/helpers/global-setup.ts` — Database seeding:
   - Creates a `pg.Pool` with `process.env.TEST_DATABASE_URL`
   - Loads `.env.test` with dotenv (same path resolution as playwright.config.ts)
   - Uses UPSERT (INSERT ... ON CONFLICT DO UPDATE) for all reference data
   - **CRITICAL:** Check `app/src/lib/schema.ts` and the Drizzle migration files to determine the actual PostgreSQL column names. The schema uses camelCase in TypeScript but the actual SQL columns may be quoted camelCase (`"clientType"`) or snake_case (`client_type`). Read the first migration file (`drizzle/0000_pretty_thing.sql`) to confirm. Use the actual column names in all INSERT statements.
   - Seed order: users -> clients -> topics -> subtopics (FK dependencies)
   - Pool is closed in a `finally` block

3. Create `app/e2e/fixtures/db.ts` — DB fixture with TRUNCATE cleanup:
   - Creates a module-level `pg.Pool` singleton with `process.env.TEST_DATABASE_URL` (max 2 connections)
   - Extends `base` test from `@playwright/test`
   - In the fixture setup (before `use()`): runs `TRUNCATE service_description_line_items, service_description_topics, service_descriptions, time_entries, timesheet_submissions CASCADE`
   - This handles stale state from previous test failures (beforeEach pattern)
   - Exports `test` with the `db: Pool` fixture

4. Create `app/e2e/fixtures/test.ts` — Composed test export:
   - Imports `test` from `./db`
   - Re-exports `test` and `expect` from `@playwright/test`
   - Auth is handled at project config level via storageState, not as a runtime fixture
   - All spec files will import `{ test, expect }` from this file

**Anti-patterns to avoid:**
- Do NOT import from `@/lib/db` — the production Drizzle instance uses DATABASE_URL (dev database)
- Do NOT use random data — all seed values must be deterministic constants
- Do NOT add cleanup in `afterEach` — the `beforeEach` TRUNCATE pattern handles all cases
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && test -f e2e/helpers/seed-data.ts && test -f e2e/helpers/global-setup.ts && test -f e2e/fixtures/db.ts && test -f e2e/fixtures/test.ts && node -e "console.log('All fixture files exist')"</automated>
  </verify>
  <done>
    - `e2e/helpers/seed-data.ts` exports TEST_USER, CLIENTS, TOPICS, SUBTOPICS with deterministic realistic-looking data
    - `e2e/helpers/global-setup.ts` seeds reference data into veda_legal_test using UPSERT with correct column names
    - `e2e/fixtures/db.ts` exports a Playwright fixture that TRUNCATEs mutable tables before each test
    - `e2e/fixtures/test.ts` exports composed `test` (with db fixture) and `expect`
    - No production code is modified
  </done>
</task>

</tasks>

<verification>
After all 3 tasks are complete:
1. `cd app && npm run test:e2e -- --list` should list available test projects (setup, chromium) without errors
2. All e2e infrastructure files exist in the correct directory structure
3. `.env.test` is committed (not gitignored)
4. Playwright artifact directories ARE gitignored
5. No production source files were modified
</verification>

<success_criteria>
- `@playwright/test` installed as devDependency with Chromium binary
- `playwright.config.ts` configures setup project, Chromium-only, serial execution, port 3001, HTML reporter, globalSetup
- Auth bypass generates valid NextAuth JWT via `encode()` with correct cookie name and no salt
- Seed data provides 1 ADMIN user, 2 clients (REGULAR + INTERNAL), 2 topics, 3 subtopics
- DB fixture truncates mutable tables before each test via TRUNCATE CASCADE
- Composed test export provides `{ test, expect }` for all spec files
- `.env.test` committed with TEST_DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL
- npm scripts `test:e2e` and `test:e2e:ui` added to package.json
- Playwright artifacts gitignored
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure/05-01-SUMMARY.md`
</output>
