---
phase: 09-filter-component
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/src/components/ui/MultiSelectFilter.tsx
  - app/src/components/ui/MultiSelectFilter.test.tsx
autonomous: true
requirements:
  - FILT-01
  - FILT-02
  - FILT-03
  - FILT-05

must_haves:
  truths:
    - "User can open a searchable dropdown by clicking a trigger button"
    - "User can type to narrow options via case-insensitive substring matching"
    - "User can select multiple items via checkboxes (dropdown stays open)"
    - "User can deselect items by clicking the checkbox again"
    - "User sees a count badge on the trigger when items are selected"
    - "User sees an accent border on the trigger when filters are active"
    - "User can navigate with Arrow keys and toggle with Space"
    - "User can close the dropdown with Escape or click-outside"
  artifacts:
    - path: "app/src/components/ui/MultiSelectFilter.tsx"
      provides: "Generic reusable multi-select filter component"
      exports: ["MultiSelectFilter"]
      min_lines: 80
    - path: "app/src/components/ui/MultiSelectFilter.test.tsx"
      provides: "Comprehensive tests for MultiSelectFilter"
      min_lines: 100
  key_links:
    - from: "app/src/components/ui/MultiSelectFilter.tsx"
      to: "@/hooks/useClickOutside"
      via: "import and invocation"
      pattern: "useClickOutside"
    - from: "app/src/components/ui/MultiSelectFilter.tsx"
      to: "parent component"
      via: "controlled props: selected Set<string>, onChange callback"
      pattern: "onChange.*new Set"
---

<objective>
Build and test the MultiSelectFilter component using TDD. This generic component is the core building block for Phase 9 -- it handles searchable dropdown, checkbox selection, keyboard navigation, and active filter indicators. One component definition serves all three filter dimensions (Clients, Employees, Topics) via props.

Purpose: FILT-01/02/03 require identical multi-select dropdown behavior for three dimensions. FILT-05 requires count badges and accent borders. Building one generic component satisfies all four requirements.

Output: Fully tested `MultiSelectFilter` component in `components/ui/`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-filter-component/09-CONTEXT.md
@.planning/phases/09-filter-component/09-RESEARCH.md
@app/src/components/ui/ClientSelect.tsx
@app/src/components/ui/ClientSelect.test.tsx
@app/src/hooks/useClickOutside.ts
@app/src/app/globals.css
@.agents/skills/vercel-react-best-practices/rules/rendering-conditional-render.md
@.agents/skills/vercel-react-best-practices/rules/rerender-functional-setstate.md
</context>

<feature>
  <name>MultiSelectFilter Component</name>
  <files>app/src/components/ui/MultiSelectFilter.tsx, app/src/components/ui/MultiSelectFilter.test.tsx</files>
  <behavior>
    MultiSelectFilter is a controlled component that renders a trigger button opening a searchable dropdown with checkbox options.

    Props interface:
    ```typescript
    interface MultiSelectFilterProps {
      options: { id: string; label: string }[];
      selected: Set&lt;string&gt;;
      onChange: (selected: Set&lt;string&gt;) => void;
      label: string;
      placeholder?: string; // defaults to "Search {label}..."
    }
    ```

    **Trigger button behavior:**
    - Shows `label` text (e.g., "Clients")
    - When `selected.size > 0`: shows coral pink count badge (e.g., "3"), adds accent border (`border-[var(--border-accent)]`)
    - When `selected.size === 0`: shows subtle border (`border-[var(--border-subtle)]`), no badge
    - Chevron icon rotates 180deg when open
    - Click toggles dropdown open/closed

    **Dropdown panel behavior:**
    - Opens below trigger with `animate-fade-up` animation
    - Search input at top, auto-focused on open
    - Case-insensitive substring matching filters options
    - Options rendered with checkboxes (coral pink when checked, muted border when unchecked)
    - Option items use `onMouseDown` with `e.preventDefault()` to prevent focus loss from search input
    - Max height ~280px (`max-h-70`) with overflow scroll
    - "No results" message when search yields nothing
    - Stays open after toggling a selection (multi-select behavior)
    - Closes on click-outside (via `useClickOutside` hook) and Escape key
    - Search text and highlighted index reset on close

    **Keyboard navigation:**
    - ArrowDown: move highlight down (stop at end)
    - ArrowUp: move highlight up (stop at start)
    - Space: toggle checkbox on highlighted option (with e.preventDefault() to prevent scroll)
    - Escape: close dropdown, reset search

    **Selection toggle logic:**
    - On toggle: create `new Set(selected)`, add or delete the id, call `onChange(newSet)`
    - Never mutate the passed Set -- always create a new instance

    Test cases (RED phase):
    - Renders trigger button with label text
    - Renders custom placeholder in search input when provided
    - Opens dropdown on trigger click, showing search input and all options
    - Closes dropdown on second trigger click
    - Filters options case-insensitively as user types in search
    - Shows "No results" when search matches nothing
    - Toggles checkbox on option click, calls onChange with new Set containing the id
    - Deselects on second click, calls onChange with new Set without the id
    - Dropdown stays open after selecting/deselecting an option
    - Shows count badge with selected count when items are selected
    - Does not show count badge when nothing is selected
    - Trigger has accent border when selections active, subtle border when inactive
    - ArrowDown navigates highlight forward
    - ArrowUp navigates highlight backward
    - Space toggles the highlighted option's checkbox
    - Escape closes the dropdown and resets search
    - Highlighted index resets to 0 when search text changes
    - Highlighted item scrolls into view
    - Search input is focused when dropdown opens
  </behavior>
  <implementation>
    Model directly on the existing `ClientSelect` component structure. Key differences from ClientSelect:

    1. **Multi-select instead of single-select:** Dropdown stays open after toggle. No `handleSelect` that closes -- instead `handleToggle` that creates a new Set.
    2. **Checkboxes instead of highlight-based selection:** Each option has a checkbox indicator (coral pink filled when checked, muted border when unchecked).
    3. **Count badge on trigger:** Use ternary `selected.size > 0 ? <badge/> : null` per `rendering-conditional-render` skill rule. Never use `&&` with numeric values.
    4. **Space key for toggle (not Enter for select):** Keyboard handler uses Space to toggle checkbox, ArrowDown/ArrowUp for navigation, Escape to close. Enter is not used (user clicks away when done).
    5. **onMouseDown with preventDefault on options:** Prevents search input from losing focus when clicking option buttons. This is the clean approach per RESEARCH.md pitfall 3.
    6. **Trigger styling:** Compact button with `px-3 py-2` (not full-width like ClientSelect). Uses `flex items-center gap-2`. Conditional border color based on whether selections are active.

    Follow these codebase conventions:
    - `"use client"` directive at top
    - Import `useClickOutside` from `@/hooks/useClickOutside`
    - Use `useMemo` for filtered options (never store in state)
    - Use `useEffect` for: focus on open, reset highlight on search change, scroll into view
    - CSS variables from design system: `--bg-surface`, `--bg-elevated`, `--border-subtle`, `--border-accent`, `--text-primary`, `--text-secondary`, `--text-muted`, `--accent-pink`, `--bg-deep`
    - `animate-fade-up` for dropdown entrance animation
    - `data-testid="multi-select-filter"` on the root div for testability

    Mock setup for tests (mirror ClientSelect.test.tsx):
    - `vi.mock("@/hooks/useClickOutside", () => ({ useClickOutside: vi.fn() }))`
    - `Element.prototype.scrollIntoView = vi.fn()`
    - Use `fireEvent` (not userEvent -- not installed)
    - Test groups: Rendering, Dropdown Behavior, Filtering, Selection, Active Indicators, Keyboard Navigation
  </implementation>
</feature>

<verification>
```bash
cd app && npm run test -- MultiSelectFilter --run
```
All tests pass. No regressions in existing tests:
```bash
cd app && npm run test -- --run
```
</verification>

<success_criteria>
- MultiSelectFilter component renders a trigger button that opens a searchable dropdown with checkbox options
- Selecting/deselecting options calls onChange with a new Set (never mutates)
- Dropdown stays open after selection (multi-select UX)
- Count badge appears on trigger when items selected (coral pink bg)
- Accent border appears on trigger when filters active
- Keyboard navigation works: ArrowDown, ArrowUp, Space toggle, Escape close
- Search is case-insensitive substring match with "No results" empty state
- Click-outside closes dropdown via useClickOutside hook
- All tests pass including existing suite (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/09-filter-component/09-01-SUMMARY.md`
</output>
