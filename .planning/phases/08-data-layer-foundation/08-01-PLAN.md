---
phase: 08-data-layer-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/src/types/reports.ts
  - app/src/lib/report-utils.ts
  - app/src/app/api/reports/route.test.ts
autonomous: true
requirements: [SC-1, SC-2, SC-4]

must_haves:
  truths:
    - "ReportEntry type includes subtopicName (string) and revenue (number | null) fields"
    - "Query fetches subtopicName from timeEntries table alongside existing columns"
    - "Per-entry revenue is computed as hourlyRate * hours for REGULAR, non-written-off entries with rate > 0"
    - "Per-entry revenue is null for non-admin users regardless of entry type"
    - "Per-entry revenue is null for INTERNAL/MANAGEMENT entries, written-off entries, and entries with no rate"
    - "All existing report tests still pass with zero regressions"
  artifacts:
    - path: "app/src/types/reports.ts"
      provides: "Extended ReportEntry with subtopicName and revenue"
      contains: "subtopicName: string"
    - path: "app/src/lib/report-utils.ts"
      provides: "Updated query and per-entry revenue computation"
      contains: "subtopicName"
    - path: "app/src/app/api/reports/route.test.ts"
      provides: "Tests for subtopicName and revenue fields"
      contains: "subtopicName"
  key_links:
    - from: "app/src/lib/report-utils.ts"
      to: "app/src/types/reports.ts"
      via: "ReportEntry type import"
      pattern: "import.*ReportEntry.*reports"
---

<objective>
Extend the ReportEntry type with subtopicName and revenue fields, update the report-utils query to populate them, and add tests verifying per-entry revenue computation with admin gating.

Purpose: The Detail tab (Phases 10-11) needs subtopic names for the entry table and per-entry revenue for revenue charts. This plan extends the data layer to provide those fields.
Output: Updated types/reports.ts, updated lib/report-utils.ts, passing tests in route.test.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-data-layer-foundation/08-CONTEXT.md
@.planning/phases/08-data-layer-foundation/08-RESEARCH.md
@app/src/types/reports.ts
@app/src/lib/report-utils.ts
@app/src/app/api/reports/route.test.ts
</context>

<feature>
  <name>Extended ReportEntry with subtopicName and per-entry revenue</name>
  <files>app/src/types/reports.ts, app/src/lib/report-utils.ts, app/src/app/api/reports/route.test.ts</files>
  <behavior>
    ReportEntry gains two new fields:
    - subtopicName: string (from timeEntries.subtopicName, empty string fallback)
    - revenue: number | null (computed server-side, gated on isAdmin)

    Revenue computation rules:
    - REGULAR client + not written off + hourlyRate > 0 + isAdmin: hours * hourlyRate
    - REGULAR client + not written off + hourlyRate > 0 + NOT admin: null
    - REGULAR client + written off: null (regardless of admin status -- per user decision)
    - INTERNAL/MANAGEMENT client: null (regardless of admin status)
    - REGULAR client + no hourly rate (null or 0): null (per user decision -- "unknown" not "free")

    Cases:
    - Admin + REGULAR entry (rate 150, hours 2.5, not written off) -> revenue: 375
    - Admin + REGULAR entry (rate 150, hours 2.5, written off) -> revenue: null
    - Admin + INTERNAL entry (hours 2.5) -> revenue: null
    - Admin + REGULAR entry (no rate, hours 2.5) -> revenue: null
    - Non-admin + REGULAR entry (rate 150, hours 2.5) -> revenue: null
    - Entry with subtopicName "Client correspondence:" -> subtopicName: "Client correspondence:"
    - Entry with empty subtopicName -> subtopicName: ""
  </behavior>
  <implementation>
    1. RED: Add tests to route.test.ts for subtopicName and revenue fields.
       Add subtopicName to the createMockTimeEntryWithRelations helper.
       Add test cases:
       - Admin sees revenue computed for REGULAR entries
       - Admin sees null revenue for written-off entries
       - Admin sees null revenue for INTERNAL/MANAGEMENT entries
       - Admin sees null revenue for REGULAR entries with no rate
       - Non-admin sees null revenue for all entries
       - subtopicName is populated from entry data
       Run tests -- they must FAIL (ReportEntry doesn't have the new fields yet).

    2. GREEN: Update types/reports.ts to add subtopicName and revenue to ReportEntry interface.
       Update report-utils.ts:
       - Add subtopicName: true to the query columns object (line 40-48 area)
       - In the entries.map() at lines 304-317, add:
         - subtopicName: e.subtopicName || "" (fallback to empty string)
         - revenue: compute per-entry revenue using the same pattern as line 144 but per-entry, gated on isAdmin
       Revenue computation logic (inside entries.map):
         const isBillable = e.client.clientType === "REGULAR";
         const clientRate = e.client.hourlyRate ? Number(e.client.hourlyRate) : 0;
         const entryHours = Number(e.hours);
         const isWrittenOff = e.isWrittenOff ?? false;
         revenue: isAdmin && isBillable && !isWrittenOff && clientRate > 0
           ? entryHours * clientRate
           : (isAdmin ? null : null)  // null for non-admin AND null for non-revenue entries
       Simplify to: isAdmin && isBillable && !isWrittenOff && clientRate > 0 ? Number(e.hours) * clientRate : null
       Note: This returns null for non-admin (correct -- no rate exposure) and null for non-revenue entries when admin (correct -- per user decision).
       Run tests -- they must PASS.

    3. REFACTOR: Review the updated mapping, ensure no duplication with the existing totalRevenue calculation. The existing aggregate-level revenue (lines 143-146) stays untouched -- per-entry revenue is a separate concern.
  </implementation>
</feature>

<verification>
- `cd app && npm run test -- route.test --run` -- all existing + new tests pass
- `cd app && npm run test -- --run` -- full suite passes (zero regressions)
- TypeScript compiles without errors: `cd app && npx tsc --noEmit`
</verification>

<success_criteria>
- ReportEntry interface has subtopicName: string and revenue: number | null
- report-utils.ts query fetches subtopicName column
- Per-entry revenue is computed correctly for all client type / written-off / rate combinations
- Non-admin users see null revenue on all entries
- All existing report tests pass unchanged
- New tests verify all revenue computation cases
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-layer-foundation/08-01-SUMMARY.md`
</output>
