---
phase: 02-overview-revenue-charts
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - app/src/components/reports/ReportsContent.tsx
  - app/src/components/reports/OverviewTab.tsx
autonomous: false
requirements: [REV-01, REV-02]

must_haves:
  truths:
    - "Admin users see Revenue by Client bar chart in overview tab"
    - "Admin users see Revenue by Employee bar chart in overview tab"
    - "Revenue charts are vertical bars with teal color, distinct from horizontal hours bars"
    - "Revenue charts show top 10 by revenue with 'Other' aggregation"
    - "Revenue charts show per-bar % change badges when comparison period is active"
    - "Non-admin users do NOT see revenue charts at all"
    - "Hours charts remain at half width for non-admin users (grid-cols-2 preserved)"
    - "Layout is paired rows: Hours by Client | Revenue by Client, Hours by Employee | Revenue by Employee"
    - "On mobile, paired charts stack vertically (hours above revenue)"
    - "Revenue charts respect selected date range via comparison data threading"
  artifacts:
    - path: "app/src/components/reports/OverviewTab.tsx"
      provides: "Overview tab with revenue chart integration and paired layout"
      contains: "RevenueBarChart"
    - path: "app/src/components/reports/ReportsContent.tsx"
      provides: "Comparison data threading to OverviewTab"
      contains: "byClient"
  key_links:
    - from: "OverviewTab.tsx"
      to: "RevenueBarChart.tsx"
      via: "import and render"
      pattern: "import.*RevenueBarChart.*from.*charts/RevenueBarChart"
    - from: "ReportsContent.tsx"
      to: "OverviewTab.tsx"
      via: "comparison prop with byClient/byEmployee"
      pattern: "comparison=.*byClient|byEmployee"
    - from: "OverviewTab.tsx"
      to: "isAdmin"
      via: "conditional rendering"
      pattern: "isAdmin.*&&.*RevenueBarChart|isAdmin.*revenue"
---

<objective>
Integrate RevenueBarChart into the OverviewTab with the paired-row layout, thread per-item comparison data from ReportsContent, and gate revenue chart rendering behind isAdmin.

Purpose: This is the user-facing integration that makes revenue charts visible to Admin/Partner users in the reports overview tab, completing both REV-01 and REV-02.

Output: Updated `OverviewTab.tsx` and `ReportsContent.tsx`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-overview-revenue-charts/02-CONTEXT.md
@.planning/phases/02-overview-revenue-charts/02-RESEARCH.md
@.planning/phases/02-overview-revenue-charts/02-01-SUMMARY.md
@app/src/components/reports/OverviewTab.tsx
@app/src/components/reports/ReportsContent.tsx
@app/src/components/reports/charts/RevenueBarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread comparison data and integrate revenue charts into OverviewTab</name>
  <files>
    app/src/components/reports/ReportsContent.tsx
    app/src/components/reports/OverviewTab.tsx
  </files>
  <action>
**ReportsContent.tsx changes:**

1. Update the `<OverviewTab>` JSX to pass the full comparison data instead of just the summary. Currently:
   ```tsx
   <OverviewTab
     data={data}
     comparison={comparisonData}
     ...
   />
   ```
   The `comparison` prop already passes the full `comparisonData` (which is `ReportData | null`), so `OverviewTab` already receives `byClient` and `byEmployee` on the comparison object. The change is on the **receiving** side (OverviewTab props type), not on ReportsContent's passing side.

   However, verify that `comparisonData` actually contains `byClient` and `byEmployee` with `revenue` fields. Looking at the `ReportData` interface, `byClient` has `revenue: number | null` and `byEmployee` has `revenue: number | null`. This is already correct -- ReportsContent passes the full `ReportData` as comparison.

   **No changes needed to ReportsContent.tsx** if it already passes the full comparisonData object. But the OverviewTab's `comparison` prop type currently restricts it to only `{ summary: ... }`. The fix is in OverviewTab.

   Actually, reviewing `ReportsContent.tsx` line 323-329: It passes `comparison={comparisonData}` where `comparisonData` is `ReportData | null`. But `OverviewTab`'s prop type only declares `comparison: { summary: {...} } | null`. TypeScript structural typing means the extra fields are silently ignored but available at runtime. However, for type safety and clarity, update the OverviewTab prop type to explicitly include byClient and byEmployee (see OverviewTab changes below). No ReportsContent.tsx code changes needed -- only type alignment in OverviewTab.

**OverviewTab.tsx changes:**

1. **Update the `OverviewTabProps` interface:**
   Expand the `comparison` type to include per-item data:
   ```typescript
   comparison: {
     summary: {
       totalHours: number;
       totalRevenue: number | null;
       activeClients: number;
     };
     byClient: { id: string; name: string; revenue: number | null }[];
     byEmployee: { id: string; name: string; revenue: number | null }[];
   } | null;
   ```
   Also expand `data.byClient` and `data.byEmployee` to include `revenue`:
   ```typescript
   byEmployee: { id: string; name: string; totalHours: number; revenue: number | null }[];
   byClient: { id: string; name: string; totalHours: number; revenue: number | null }[];
   ```

2. **Import the RevenueBarChart component:**
   ```typescript
   import { RevenueBarChart } from "./charts/RevenueBarChart";
   ```

3. **Prepare revenue chart data** using `useMemo`:
   ```typescript
   const clientRevenueData = useMemo(() => {
     if (!isAdmin) return [];
     return byClient
       .filter((c) => c.revenue != null && c.revenue > 0)
       .map((c) => ({ name: c.name, value: c.revenue!, id: c.id }));
   }, [isAdmin, byClient]);

   const employeeRevenueData = useMemo(() => {
     if (!isAdmin) return [];
     return byEmployee
       .filter((e) => e.revenue != null && e.revenue > 0)
       .map((e) => ({ name: e.name, value: e.revenue!, id: e.id }));
   }, [isAdmin, byEmployee]);

   const clientComparisonRevenue = useMemo(() => {
     if (!comparison?.byClient) return undefined;
     return comparison.byClient
       .filter((c) => c.revenue != null && c.revenue > 0)
       .map((c) => ({ name: c.name, value: c.revenue!, id: c.id }));
   }, [comparison?.byClient]);

   const employeeComparisonRevenue = useMemo(() => {
     if (!comparison?.byEmployee) return undefined;
     return comparison.byEmployee
       .filter((e) => e.revenue != null && e.revenue > 0)
       .map((e) => ({ name: e.name, value: e.revenue!, id: e.id }));
   }, [comparison?.byEmployee]);
   ```

4. **Restructure the chart layout** to paired rows.

   **Current layout:**
   ```
   [Hours by Employee (horizontal bar)] | [Hours by Client (donut)]
   ```

   **New admin layout (two rows):**
   ```
   Row 1: [Hours by Client (horizontal bar)] | [Revenue by Client (vertical bar)]
   Row 2: [Hours by Employee (horizontal bar)] | [Revenue by Employee (vertical bar)]
   ```

   **New non-admin layout:**
   ```
   Row 1: [Hours by Client (horizontal bar)]  | (empty cell, keeps half-width)
   Row 2: [Hours by Employee (horizontal bar)] | (empty cell, keeps half-width)
   ```

   Replace the existing single `<div className="grid grid-cols-2 gap-4">` section with:

   ```tsx
   {/* Row 1: Client Charts */}
   <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
       <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
         Hours by Client
       </h3>
       <div className="h-64">
         <BarChart
           data={clientChartData}
           onBarClick={onClientClick}
           valueFormatter={formatHours}
           layout="vertical"
         />
       </div>
     </div>
     {isAdmin && (
       <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
         <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
           Revenue by Client
         </h3>
         <div className="h-64">
           <RevenueBarChart
             data={clientRevenueData}
             comparisonData={clientComparisonRevenue}
             onBarClick={onClientClick}
           />
         </div>
       </div>
     )}
   </div>

   {/* Row 2: Employee Charts */}
   <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
       <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
         Hours by Employee
       </h3>
       <div className="h-64">
         <BarChart
           data={employeeChartData}
           onBarClick={onEmployeeClick}
           valueFormatter={formatHours}
           layout="vertical"
         />
       </div>
     </div>
     {isAdmin && (
       <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
         <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
           Revenue by Employee
         </h3>
         <div className="h-64">
           <RevenueBarChart
             data={employeeRevenueData}
             comparisonData={employeeComparisonRevenue}
             onBarClick={onEmployeeClick}
           />
         </div>
       </div>
     )}
   </div>
   ```

   **Key decisions:**
   - "Hours by Client" switches from DonutChart to horizontal BarChart (matching "Hours by Employee") for consistent paired layout. The DonutChart import can be removed from OverviewTab.
   - Each row is a `grid grid-cols-1 md:grid-cols-2` -- stacks on mobile (hours above revenue), side-by-side on md+.
   - Non-admin: revenue chart div is not rendered. The hours chart still occupies half width on md+ because the grid defines 2 columns regardless. The hours chart will take column 1 and column 2 stays empty -- this maintains "consistent card size across roles" per CONTEXT.md.
   - No extra section headings -- each chart card has its own title label.

5. **Add `useMemo` import** to React import at top of file. Add `{ useMemo }` alongside any existing imports from React.

6. **Remove DonutChart import** since it's no longer used in OverviewTab.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit 2>&1 | grep -E "OverviewTab|ReportsContent|error" | head -20</automated>
    <manual>TypeScript compiles, no type errors in modified files</manual>
  </verify>
  <done>OverviewTab renders revenue charts for admin users in paired rows with hours charts. Non-admin users see hours charts only at half width. Comparison data threaded through for per-bar badges. DonutChart replaced with horizontal BarChart for Hours by Client. TypeScript compiles cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of revenue charts in overview tab</name>
  <action>
Human verifies the revenue charts render correctly in the browser.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run 2>&1 | tail -5</automated>
  </verify>
  <done>User confirms revenue charts look correct and function properly.</done>
  <what-built>Revenue by Client and Revenue by Employee charts integrated into the Reports overview tab, visible only to Admin/Partner users. Layout changed to paired rows (Hours | Revenue per row). Hours by Client switched from donut to horizontal bar chart. Revenue charts show vertical teal bars with EUR formatting, top-10 grouping, and per-bar comparison % change badges.</what-built>
  <how-to-verify>
    1. Start dev server: `cd /Users/stefan/projects/veda-legal-timesheets/app && npm run dev`
    2. Visit http://localhost:3000/reports (logged in as Admin)
    3. Verify the overview tab shows:
       - Row 1: "Hours by Client" (horizontal bar, pink) | "Revenue by Client" (vertical bar, teal)
       - Row 2: "Hours by Employee" (horizontal bar, pink) | "Revenue by Employee" (vertical bar, teal)
    4. Verify revenue charts:
       - Y-axis shows EUR-abbreviated labels (e.g., EUR 12.5K)
       - Hover tooltip shows exact EUR amount (e.g., EUR 12,450)
       - Top 10 items shown, others grouped as "Other" (if more than 10)
    5. Change comparison period and verify % change badges appear on bars
    6. Select a date range with no REGULAR client entries -- verify "No revenue data" empty state
    7. (If possible) Test as non-admin user: verify NO revenue charts are shown, but hours charts remain at half width
    8. Resize browser to mobile width: verify paired charts stack vertically (hours above revenue)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run` -- full test suite passes
- `cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit` -- no TypeScript errors
- Admin user sees 4 charts in overview tab (2 hours + 2 revenue)
- Non-admin user sees 2 hours charts only
- Revenue charts use teal color (--accent-revenue), hours charts use coral pink (--accent-pink)
- Comparison badges appear on revenue chart bars when comparison period active
</verification>

<success_criteria>
- Revenue by Client bar chart renders for Admin/Partner with correct EUR data (REV-01)
- Revenue by Employee bar chart renders for Admin/Partner with correct EUR data (REV-02)
- Charts are separate from hours charts (not dual-axis)
- Charts respect selected date range and comparison period
- Non-admin users see no revenue charts
- Layout follows paired-row pattern with mobile stacking
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-overview-revenue-charts/02-02-SUMMARY.md`
</output>
