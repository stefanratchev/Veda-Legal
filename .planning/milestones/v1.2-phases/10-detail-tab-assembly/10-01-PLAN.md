---
phase: 10-detail-tab-assembly
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/src/components/reports/DetailTab.tsx
  - app/src/components/reports/DetailTab.test.tsx
  - app/src/components/reports/ReportsContent.tsx
autonomous: true
requirements:
  - DTAB-01
  - FILT-06
  - CHRT-01
  - CHRT-02
  - CHRT-03
  - CHRT-04
  - CHRT-05
  - CHRT-06

must_haves:
  truths:
    - "User can navigate to a Detail tab in Reports alongside Overview, By Client, and By Employee"
    - "User sees Hours by Client, Hours by Employee, and Hours by Topic horizontal bar charts"
    - "Admin additionally sees Revenue by Client, Revenue by Employee, and Revenue by Topic charts"
    - "Non-admin sees only hours charts using full width (no empty revenue column)"
    - "All six charts update simultaneously when any filter is applied or removed"
    - "When filters return zero results, user sees 'No entries match the selected filters' with a Clear filters link"
    - "Filter state resets when navigating away from and back to the Detail tab"
  artifacts:
    - path: "app/src/components/reports/DetailTab.tsx"
      provides: "Detail tab component with FilterBar, six charts, filter state management"
      exports: ["DetailTab"]
      min_lines: 120
    - path: "app/src/components/reports/DetailTab.test.tsx"
      provides: "Tests for DetailTab filter-to-chart data flow and rendering"
      min_lines: 100
    - path: "app/src/components/reports/ReportsContent.tsx"
      provides: "Updated to include Detail tab in tab bar"
      exports: ["ReportsContent"]
  key_links:
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/components/reports/FilterBar"
      via: "import and render with filters state + onChange"
      pattern: "FilterBar.*filters.*onChange"
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/lib/report-detail-utils"
      via: "import filterEntries, aggregateByClient, aggregateByEmployee, aggregateByTopic"
      pattern: "filterEntries|aggregateBy"
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/components/reports/charts/BarChart"
      via: "import and render with hours data from aggregations"
      pattern: "BarChart.*data.*layout"
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "@/components/reports/charts/RevenueBarChart"
      via: "import and render conditionally for admin with revenue data"
      pattern: "isAdmin.*RevenueBarChart"
    - from: "app/src/components/reports/ReportsContent.tsx"
      to: "app/src/components/reports/DetailTab.tsx"
      via: "import and conditional render when activeTab === 'detail'"
      pattern: "DetailTab.*entries.*isAdmin"
---

<objective>
Build the DetailTab component with filter state management, six paired charts (Hours + Revenue by Client/Employee/Topic), and integrate it into the Reports page tab bar. Uses TDD to verify the filter-to-chart data flow.

Purpose: DTAB-01 requires a new tab. FILT-06 requires all visualizations to update when filters change. CHRT-01 through CHRT-06 require six specific chart views. This plan delivers the complete chart section of the Detail tab.

Output: Working DetailTab component with FilterBar + six charts, integrated into ReportsContent tab bar, with tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-tab-assembly/10-CONTEXT.md
@.planning/phases/10-detail-tab-assembly/10-RESEARCH.md
@app/src/components/reports/ReportsContent.tsx
@app/src/components/reports/OverviewTab.tsx
@app/src/components/reports/FilterBar.tsx
@app/src/components/reports/charts/BarChart.tsx
@app/src/components/reports/charts/RevenueBarChart.tsx
@app/src/lib/report-detail-utils.ts
@app/src/lib/report-detail-utils.test.ts
@app/src/types/reports.ts
@app/src/lib/date-utils.ts
</context>

<feature>
  <name>DetailTab with FilterBar and Six Charts</name>
  <files>app/src/components/reports/DetailTab.tsx, app/src/components/reports/DetailTab.test.tsx, app/src/components/reports/ReportsContent.tsx</files>
  <behavior>
    DetailTab is a client component that receives `entries: ReportEntry[]` and `isAdmin: boolean` as props. It manages filter state internally and derives all chart data via useMemo chains.

    **Data flow:**
    1. Full entries array comes from ReportsContent (same data.entries already fetched)
    2. Filter options (clients, employees, topics) derived from FULL entries via useMemo (NOT from filtered entries)
    3. filteredEntries = filterEntries(entries, filters.clientIds, filters.employeeIds, filters.topicNames)
    4. byClient = aggregateByClient(filteredEntries)
    5. byEmployee = aggregateByEmployee(filteredEntries)
    6. byTopic = aggregateByTopic(filteredEntries)
    7. Chart data mapped from AggregationResult[] to BarChartItem[]/RevenueItem[]
    8. All charts receive derived data -- changing filters triggers re-derivation via useMemo

    **Layout:**
    - Top: FilterBar with clients, employees, topics options and filters state
    - Middle: 3 chart rows, each a 2-col grid (hours left, revenue right) for admin, single column for non-admin
      - Row 1: Hours by Client + Revenue by Client
      - Row 2: Hours by Employee + Revenue by Employee
      - Row 3: Hours by Topic + Revenue by Topic
    - Charts use BarChart (layout="vertical") for hours, RevenueBarChart for revenue
    - Charts use maxBars={10} to cap visible bars with "Other" grouping
    - Chart containers use h-64 (256px) fixed height
    - Revenue charts NOT passed comparisonData (comparison excluded from Detail tab per STATE.md)

    **Empty state:**
    - When filteredEntries.length === 0: show centered message "No entries match the selected filters" with a "Clear filters" button that calls setFilters with empty Sets

    **Tab integration in ReportsContent:**
    - Add "detail" to TabType union: `type TabType = "overview" | "by-employee" | "by-client" | "detail"`
    - Add to tabs array: `{ id: "detail", label: "Detail" }`
    - Render: `{activeTab === "detail" && <DetailTab key="detail" entries={data.entries} isAdmin={isAdmin} />}`
    - The `key="detail"` ensures filter state resets when switching tabs (React remounts on key change)

    Test cases (RED phase):
    - Renders FilterBar with correct options derived from entries
    - Renders three hours charts (BarChart) with aggregated data
    - Admin: renders three revenue charts (RevenueBarChart) alongside hours charts
    - Non-admin: does NOT render revenue charts
    - When filters applied, charts update with filtered/aggregated data
    - Empty state shown when filters match no entries, with "Clear filters" action
    - ReportsContent includes "Detail" tab in tab bar
    - DetailTab renders when Detail tab is active
  </behavior>
  <implementation>
    **DetailTab.tsx structure:**

    ```typescript
    "use client";

    import { useState, useMemo } from "react";
    import { FilterBar, FilterState } from "@/components/reports/FilterBar";
    import { BarChart } from "@/components/reports/charts/BarChart";
    import { RevenueBarChart } from "@/components/reports/charts/RevenueBarChart";
    import {
      filterEntries,
      aggregateByClient,
      aggregateByEmployee,
      aggregateByTopic,
    } from "@/lib/report-detail-utils";
    import { formatHours } from "@/lib/date-utils";
    import type { ReportEntry } from "@/types/reports";

    interface DetailTabProps {
      entries: ReportEntry[];
      isAdmin: boolean;
    }
    ```

    **Filter options derivation (from FULL entries, not filtered):**
    ```typescript
    const clientOptions = useMemo(() => {
      const map = new Map<string, string>();
      for (const e of entries) map.set(e.clientId, e.clientName);
      return Array.from(map, ([id, label]) => ({ id, label }))
        .sort((a, b) => a.label.localeCompare(b.label));
    }, [entries]);
    // Same pattern for employeeOptions (e.userId, e.userName) and topicOptions (e.topicName, e.topicName)
    ```

    **Chart data mapping pattern:**
    ```typescript
    const clientHoursData = useMemo(
      () => byClient.map(r => ({ name: r.name, value: r.totalHours, id: r.id })),
      [byClient]
    );
    const clientRevenueData = useMemo(
      () => byClient
        .filter(r => r.revenue != null && r.revenue > 0)
        .map(r => ({ name: r.name, value: r.revenue!, id: r.id })),
      [byClient]
    );
    ```

    **Chart row pattern (repeat for Employee and Topic):**
    ```tsx
    <div className={`grid grid-cols-1 ${isAdmin ? "md:grid-cols-2" : ""} gap-4`}>
      <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
        <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
          Hours by Client
        </h3>
        <div className="h-64">
          <BarChart data={clientHoursData} valueFormatter={formatHours} layout="vertical" maxBars={10} />
        </div>
      </div>
      {isAdmin ? (
        <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
          <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
            Revenue by Client
          </h3>
          <div className="h-64">
            <RevenueBarChart data={clientRevenueData} maxBars={10} />
          </div>
        </div>
      ) : null}
    </div>
    ```

    **Test setup:**
    - Mock BarChart, RevenueBarChart, FilterBar, and DataTable as simple divs that expose received props via data-testid attributes
    - Mock report-detail-utils functions to control return values
    - Use `vi.mock()` for all chart/filter dependencies
    - Use `fireEvent` (not userEvent) for interactions
    - Import `renderWithProviders` if needed, or plain `render` since DetailTab has no context dependencies

    **ReportsContent.tsx changes:**
    - Import DetailTab
    - Extend TabType union with "detail"
    - Add { id: "detail", label: "Detail" } to tabs array
    - Add conditional render with key prop for state reset
  </implementation>
</feature>

<verification>
```bash
cd app && npm run test -- DetailTab --run
```
All DetailTab tests pass. No regressions:
```bash
cd app && npm run test -- --run
```
</verification>

<success_criteria>
- DetailTab component renders FilterBar with options derived from full entry dataset
- Three horizontal bar charts for hours (by Client, Employee, Topic) render with aggregated data
- Admin sees three additional revenue charts paired next to hours charts
- Non-admin sees only hours charts using full column width
- Changing filters updates all charts simultaneously via useMemo derivation chain
- Empty state with "Clear filters" shown when no entries match filters
- ReportsContent tab bar includes "Detail" tab alongside existing tabs
- DetailTab renders when Detail tab is selected
- Filter state resets on tab switch (via key prop remounting)
- All tests pass including existing suite (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-tab-assembly/10-01-SUMMARY.md`
</output>
