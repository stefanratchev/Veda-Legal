---
phase: 13-date-range-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/app/api/billing/route.ts
  - app/src/components/billing/DateRangePicker.tsx
  - app/src/components/billing/DateRangePicker.test.tsx
  - app/src/components/billing/BillingContent.tsx
  - app/src/components/billing/BillingContent.test.tsx
  - app/src/app/(authenticated)/(admin)/billing/page.tsx
autonomous: true
requirements: [FILT-01, FILT-02, FILT-03, FILT-04]

must_haves:
  truths:
    - "Service Descriptions tab shows a date range picker to the LEFT of search and status filter"
    - "Opening the Service Descriptions tab defaults to This Month date range"
    - "Selecting a different preset (Last Month, All Time) fetches only matching SDs from the server"
    - "Custom Range lets user pick arbitrary start/end dates and fetches matching SDs"
    - "Status filter and date range filter apply simultaneously (both constraints respected)"
    - "Preset dropdown shows: This Month, Last Month, All Time, Custom Range in that order"
  artifacts:
    - path: "app/src/components/billing/DateRangePicker.tsx"
      provides: "Date range picker dropdown with presets and custom range"
    - path: "app/src/components/billing/DateRangePicker.test.tsx"
      provides: "Tests for DateRangePicker preset selection and custom range"
    - path: "app/src/app/api/billing/route.ts"
      provides: "GET endpoint accepting periodStartFrom/periodStartTo query params"
    - path: "app/src/components/billing/BillingContent.tsx"
      provides: "SD tab fetches from API with date range params; integrates DateRangePicker"
    - path: "app/src/components/billing/BillingContent.test.tsx"
      provides: "Tests for date range filtering integration"
  key_links:
    - from: "app/src/components/billing/BillingContent.tsx"
      to: "/api/billing?periodStartFrom=...&periodStartTo=..."
      via: "fetch in useEffect/useCallback when date range changes"
      pattern: "fetch.*api/billing.*periodStart"
    - from: "app/src/components/billing/DateRangePicker.tsx"
      to: "app/src/components/billing/BillingContent.tsx"
      via: "onChange callback passing DateRange object"
      pattern: "onChange.*DateRange"
    - from: "app/src/app/api/billing/route.ts"
      to: "serviceDescriptions.periodStart"
      via: "SQL WHERE with gte/lte on periodStart column"
      pattern: "gte.*periodStart|lte.*periodStart"
---

<objective>
Add date range filtering to the Service Descriptions tab. Users select a preset (This Month, Last Month, All Time) or a custom date range. The selected range filters service descriptions server-side by `periodStart`. The date range picker sits to the left of the existing search and status filter controls.

Purpose: Users can scope the SD list to a specific billing period instead of scrolling through all historical service descriptions.
Output: DateRangePicker component, updated API with date range params, BillingContent wired for client-side fetching with date range.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-date-range-filtering/13-CONTEXT.md
@.planning/phases/12-tab-navigation/12-01-SUMMARY.md

@app/src/components/billing/BillingContent.tsx
@app/src/components/billing/BillingContent.test.tsx
@app/src/app/api/billing/route.ts
@app/src/app/(authenticated)/(admin)/billing/page.tsx
@app/src/components/ui/TableFilters.tsx
@app/src/components/ui/table-types.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/src/lib/schema.ts — serviceDescriptions table:
```typescript
export const serviceDescriptions = pgTable("service_descriptions", {
  id: text().primaryKey().notNull(),
  clientId: text().notNull(),
  periodStart: date().notNull(),    // date type, stored as "YYYY-MM-DD" string
  periodEnd: date().notNull(),
  status: serviceDescriptionStatus().default('DRAFT').notNull(),
  // ... other fields
});
```

From app/src/components/billing/BillingContent.tsx — current props and types:
```typescript
interface ServiceDescriptionListItem {
  id: string;
  clientId: string;
  clientName: string;
  periodStart: string;    // "YYYY-MM-DD"
  periodEnd: string;
  status: ServiceDescriptionStatus;
  totalAmount: number;
  updatedAt: string;
}

interface BillingContentProps {
  initialServiceDescriptions: ServiceDescriptionListItem[];
  clients: Client[];
}
```

From app/src/components/ui/table-types.ts — TableFiltersProps:
```typescript
export interface TableFiltersProps {
  searchValue: string;
  onSearchChange: (value: string) => void;
  searchPlaceholder?: string;
  filterOptions?: Array<{ value: string; label: string }>;
  filterValue?: string;
  onFilterChange?: (value: string) => void;
  resultCount?: number;
}
```

From app/src/app/api/billing/route.ts — current GET handler:
```typescript
export async function GET(request: NextRequest) {
  const auth = await requireAdmin(request);
  // ... fetches ALL service descriptions, no date filtering
  // Returns: { id, clientId, clientName, periodStart, periodEnd, status, totalAmount, updatedAt }[]
}
```

Drizzle ORM comparison operators (already imported in route.ts):
```typescript
import { eq, and, desc, asc } from "drizzle-orm";
// Also available: gte, lte from "drizzle-orm"
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date range query params to billing API + build DateRangePicker component</name>
  <files>
    app/src/app/api/billing/route.ts
    app/src/components/billing/DateRangePicker.tsx
    app/src/components/billing/DateRangePicker.test.tsx
  </files>
  <action>
**1. Update GET /api/billing to accept date range query params**

In `app/src/app/api/billing/route.ts`:
- Import `gte` and `lte` from `drizzle-orm` (add to existing import)
- Read `periodStartFrom` and `periodStartTo` from `request.nextUrl.searchParams`
- Build a `where` array of conditions. If `periodStartFrom` is provided, add `gte(serviceDescriptions.periodStart, periodStartFrom)`. If `periodStartTo` is provided, add `lte(serviceDescriptions.periodStart, periodStartTo)`.
- Pass `where: and(...conditions)` to the `db.query.serviceDescriptions.findMany()` call (only if conditions are non-empty; otherwise omit `where` to fetch all)
- The date matching logic per CONTEXT.md: "An SD is included if its `periodStart` falls within the selected date range"
- Validation: if params are present, ensure they are valid date strings (YYYY-MM-DD format). Return 400 if malformed.

**2. Create DateRangePicker component**

Create `app/src/components/billing/DateRangePicker.tsx`:

Define the DateRange type and preset type:
```typescript
export type DateRangePreset = "this-month" | "last-month" | "all-time" | "custom";

export interface DateRange {
  preset: DateRangePreset;
  from: string | null;  // "YYYY-MM-DD" or null for all-time
  to: string | null;    // "YYYY-MM-DD" or null for all-time
}
```

Props interface:
```typescript
interface DateRangePickerProps {
  value: DateRange;
  onChange: (range: DateRange) => void;
}
```

Implementation details:
- Render as a dropdown button (trigger) that opens a popover/menu below it
- Match the existing design system: `bg-[var(--bg-surface)]`, `border-[var(--border-subtle)]`, `text-[13px]`, same height as the status filter select
- Trigger button label reflects active selection:
  - "This Month" for `this-month` preset
  - "Last Month" for `last-month` preset
  - "All Time" for `all-time` preset
  - For `custom`: format as "Jan 1 - Feb 15" (short month + day for both dates). Use `toLocaleDateString("en-GB", { day: "numeric", month: "short" })` for each date. If same year as current year, omit year; if different year, append year.
- Dropdown menu (absolute positioned below trigger, use `animate-fade-up` for entrance):
  - Four preset buttons: "This Month", "Last Month", "All Time", "Custom Range" — in that order
  - Active preset highlighted with `text-[var(--accent-pink)]` and a small left border or background tint
  - When "Custom Range" is selected, show two date inputs (`<input type="date">`) below the presets for "From" and "To"
  - Custom date inputs styled with same `bg-[var(--bg-surface)]` / `border-[var(--border-subtle)]` treatment
  - When user changes either custom date input, call `onChange` with the new range immediately
- Close dropdown when clicking outside (use `useClickOutside` from `@/hooks/useClickOutside`)
- Helper function `getDateRange(preset: DateRangePreset): { from: string; to: string } | { from: null; to: null }`:
  - `this-month`: from = first day of current month, to = last day of current month (both YYYY-MM-DD)
  - `last-month`: from = first day of previous month, to = last day of previous month
  - `all-time`: from = null, to = null
  - For `custom`, this helper is not used (dates come from inputs)
- Export `getDateRange` for testing
- Use `rendering-conditional-render` rule: ternary for conditional rendering, not `&&`

**3. Create DateRangePicker tests**

Create `app/src/components/billing/DateRangePicker.test.tsx`:
- Test preset rendering: all 4 presets visible in dropdown
- Test `getDateRange` helper: verify "this-month" returns correct first/last day, "last-month" returns correct dates, "all-time" returns nulls
- Test trigger label: renders correct label for each preset
- Test custom range: when custom is selected, date inputs appear
- Test clicking a preset calls onChange with correct DateRange
- Mock `useClickOutside` or test close-on-outside-click behavior
- Use `vi.useFakeTimers()` to control "today" for deterministic this-month/last-month calculations
  </action>
  <verify>
    <automated>cd app && npm run test -- --run DateRangePicker</automated>
  </verify>
  <done>
    - GET /api/billing accepts optional periodStartFrom and periodStartTo query params and filters service descriptions by periodStart
    - DateRangePicker component renders a dropdown with 4 presets and custom date inputs
    - getDateRange helper correctly computes date ranges for each preset
    - All DateRangePicker tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DateRangePicker into BillingContent with client-side SD fetching</name>
  <files>
    app/src/components/billing/BillingContent.tsx
    app/src/components/billing/BillingContent.test.tsx
    app/src/app/(authenticated)/(admin)/billing/page.tsx
  </files>
  <action>
**1. Update BillingContent to use client-side fetching with date range**

In `app/src/components/billing/BillingContent.tsx`:

- Import `DateRangePicker`, `DateRange`, `getDateRange` from `./DateRangePicker`
- Add `dateRange` state initialized with the "this-month" preset:
  ```typescript
  const [dateRange, setDateRange] = useState<DateRange>(() => {
    const { from, to } = getDateRange("this-month");
    return { preset: "this-month", from, to };
  });
  ```
- Add `isLoadingSDs` state (boolean, default false)
- Add a `fetchServiceDescriptions` function (wrapped in `useCallback`) that:
  - Sets `isLoadingSDs` to true
  - Builds URL: `/api/billing` with optional `periodStartFrom` and `periodStartTo` query params (omit if null, i.e., for "all-time")
  - Fetches from the API
  - Updates `serviceDescriptions` state with the response
  - Sets `isLoadingSDs` to false
  - Handles errors gracefully (console.error, keep existing data)
- Call `fetchServiceDescriptions` via `useEffect` whenever `dateRange.from` or `dateRange.to` changes. Use the values as effect dependencies (not the whole dateRange object — `rerender-dependencies` rule).
- Keep `initialServiceDescriptions` prop for the initial render of the SD tab — but when user is on the SD tab, the effect-driven fetch takes over. On initial mount when the SD tab is active, the effect will fire with "this-month" range. To avoid a flash, the server page can pass initial SDs pre-filtered to "this month" (see page.tsx changes below).
- Replace the existing filter bar section in the SD tab to include DateRangePicker BEFORE the search input:
  ```tsx
  {activeTab === "service-descriptions" && (
    <>
      <div className="flex items-center gap-3 mb-4">
        <DateRangePicker value={dateRange} onChange={setDateRange} />
        {/* Search Input - same as current TableFilters search */}
        <div className="flex-1 max-w-md relative">
          {/* ... existing search input markup ... */}
        </div>
        {/* Status Filter - same as current TableFilters select */}
        <select ...>...</select>
        {/* Result Count */}
        <div className="text-[13px] text-[var(--text-muted)]">
          {filteredDescriptions.length} results
        </div>
      </div>
      ...
    </>
  )}
  ```
  This means we inline the filter bar instead of using `<TableFilters>` (since TableFilters doesn't support an arbitrary left-side element). Copy the search input and status filter markup from the current `<TableFilters>` component directly into BillingContent. The TableFilters import can be removed.
- The `filteredDescriptions` useMemo continues to apply search and status filter client-side on top of the server-fetched (date-range-filtered) SDs. This satisfies FILT-04 (both filters work together): date range is server-side, status + search are client-side on the already-filtered set.
- While `isLoadingSDs` is true, show a subtle loading indicator (e.g., reduce table opacity to 0.5 or show a small spinner). Keep the table visible with previous data to avoid layout shift.

**2. Update billing page.tsx to pre-filter initial SDs to "this month"**

In `app/src/app/(authenticated)/(admin)/billing/page.tsx`:
- Import `gte` and `lte` from `drizzle-orm`
- Compute current month start/end dates:
  ```typescript
  const now = new Date();
  const monthStart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-01`;
  const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const monthEnd = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(lastDay).padStart(2, "0")}`;
  ```
- Add `where` clause to the `db.query.serviceDescriptions.findMany()` call:
  ```typescript
  where: and(
    gte(serviceDescriptions.periodStart, monthStart),
    lte(serviceDescriptions.periodStart, monthEnd),
  ),
  ```
  This ensures the initial SSR data matches the "This Month" default, avoiding a flash when the client-side fetch fires.

**3. Update BillingContent tests**

In `app/src/components/billing/BillingContent.test.tsx`:
- Mock the DateRangePicker component (like other child components are mocked)
- Mock `global.fetch` for the API call tests
- Add tests for FILT-01: DateRangePicker is rendered when on SD tab
- Add tests for FILT-02: Default date range is "this-month" (verify fetch called with this-month params)
- Add tests for FILT-03: Changing date range triggers API fetch with correct params
- Add tests for FILT-04: Status filter still works alongside date range (verify filteredDescriptions applies both)
- Keep existing tab navigation tests intact (TABS-01 through TABS-05)
- Use `vi.useFakeTimers()` for deterministic date calculations in tests that check default "this month" range
  </action>
  <verify>
    <automated>cd app && npm run test -- --run BillingContent</automated>
  </verify>
  <done>
    - DateRangePicker appears to the LEFT of search and status filter on the Service Descriptions tab
    - Opening Service Descriptions tab defaults to "This Month" date range
    - Changing date range fetches SDs from /api/billing with periodStartFrom/periodStartTo params
    - Status filter and date range work simultaneously
    - Initial SSR data matches "This Month" default (no flash)
    - All existing tab navigation tests still pass
    - New FILT-01 through FILT-04 tests pass
  </done>
</task>

</tasks>

<verification>
1. Run all billing tests: `cd app && npm run test -- --run billing`
2. Run full test suite: `cd app && npm run test -- --run`
3. Build check: `cd app && npm run build`
4. Manual verification (via dev server):
   - Navigate to /billing?tab=service-descriptions
   - Verify date range picker appears left of search, defaulting to "This Month"
   - Click "Last Month" — table updates with last month's SDs
   - Click "All Time" — table shows all SDs regardless of period
   - Select "Custom Range" — pick dates, table filters accordingly
   - Change status filter to "Draft" — both date range and status filter apply
</verification>

<success_criteria>
- DateRangePicker component renders with 4 presets (This Month, Last Month, All Time, Custom Range) in that order
- Default selection is "This Month" when opening the Service Descriptions tab
- Server-side filtering: GET /api/billing accepts periodStartFrom/periodStartTo and returns only matching SDs
- Client-side status filter + server-side date range work together seamlessly
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13-date-range-filtering/13-01-SUMMARY.md`
</output>
