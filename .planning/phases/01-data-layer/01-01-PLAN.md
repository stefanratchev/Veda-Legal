---
phase: 01-data-layer
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/src/app/api/reports/route.test.ts
  - app/src/app/api/reports/route.ts
autonomous: true
requirements:
  - DAT-01
  - DAT-02
  - DAT-03

must_haves:
  truths:
    - "API response entries include topicName (null/empty resolved to 'Uncategorized')"
    - "API response byClient items include topics[] array with totalHours and writtenOffHours per topic"
    - "API response byEmployee items include topics[] array with totalHours and writtenOffHours per topic"
    - "API response byClient.revenue is always a number (0 for INTERNAL/MANAGEMENT, 0 for null rate, excludes written-off hours)"
    - "API response byEmployee items include revenue (proportional: non-written-off hours on REGULAR client * client rate)"
    - "API response byEmployee items include billableHours (hours on REGULAR clients, excluding written-off)"
    - "API response summary.totalWrittenOffHours tracks total written-off hours"
    - "API response entries include isWrittenOff and clientType fields"
    - "API response byClient items include clientType field"
    - "Non-admin users see null for revenue/billableHours/hourlyRate fields"
    - "summary.totalRevenue equals sum of byClient.revenue for REGULAR clients"
  artifacts:
    - path: "app/src/app/api/reports/route.test.ts"
      provides: "Comprehensive tests for topic aggregations, revenue rules, written-off handling, employee revenue"
      contains: "Topic Aggregations"
    - path: "app/src/app/api/reports/route.ts"
      provides: "Extended API route with topic, revenue, and write-off logic"
      contains: "topicName"
  key_links:
    - from: "app/src/app/api/reports/route.ts"
      to: "timeEntries.topicName"
      via: "Drizzle query columns selection"
      pattern: "topicName.*true"
    - from: "app/src/app/api/reports/route.ts"
      to: "timeEntries.isWrittenOff"
      via: "Drizzle query columns selection"
      pattern: "isWrittenOff.*true"
    - from: "app/src/app/api/reports/route.ts"
      to: "client.clientType"
      via: "Drizzle query with relation"
      pattern: "clientType.*true"
---

<objective>
Extend the reports API route with topic aggregations, consistent revenue calculations, and write-off awareness using TDD.

Purpose: The API route is the primary data source for all downstream UI phases (revenue charts, drill-downs). Getting the data layer right with tests first ensures correctness of business rules (written-off exclusion, client type handling, proportional employee revenue).

Output: Fully tested `route.ts` with new response fields (topics[], revenue, billableHours, clientType, isWrittenOff, topicName, totalWrittenOffHours).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-layer/01-CONTEXT.md
@.planning/phases/01-data-layer/01-RESEARCH.md
@app/src/app/api/reports/route.ts
@app/src/app/api/reports/route.test.ts
@app/src/lib/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for topic aggregation, revenue rules, and write-off handling</name>
  <files>app/src/app/api/reports/route.test.ts</files>
  <action>
Extend the existing test file with new test cases. All new tests should FAIL initially (since route.ts hasn't changed yet).

**1. Update `createMockTimeEntryWithRelations` helper** to support new fields:
- Add optional `topicName?: string` (default: `"General Advisory"`)
- Add optional `isWrittenOff?: boolean` (default: `false`)
- Add optional `clientType?: "REGULAR" | "INTERNAL" | "MANAGEMENT"` on the client object (default: `"REGULAR"`)
- Wire these into the returned mock object so they appear in the mock DB result

**2. Update existing test that will break:**
- In "handles client without hourly rate" test (~line 394-418): Change assertion from `expect(client.revenue).toBeNull()` to `expect(client.revenue).toBe(0)` — this matches the user decision that null rate = revenue 0 (not null).

**3. Add new `describe("Topic Aggregations")` block with these tests:**
- `it("includes topicName on each entry in the response")` — assert entries have `topicName` field
- `it("resolves null topicName to 'Uncategorized'")` — entry with `topicName: null` should appear as `"Uncategorized"`
- `it("resolves empty string topicName to 'Uncategorized'")` — entry with `topicName: ""` should appear as `"Uncategorized"`
- `it("includes topics array on byClient items")` — create 2 entries for same client with different topics, assert `byClient[0].topics` is an array with 2 items containing `topicName`, `totalHours`, `writtenOffHours`
- `it("includes topics array on byEmployee items")` — similar but on byEmployee
- `it("aggregates written-off hours separately in topic")` — 2 entries same topic, one written-off: topic should have `totalHours: 5, writtenOffHours: 2`

**4. Add new `describe("Written-Off Handling")` block:**
- `it("includes isWrittenOff flag on entries")` — assert entry has `isWrittenOff: true`
- `it("includes totalWrittenOffHours in summary")` — 3 entries, one written-off: summary.totalWrittenOffHours = written-off entry hours
- `it("excludes written-off hours from client revenue")` — client with rate 150, two entries (3h normal, 2h written-off): revenue should be 450 (not 750)
- `it("excludes written-off hours from summary totalRevenue")` — same scenario, summary.totalRevenue = 450
- `it("includes written-off hours in totalHours")` — totalHours should still count all hours (including written-off)

**5. Add new `describe("Client Type Revenue Rules")` block:**
- `it("includes clientType on byClient items")` — assert byClient item has clientType field
- `it("includes clientType on entries")` — assert entry has clientType field
- `it("sets revenue to 0 for INTERNAL clients")` — INTERNAL client with hourlyRate 150: revenue = 0
- `it("sets revenue to 0 for MANAGEMENT clients")` — MANAGEMENT client with hourlyRate 150: revenue = 0
- `it("excludes INTERNAL/MANAGEMENT from summary totalRevenue")` — mix of REGULAR and INTERNAL: totalRevenue only from REGULAR

**6. Add new `describe("Employee Revenue")` block:**
- `it("includes revenue on byEmployee items")` — assert byEmployee item has `revenue` field (number)
- `it("calculates employee revenue proportionally")` — employee works 3h on client A (rate 150) and 2h on client B (rate 200): revenue = 3*150 + 2*200 = 850
- `it("excludes written-off hours from employee revenue")` — employee works 3h (normal) + 2h (written-off) on client (rate 150): revenue = 450
- `it("excludes INTERNAL client hours from employee revenue")` — employee works on REGULAR (3h, rate 150) + INTERNAL (2h, rate 100): revenue = 450
- `it("includes billableHours on byEmployee items")` — employee works 3h REGULAR + 2h INTERNAL: billableHours = 3, totalHours = 5

**7. Add new `describe("Revenue Consistency")` block:**
- `it("summary totalRevenue equals sum of byClient revenue for REGULAR clients")` — create entries across multiple clients (REGULAR + INTERNAL), verify `summary.totalRevenue === sum(byClient.filter(c => c.clientType === 'REGULAR').map(c => c.revenue))`

**8. Add new `describe("Non-Admin Revenue Visibility")` block:**
- `it("hides employee revenue and billableHours from non-admin users")` — non-admin: byEmployee items should have `revenue: null`, `billableHours: null`
- `it("hides totalWrittenOffHours from non-admin users")` — non-admin: summary.totalWrittenOffHours should be null or absent

All tests should use the admin user setup pattern from existing tests. Use `createMockUser({ position: "ADMIN" })` for admin tests, `createMockUser({ position: "ASSOCIATE" })` for non-admin tests.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx vitest run src/app/api/reports/route.test.ts 2>&1 | tail -30</automated>
    <manual>Most new tests should FAIL (expected — route.ts not updated yet). The only test that should change from pass to fail is the "handles client without hourly rate" test if the assertion is updated before the implementation. That's fine — it confirms the test is active.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All new test cases are written and assert the correct expected behavior. Existing test for null hourlyRate updated to expect revenue: 0. New tests fail because route.ts hasn't been updated yet (RED phase).</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement API route changes to pass all tests</name>
  <files>app/src/app/api/reports/route.ts</files>
  <action>
Update the reports API route to make all tests pass. Follow these specific changes:

**1. Update the Drizzle query** to select additional columns:
```typescript
columns: {
  id: true,
  date: true,
  hours: true,
  description: true,
  userId: true,
  clientId: true,
  topicName: true,       // ADD
  isWrittenOff: true,    // ADD
},
with: {
  user: { columns: { id: true, name: true } },
  client: {
    columns: {
      id: true,
      name: true,
      hourlyRate: true,
      clientType: true,  // ADD
    },
  },
},
```

**2. Update TypeScript interfaces** at the top of the file:

Add `TopicAggregation` interface:
```typescript
interface TopicAggregation {
  topicName: string;
  totalHours: number;
  writtenOffHours: number;
}
```

Update `EmployeeStats` to add: `billableHours: number | null`, `revenue: number | null`, `topics: TopicAggregation[]`.

Update `ClientStats` to add: `clientType: "REGULAR" | "INTERNAL" | "MANAGEMENT"`, `topics: TopicAggregation[]`. Change `revenue` type from `number | null` to `number` for the internal representation (null-out happens at response level for non-admins).

Update `ReportData.summary` to add: `totalWrittenOffHours: number | null` (null for non-admin).

Update `ReportData.entries` items to add: `topicName: string`, `isWrittenOff: boolean`, `clientType: "REGULAR" | "INTERNAL" | "MANAGEMENT"`.

**3. Extend the aggregation Maps:**

Employee map needs: `topicMap: Map<string, { totalHours: number; writtenOffHours: number }>`, `billableHours: number`, `revenueByClient: Map<string, number>` (tracks non-written-off hours per client for revenue calc).

Client map needs: `clientType`, `topicMap: Map<string, { totalHours: number; writtenOffHours: number }>`.

**4. Update the aggregation loop.** For each entry:
```
const topicName = entry.topicName || "Uncategorized";
const isWrittenOff = entry.isWrittenOff ?? false;
const clientType = entry.client.clientType;
const isBillable = clientType === "REGULAR";
const clientRate = entry.client.hourlyRate ? Number(entry.client.hourlyRate) : 0;
```

Track `totalWrittenOffHours` at summary level: if `isWrittenOff`, add to counter.

Revenue calculation (replacing current logic):
- Only count revenue when `!isWrittenOff && isBillable && clientRate > 0`
- `totalRevenue` accumulates: `hours * clientRate` (only for admin)

Employee aggregation additions:
- Track `topicMap` per employee (same pattern as client topicMap)
- Track `billableHours`: add hours when `isBillable && !isWrittenOff`
- Track revenue per client: when `!isWrittenOff && isBillable`, accumulate `hours * clientRate` in a per-employee revenue accumulator

Client aggregation additions:
- Store `clientType` on client map entry
- Track `topicMap` per client: initialize/update topic entries with totalHours and writtenOffHours

**5. Update response building:**

`byClient` mapping:
- Add `clientType` from the map
- Add `topics: Array.from(client.topicMap.values()).map(t => ({ topicName: t.topicName, totalHours: t.totalHours, writtenOffHours: t.writtenOffHours }))` — but the topicMap key IS the topicName, so reconstruct the full object
- `revenue` = sum of non-written-off hours * rate for REGULAR clients (already tracked), always a number (0 for non-billable)
- For non-admin: null out `hourlyRate`, `revenue` (existing pattern), also null out `clientType` is NOT needed (clientType is always visible)

`byEmployee` mapping:
- Add `topics` from topicMap (same pattern as byClient)
- Add `billableHours` and `revenue` for admin users
- For non-admin: `revenue: null`, `billableHours: null`

`summary`:
- Add `totalWrittenOffHours` for admin, null for non-admin

`entries` mapping:
- Add `topicName: entry.topicName || "Uncategorized"`
- Add `isWrittenOff: entry.isWrittenOff ?? false`
- Add `clientType: entry.client.clientType`

**6. Fix existing revenue calculation (breaking change):**
- Remove the current pattern where `revenue: null` when `hourlyRate === null`
- New pattern: `revenue` is always a number. It's 0 when: hourlyRate is null, clientType is INTERNAL/MANAGEMENT, or all hours are written-off
- Non-admin null-out of revenue fields stays as-is (applies to byClient hourlyRate/revenue)

**Critical: Do NOT create a `shouldCountRevenue` utility function in a separate file.** Keep logic inline in this route — shared utilities come in a later refactor if needed.

**Critical: The `clientRate` variable must use `Number(entry.client.hourlyRate)` when truthy, `0` when null/falsy.** This is the pattern from research — `0` not `null`.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx vitest run src/app/api/reports/route.test.ts 2>&1 | tail -40</automated>
    <manual>All tests pass, including the new ones from Task 1 and all existing tests (with updated assertion for null hourlyRate).</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>All tests pass. API route returns: topicName on entries, topics[] on byClient and byEmployee, revenue as number (not null), billableHours on byEmployee, totalWrittenOffHours on summary, isWrittenOff and clientType on entries and byClient items. Non-admin users see null for revenue-related fields. Revenue consistently excludes written-off entries and INTERNAL/MANAGEMENT clients.</done>
</task>

</tasks>

<verification>
1. `cd /Users/stefan/projects/veda-legal-timesheets/app && npx vitest run src/app/api/reports/route.test.ts` — all tests pass
2. `cd /Users/stefan/projects/veda-legal-timesheets/app && npx vitest run --run` — full suite green (no regressions)
3. `cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit` — TypeScript compiles without errors
</verification>

<success_criteria>
- All existing tests pass (with updated null-rate assertion)
- New tests cover: topic aggregation (entries + byClient + byEmployee), written-off handling (hours vs revenue), client type revenue rules, employee proportional revenue, revenue consistency, non-admin visibility
- Route response includes all new fields per CONTEXT.md decisions
- Revenue fields are always numbers (0 for non-billable), not null (breaking change from current behavior)
- Non-admin users see null for revenue/billableHours/hourlyRate/totalWrittenOffHours
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-layer/01-01-SUMMARY.md`
</output>
