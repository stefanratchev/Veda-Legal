---
phase: 04-employee-drill-down-enhancements
plan: 01
type: execute
wave: 1
depends_on: ["04-00"]
files_modified:
  - app/src/components/reports/ByEmployeeTab.tsx
autonomous: true
requirements: [EDR-01]

must_haves:
  truths:
    - "Employee drill-down shows a Topic Breakdown horizontal bar chart with hours and percentage labels"
    - "Topic Breakdown chart is side-by-side with Hours by Client chart (responsive, stacks on mobile)"
    - "Hours by Day chart is removed and replaced with Topic Breakdown chart"
    - "Zero-hour topics are hidden from the chart"
  artifacts:
    - path: "app/src/components/reports/ByEmployeeTab.tsx"
      provides: "Topic breakdown chart, updated interfaces, side-by-side layout"
      contains: "Topic Breakdown"
  key_links:
    - from: "app/src/components/reports/ByEmployeeTab.tsx"
      to: "app/src/components/reports/charts/BarChart.tsx"
      via: "import { BarChart }"
      pattern: "BarChart.*data.*topicChartData"
---

<objective>
Add the topic breakdown chart to the employee drill-down view, replacing the "Hours by Day" chart with a "Topic Breakdown" chart in a side-by-side responsive layout with "Hours by Client".

Purpose: Admins can see how an employee's time distributes across topics when drilling into that employee (EDR-01).
Output: Updated `ByEmployeeTab.tsx` with topic chart, updated interfaces, responsive layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-employee-drill-down-enhancements/04-RESEARCH.md

# Reference implementation — how ByClientTab does the same thing
@app/src/components/reports/ByClientTab.tsx
# Component to modify
@app/src/components/reports/ByEmployeeTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ByEmployeeTab interfaces with topics and topicName</name>
  <files>app/src/components/reports/ByEmployeeTab.tsx</files>
  <action>
Update the two local interfaces at the top of ByEmployeeTab.tsx:

1. **EmployeeStats** (lines 6-14): Add `topics` field:
   ```typescript
   topics: { topicName: string; totalHours: number; writtenOffHours: number }[];
   ```
   This matches the `TopicAggregation` shape from the API (Phase 1) and the same pattern used in `ByClientTab.ClientStats.topics`.

2. **Entry** (lines 16-28): Add `topicName` field:
   ```typescript
   topicName: string;
   ```
   Place it after `description`. This field already flows from `ReportsContent.tsx` `transformedEntries` (added in Phase 3 plan 01).

These interface changes are prerequisites for the chart code in Task 2. The excess properties from the API data already pass through — this just lets TypeScript access them.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>No TypeScript errors — interfaces match the data flowing from ReportsContent</manual>
    <sampling_rate>run after this task commits</sampling_rate>
  </verify>
  <done>EmployeeStats has topics field. Entry has topicName field. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Replace Hours by Day with Topic Breakdown chart in side-by-side layout</name>
  <files>app/src/components/reports/ByEmployeeTab.tsx</files>
  <action>
Modify the drill-down section of ByEmployeeTab.tsx (the `if (selectedEmployee)` block):

**1. Remove "Hours by Day" computation (lines 111-124):**
Delete the `hoursByDay` reduce and `dayChartData` sort entirely.

**2. Add topic chart data preparation (after the clientChartData computation):**
Mirror ByClientTab lines 142-153 exactly, adapted for employee:
```typescript
// Prepare topic chart data from pre-computed topics
const topicChartData = selectedEmployee.topics
  .filter((t) => t.totalHours > 0)
  .map((t) => {
    const pct = selectedEmployee.totalHours > 0
      ? Math.round((t.totalHours / selectedEmployee.totalHours) * 100)
      : 0;
    return {
      name: `${t.topicName}  ${formatHours(t.totalHours)} (${pct}%)`,
      value: t.totalHours,
    };
  })
  .sort((a, b) => b.value - a.value);
```

**3. Add dynamic chart heights (after chart data prep):**
```typescript
const topicChartHeight = Math.max(256, topicChartData.length * 40);
const clientChartHeight = Math.max(256, clientChartData.length * 40);
```

**4. Update chart grid layout (lines 164-190):**
- Change `grid grid-cols-2 gap-4` to `grid grid-cols-1 md:grid-cols-2 gap-4` (add responsive stacking).
- Replace the first chart card (currently "Hours by Client") with "Topic Breakdown" using `topicChartData` and `topicChartHeight`. Topic Breakdown goes on the LEFT.
- Replace the second chart card (currently "Hours by Day") with "Hours by Client" using `clientChartData` and `clientChartHeight`. Hours by Client goes on the RIGHT.
- Both charts use `layout="vertical"` (horizontal bars) and `valueFormatter={formatHours}`.
- Use `style={{ height: topicChartHeight }}` and `style={{ height: clientChartHeight }}` instead of fixed `className="h-64"`.

Result should look like:
```tsx
<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
  {/* Topic Breakdown */}
  <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
    <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
      Topic Breakdown
    </h3>
    <div style={{ height: topicChartHeight }}>
      <BarChart data={topicChartData} valueFormatter={formatHours} layout="vertical" />
    </div>
  </div>
  {/* Hours by Client */}
  <div className="bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded p-4">
    <h3 className="text-[11px] uppercase tracking-wider text-[var(--text-muted)] mb-4">
      Hours by Client
    </h3>
    <div style={{ height: clientChartHeight }}>
      <BarChart data={clientChartData} valueFormatter={formatHours} layout="vertical" />
    </div>
  </div>
</div>
```

**5. Also add empty state for drill-down with no entries:**
After the `const employeeEntries = ...` filter (line 90-92), add an empty state check mirroring ByClientTab lines 86-123:
```typescript
if (employeeEntries.length === 0) {
  return (
    <div className="space-y-6">
      {/* Back button and header - same as normal view */}
      <div className="flex items-center gap-3">
        <button onClick={() => onSelectEmployee(null)} className="...">
          {/* Back arrow SVG */} Back to All
        </button>
        <span className="text-[var(--border-subtle)]">|</span>
        <h3 className="text-[var(--text-primary)] font-medium">{selectedEmployee.name}</h3>
      </div>
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <p className="text-[var(--text-secondary)] text-[13px]">
          No time entries for this employee in the selected period
        </p>
      </div>
    </div>
  );
}
```

**Critical: Do NOT change the summary table at the bottom of the component (lines 238-277). Only modify the drill-down section.**
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run ByEmployeeTab 2>&1 | tail -20</automated>
    <manual>Topic Breakdown heading and chart render in drill-down. Hours by Day chart is gone. Two charts side-by-side on desktop, stacked on mobile.</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Topic Breakdown chart renders with hours + percentage labels. Hours by Day chart removed. Side-by-side responsive layout with Hours by Client. Empty state handled. EDR-01 tests pass (Topic Breakdown heading, zero-hour filter, hours/percentage labels).</done>
</task>

</tasks>

<verification>
- `npm run test -- --run ByEmployeeTab` — EDR-01 tests (topic breakdown heading, zero-hour filter, hours+percentage labels) pass GREEN
- ByEmployeeTab.tsx has exactly 2 chart cards in drill-down (Topic Breakdown + Hours by Client)
- No "Hours by Day" heading or `hoursByDay` computation remains
- Chart grid uses `grid-cols-1 md:grid-cols-2` for responsive stacking
- Dynamic chart heights via inline `style={{ height }}` instead of fixed `h-64`
</verification>

<success_criteria>
- "Topic Breakdown" heading visible in drill-down view
- Topic bars show "TopicName  Xh (Y%)" labels
- Zero-hour topics not rendered
- Responsive side-by-side layout (Topic Breakdown left, Hours by Client right)
- Empty state shows message when no entries for period
- EDR-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-employee-drill-down-enhancements/04-01-SUMMARY.md`
</output>
