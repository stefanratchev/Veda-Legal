---
phase: 11-polish-interactivity
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/src/components/reports/DetailTab.tsx
  - app/src/components/reports/DetailTab.test.tsx
  - app/src/components/reports/charts/BarChart.tsx
  - app/src/components/reports/charts/BarChart.test.tsx
  - app/src/components/reports/charts/RevenueBarChart.tsx
  - app/src/components/reports/charts/RevenueBarChart.test.tsx
autonomous: true
requirements: [DTAB-02, CHRT-07]

must_haves:
  truths:
    - "User sees entry count and total hours between FilterBar and charts"
    - "Admin sees total revenue in the summary stats row"
    - "Non-admin does NOT see revenue in the summary stats row"
    - "Summary stats update when filters change (derived from filteredEntries)"
    - "User can click a chart bar to toggle that entity as a filter"
    - "Clicking the same bar again removes the filter"
    - "Clicking the 'Other' aggregated bar does nothing (no id)"
    - "Active/selected bars show full opacity, unselected bars dim to 0.25"
    - "Both charts in the same dimension (hours + revenue) share the same activeIds and click handler"
  artifacts:
    - path: "app/src/components/reports/DetailTab.tsx"
      provides: "Summary stats row, bar click toggle handlers, activeIds wiring to charts"
      contains: "summaryStats"
    - path: "app/src/components/reports/charts/BarChart.tsx"
      provides: "activeIds prop for visual bar dimming"
      contains: "activeIds"
    - path: "app/src/components/reports/charts/RevenueBarChart.tsx"
      provides: "activeIds prop for visual bar dimming"
      contains: "activeIds"
    - path: "app/src/components/reports/DetailTab.test.tsx"
      provides: "Tests for summary stats and bar click-to-filter"
    - path: "app/src/components/reports/charts/BarChart.test.tsx"
      provides: "Tests for activeIds fillOpacity behavior"
    - path: "app/src/components/reports/charts/RevenueBarChart.test.tsx"
      provides: "Tests for activeIds fillOpacity behavior"
  key_links:
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "app/src/components/reports/charts/BarChart.tsx"
      via: "activeIds prop and onBarClick callback"
      pattern: "activeIds=.*filters\\."
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "app/src/components/reports/charts/RevenueBarChart.tsx"
      via: "activeIds prop and onBarClick callback"
      pattern: "activeIds=.*filters\\."
    - from: "app/src/components/reports/DetailTab.tsx"
      to: "filteredEntries useMemo"
      via: "summaryStats derived from filteredEntries"
      pattern: "summaryStats.*useMemo.*filteredEntries"
---

<objective>
Add summary stats row (DTAB-02) and chart-click-to-filter interaction (CHRT-07) to the Detail tab.

Purpose: Complete the interactive analytics experience -- users get at-a-glance summary stats and can explore data by clicking chart bars to drive filters.
Output: Updated DetailTab with summary stats, updated BarChart/RevenueBarChart with activeIds visual feedback, and comprehensive tests for all new behavior.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-polish-interactivity/11-RESEARCH.md
@.planning/phases/10-detail-tab-assembly/10-01-SUMMARY.md
@app/src/components/reports/DetailTab.tsx
@app/src/components/reports/DetailTab.test.tsx
@app/src/components/reports/charts/BarChart.tsx
@app/src/components/reports/charts/RevenueBarChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for summary stats and bar click-to-filter</name>
  <files>
    app/src/components/reports/DetailTab.test.tsx
    app/src/components/reports/charts/BarChart.test.tsx
    app/src/components/reports/charts/RevenueBarChart.test.tsx
  </files>
  <action>
**DetailTab.test.tsx** -- Add two new `describe` blocks to the existing test file:

1. `describe("Summary Stats")`:
   - Test: "renders entry count and total hours" -- render with entries, assert text content includes the entry count (e.g., `4`) and total hours value (formatted via `formatHours`). Look for "Entries" label and "Hours" label.
   - Test: "renders total revenue for admin" -- render with `isAdmin={true}`, assert "Revenue" label is present and shows formatted currency for total of entries with non-null revenue.
   - Test: "does NOT render revenue for non-admin" -- render with `isAdmin={false}`, assert no "Revenue" label in the summary stats area.
   - Test: "updates when filter is applied" -- render, apply a filter (open Clients dropdown, click a checkbox), then verify the stats change (e.g., entry count decreases).

2. `describe("Chart Click-to-Filter")`:
   - Since Recharts is fully mocked in tests (BarChart renders as `<div data-testid="recharts-bar-chart" />`), we CANNOT test click interactions through DetailTab rendering. Instead, verify integration by checking that the BarChart and RevenueBarChart components receive `onBarClick` and `activeIds` props. To do this, spy on the BarChart and RevenueBarChart modules:
     - Update the existing mocks for `@/components/reports/charts/BarChart` and `@/components/reports/charts/RevenueBarChart` using `vi.mock()` to capture props passed to them.
     - Test: "passes onBarClick to BarChart components" -- render DetailTab, verify BarChart mock was called with `onBarClick` prop (function).
     - Test: "passes activeIds from filter state to charts" -- after simulating a filter selection via FilterBar interaction, verify the chart mock receives the matching `activeIds` Set.

**BarChart.test.tsx** -- Create a NEW test file. Since Recharts components are mocked in JSDOM, test the component by mocking recharts to capture Cell props:
   - Mock `recharts` same way as DetailTab.test.tsx but make `Bar` render its children so Cell props can be inspected.
   - Alternatively, test `prepareBarData` (already exported pure function) and test that the component passes correct `fillOpacity` to Cell based on `activeIds`:
     - Test: "renders all bars at 0.8 opacity when activeIds is undefined" -- render BarChart, inspect Cell elements for fillOpacity.
     - Test: "renders all bars at 0.8 opacity when activeIds is empty Set" -- same, with `activeIds={new Set()}`.
     - Test: "dims unselected bars to 0.25 when activeIds has entries" -- render with `activeIds={new Set(["id-1"])}`, verify bars with matching id get 0.8, others get 0.25.
     - Test: "calls onBarClick with id when bar is clicked" -- verify callback fires with correct id argument. (This tests existing behavior but serves as regression.)
   - Since Recharts renders SVG which JSDOM doesn't fully support, the practical approach is to mock recharts components to extract and verify props. Create the mocks carefully: make `Bar` call its `children` as a render prop or render `Cell` children directly so the test can inspect them. If that's too complex, test the pure logic: export a helper function `getBarOpacity(activeIds, itemId)` from BarChart.tsx and test that instead. Then verify integration via a simpler prop-passing test.
   - **Recommended approach**: Extract `getBarOpacity(activeIds: Set<string> | undefined, itemId: string | undefined): number` as an exported pure function in BarChart.tsx. Write unit tests for this function directly. This avoids fighting Recharts SVG rendering in JSDOM.

**RevenueBarChart.test.tsx** -- Create a NEW test file with parallel structure to BarChart.test.tsx:
   - Test: `getBarOpacity` with same cases as BarChart (function will be shared or duplicated).
   - Test: "calls onBarClick with id when bar is clicked" (regression).

All tests should FAIL at this point (RED phase).

**Important patterns:**
- Use `vi.hoisted()` and `vi.mock()` at the top of each new test file.
- Import after mocks.
- Use `Element.prototype.scrollIntoView = vi.fn()` in files that render components with dropdowns.
- Use ternary (not `&&`) for conditional rendering per Vercel React skill rules.
- Use `fireEvent` (not `userEvent` which is not installed).
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run DetailTab BarChart RevenueBarChart 2>&1 | tail -20</automated>
    <manual>Verify that new tests are RED (failing) while existing tests remain GREEN (passing)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>New test cases exist and fail because the features (summary stats, activeIds prop, onBarClick wiring, getBarOpacity helper) don't exist yet. Existing tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement summary stats, activeIds, and click-to-filter</name>
  <files>
    app/src/components/reports/DetailTab.tsx
    app/src/components/reports/charts/BarChart.tsx
    app/src/components/reports/charts/RevenueBarChart.tsx
  </files>
  <action>
**BarChart.tsx:**
1. Add `activeIds?: Set<string>` to `BarChartProps` interface.
2. Export a pure helper function:
   ```typescript
   export function getBarOpacity(activeIds: Set<string> | undefined, itemId: string | undefined): number {
     if (!activeIds || activeIds.size === 0) return 0.8;
     if (itemId != null && activeIds.has(itemId)) return 0.8;
     return 0.25;
   }
   ```
3. Update the `Cell` rendering in the `Bar` children to use `getBarOpacity`:
   ```tsx
   {chartData.map((item, index) => (
     <Cell
       key={`cell-${index}`}
       fill={BAR_COLORS[index % BAR_COLORS.length]}
       fillOpacity={getBarOpacity(activeIds, item.id)}
     />
   ))}
   ```
4. Accept `activeIds` in the destructured props.

**RevenueBarChart.tsx:**
1. Add `activeIds?: Set<string>` to `RevenueBarChartProps` interface.
2. Export the same `getBarOpacity` helper (or import from BarChart -- but to avoid circular deps, just duplicate the 4-line function and export it as `getRevenueBarOpacity` or reuse the same name).
3. Update Cell rendering to use `getBarOpacity(activeIds, item.id)` for `fillOpacity`.
4. Accept `activeIds` in the destructured props.

**DetailTab.tsx:**
1. Add `useCallback` to the import from React.
2. Add three toggle handlers using functional setState (stable references via `useCallback` with `[]` deps):
   ```typescript
   const handleClientBarClick = useCallback((id: string) => {
     setFilters(prev => {
       const next = new Set(prev.clientIds);
       if (next.has(id)) next.delete(id);
       else next.add(id);
       return { ...prev, clientIds: next };
     });
   }, []);

   const handleEmployeeBarClick = useCallback((id: string) => {
     setFilters(prev => {
       const next = new Set(prev.employeeIds);
       if (next.has(id)) next.delete(id);
       else next.add(id);
       return { ...prev, employeeIds: next };
     });
   }, []);

   const handleTopicBarClick = useCallback((id: string) => {
     setFilters(prev => {
       const next = new Set(prev.topicNames);
       if (next.has(id)) next.delete(id);
       else next.add(id);
       return { ...prev, topicNames: next };
     });
   }, []);
   ```
3. Add summary stats derivation (between `filteredEntries` and the aggregation useMemos):
   ```typescript
   const summaryStats = useMemo(() => {
     const entryCount = filteredEntries.length;
     const totalHours = filteredEntries.reduce((sum, e) => sum + e.hours, 0);
     const totalRevenue = filteredEntries.reduce((sum, e) => sum + (e.revenue ?? 0), 0);
     const hasRevenue = filteredEntries.some(e => e.revenue !== null);
     return { entryCount, totalHours, totalRevenue: hasRevenue ? totalRevenue : null };
   }, [filteredEntries]);
   ```
4. Render summary stats row between FilterBar and chart grid. Place it AFTER FilterBar and BEFORE the first chart row div. Use a compact inline row:
   ```tsx
   <div className="flex items-center gap-6 px-4 py-3 bg-[var(--bg-elevated)] border border-[var(--border-subtle)] rounded">
     <div>
       <span className="text-[10px] uppercase tracking-wider text-[var(--text-muted)]">Entries</span>
       <span className="ml-2 text-sm font-medium text-[var(--text-primary)]">{summaryStats.entryCount}</span>
     </div>
     <div className="w-px h-4 bg-[var(--border-subtle)]" />
     <div>
       <span className="text-[10px] uppercase tracking-wider text-[var(--text-muted)]">Hours</span>
       <span className="ml-2 text-sm font-medium text-[var(--text-primary)]">{formatHours(summaryStats.totalHours)}</span>
     </div>
     {isAdmin && summaryStats.totalRevenue !== null ? (
       <>
         <div className="w-px h-4 bg-[var(--border-subtle)]" />
         <div>
           <span className="text-[10px] uppercase tracking-wider text-[var(--text-muted)]">Revenue</span>
           <span className="ml-2 text-sm font-medium text-[var(--accent-pink)]">{formatCurrency(summaryStats.totalRevenue)}</span>
         </div>
       </>
     ) : null}
   </div>
   ```
   Note: Use ternary `? (...) : null` instead of `&&` per Vercel React rendering-conditional-render rule.
5. Wire `onBarClick` and `activeIds` to all six chart instances:
   - Client hours BarChart: `onBarClick={handleClientBarClick}` `activeIds={filters.clientIds}`
   - Client revenue RevenueBarChart: `onBarClick={handleClientBarClick}` `activeIds={filters.clientIds}`
   - Employee hours BarChart: `onBarClick={handleEmployeeBarClick}` `activeIds={filters.employeeIds}`
   - Employee revenue RevenueBarChart: `onBarClick={handleEmployeeBarClick}` `activeIds={filters.employeeIds}`
   - Topic hours BarChart: `onBarClick={handleTopicBarClick}` `activeIds={filters.topicNames}`
   - Topic revenue RevenueBarChart: `onBarClick={handleTopicBarClick}` `activeIds={filters.topicNames}`
6. Also add the summary stats row to the empty state branch (between FilterBar and the empty state message), so stats show "0" entries when filters produce no results. Use the same component/markup.

**Avoid:**
- Do NOT add `useCallback` deps for `filters` -- the functional `setFilters(prev => ...)` pattern avoids stale closure issues.
- Do NOT add separate chart selection state -- use `FilterState` directly as the single source of truth.
- Do NOT make "Other" bars clickable -- the existing `if (entry.id)` guard in both chart components already prevents this.
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run DetailTab BarChart RevenueBarChart 2>&1 | tail -30</automated>
    <manual>All new and existing tests pass (GREEN phase)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Summary stats row renders with entry count, total hours, and admin-only revenue. Chart bars are clickable to toggle filters. Active bars show full opacity (0.8), inactive bars dim (0.25). Both charts in a dimension share the same handler and activeIds. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: REFACTOR -- Clean up and run full test suite</name>
  <files>
    app/src/components/reports/DetailTab.tsx
    app/src/components/reports/charts/BarChart.tsx
    app/src/components/reports/charts/RevenueBarChart.tsx
  </files>
  <action>
1. Review all modified files for code quality:
   - Ensure no unused imports.
   - Ensure consistent formatting with existing codebase patterns.
   - Check that `getBarOpacity` is not duplicated unnecessarily -- if both BarChart and RevenueBarChart need it, consider exporting from BarChart and importing in RevenueBarChart, OR duplicating the small function in both files (simpler, avoids cross-component coupling). Prefer duplication for a 4-line function.
   - Verify summary stats row uses design system CSS variables correctly.
   - Verify all conditional rendering uses ternary per Vercel React skill rules.

2. Run the full test suite to verify zero regressions:
   ```bash
   npm run test -- --run
   ```

3. Run lint:
   ```bash
   npm run lint
   ```

4. If any tests fail or lint errors appear, fix them before committing.

5. Build to verify no TypeScript errors:
   ```bash
   npm run build
   ```
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run 2>&1 | tail -5 && npm run lint 2>&1 | tail -5</automated>
    <manual>Full test suite passes with zero regressions, lint is clean</manual>
    <sampling_rate>final task -- run full suite before commit</sampling_rate>
  </verify>
  <done>All tests pass (full suite), lint is clean, build succeeds. Code is clean with no duplication issues or unused imports.</done>
</task>

</tasks>

<verification>
1. `npm run test -- --run DetailTab` -- All DetailTab tests pass including new summary stats and chart interaction tests
2. `npm run test -- --run BarChart` -- BarChart activeIds/opacity tests pass
3. `npm run test -- --run RevenueBarChart` -- RevenueBarChart activeIds/opacity tests pass
4. `npm run test -- --run` -- Full suite passes with zero regressions
5. `npm run lint` -- No lint errors
6. `npm run build` -- TypeScript compiles, production build succeeds
</verification>

<success_criteria>
- Summary stats row visible between FilterBar and charts showing entry count and total hours
- Admin sees total revenue in summary stats; non-admin does not
- Summary stats update reactively when any filter changes
- Clicking a chart bar toggles that entity as a filter in FilterBar
- Clicking the same bar again removes the filter
- "Other" bar clicks are ignored (no id)
- Active bars render at 0.8 opacity; inactive bars dim to 0.25
- Both hours and revenue charts in the same dimension share handler and activeIds
- All new behavior covered by tests
- Full test suite green, lint clean, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-interactivity/11-01-SUMMARY.md`
</output>
