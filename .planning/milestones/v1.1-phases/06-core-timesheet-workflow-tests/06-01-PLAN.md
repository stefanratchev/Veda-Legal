---
phase: 06-core-timesheet-workflow-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/e2e/pages/timesheets.page.ts
  - app/e2e/helpers/api-factory.ts
autonomous: true
requirements: [REQ-11, REQ-12]

must_haves:
  truths:
    - "All spec files can import TimesheetsPage POM and call its methods to interact with the timesheets page"
    - "All spec files can import createEntryViaAPI to set up test data without UI interaction"
    - "POM encapsulates all dropdown interaction sequences (ClientSelect, TopicCascadeSelect, DurationPicker) so specs never handle raw locators for these"
  artifacts:
    - path: "app/e2e/pages/timesheets.page.ts"
      provides: "Page Object Model for timesheets page"
      exports: ["TimesheetsPage"]
      min_lines: 80
    - path: "app/e2e/helpers/api-factory.ts"
      provides: "API data factory for creating time entries"
      exports: ["createEntryViaAPI", "createRegularEntry", "createInternalEntry"]
      min_lines: 30
  key_links:
    - from: "app/e2e/pages/timesheets.page.ts"
      to: "data-testid attributes on production components"
      via: "page.getByTestId() locators"
      pattern: "getByTestId\\(.(client-select|topic-cascade-select|duration-picker|week-strip|submit-button)"
    - from: "app/e2e/helpers/api-factory.ts"
      to: "/api/timesheets"
      via: "page.request.post()"
      pattern: "page\\.request\\.post.*api/timesheets"
---

<objective>
Create the Page Object Model (POM) for the timesheets page and the API data factory for efficient test setup.

Purpose: These two files are the foundation for all Phase 6 spec tests. The POM encapsulates complex dropdown interactions (ClientSelect, TopicCascadeSelect, DurationPicker) and page navigation so specs stay readable. The API factory enables fast test data setup without going through the UI.

Output: `timesheets.page.ts` POM class + `api-factory.ts` helper functions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-timesheet-workflow-tests/06-RESEARCH.md
@.planning/phases/05-test-infrastructure/05-01-SUMMARY.md
@.planning/phases/05-test-infrastructure/05-02-SUMMARY.md
@app/e2e/helpers/seed-data.ts
@app/e2e/fixtures/test.ts
@app/e2e/specs/smoke.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TimesheetsPage Page Object Model</name>
  <files>app/e2e/pages/timesheets.page.ts</files>
  <action>
Create `app/e2e/pages/` directory and `timesheets.page.ts` with a `TimesheetsPage` class.

**Constructor:** Takes `page: Page` from Playwright. Initialize these locator properties:
- `clientSelect` = `page.getByTestId("client-select")`
- `topicSelect` = `page.getByTestId("topic-cascade-select")`
- `durationPicker` = `page.getByTestId("duration-picker")`
- `descriptionInput` = `page.getByPlaceholder("What did you work on?")`
- `submitButton` = `page.getByTestId("submit-button")`
- `weekStrip` = `page.getByTestId("week-strip")`
- `entriesTable` = `page.locator("tbody")`

**Navigation methods:**
- `goto()` - Navigate to `/timesheets` and assert URL contains `/timesheets`
- `clickDay(dayNumber: number)` - Click day in WeekStrip by text within the `week-strip` testid container, using `{ exact: true }` to avoid partial matches
- `clickPrevWeek()` - Click button with `title="Previous week"`
- `clickNextWeek()` - Click button with `title="Next week"`
- `clickToday()` - Click button with `role: button, name: "Today"`
- `waitForEntriesLoad()` - `page.waitForResponse(resp => resp.url().includes("/api/timesheets?date=") && resp.status() === 200)` - returns the response promise; callers should set this up BEFORE the action that triggers the fetch

**Dropdown interaction methods:**
- `selectClient(clientName: string)` - Click trigger button inside `client-select` div, then click text matching `clientName`
- `selectTopicAndSubtopic(topicName: string, subtopicName: string)` - Click trigger button inside `topic-cascade-select` div, click `topicName` to drill into subtopics, then click `subtopicName`. Note: after selecting a client, the topic select may auto-open via setTimeout. The method should handle both cases (already open or needs click).
- `selectTopicOnly(topicName: string)` - For internal/management topics with no subtopics. Click trigger, click `topicName` which selects directly (no drill-down).
- `selectDuration(hours: number, minutes: number)` - Click trigger button in `duration-picker` div. The dropdown renders via `createPortal` to `document.body`, so locate the hours/minutes buttons at page level. Wait for "Select hours" text to appear, then click the hour button, then the minutes button (formatted as 2-digit string like "00", "15", "30", "45"). Use scoped locators to avoid ambiguity -- the DurationPicker portal container is the key scope.
- `fillDescription(text: string)` - Fill the description input (clears existing text first)
- `appendDescription(text: string)` - For prefix subtopics: type additional text after the auto-filled prefix (use `pressSequentially` or `type` to append, not `fill` which clears)

**Compound methods:**
- `createEntry(params: { clientName: string; topicName: string; subtopicName?: string; hours: number; minutes: number; description: string })` - Calls selectClient, selectTopicAndSubtopic (or selectTopicOnly if no subtopicName), selectDuration, fillDescription, clickLog in sequence. After clickLog, wait for the POST response to complete using `page.waitForResponse('**/api/timesheets')`.
- `clickLog()` - Click the submit button (data-testid="submit-button")
- `clickSave()` - Same as clickLog (same button, different label in edit mode)

**Entry interaction methods:**
- `getEntryRows()` - Return `entriesTable.locator("tr")`
- `getEntryCount()` - Return count of table body rows
- `clickEditOnRow(rowIndex: number)` - Get nth row, click element with `title="Edit entry"`
- `clickDeleteOnRow(rowIndex: number)` - Get nth row, click element with `title="Delete entry"`
- `confirmDelete()` - Click button `role: button, name: "Delete"` in the ConfirmModal
- `cancelDelete()` - Click button `role: button, name: "Cancel"` in the ConfirmModal
- `clickCancel()` - Click Cancel button `role: button, name: "Cancel"` (for edit mode cancel)

**Submission methods:**
- `clickSubmitTimesheet()` - Click button matching `role: button, name: /Submit Timesheet/`
- `confirmSubmission()` - Click "Submit" button in ConfirmModal
- `dismissSubmission()` - Click "Not yet" button in ConfirmModal

**Important implementation notes:**
- Use ONLY Playwright locators: `getByTestId()`, `getByRole()`, `getByText()`, `getByTitle()`, `getByPlaceholder()`. Zero CSS class selectors.
- Zero `page.waitForTimeout()` calls. Use auto-waiting assertions and `waitForResponse()`.
- Export the class as a named export.
  </action>
  <verify>
    <automated>cd app && npx tsc --noEmit e2e/pages/timesheets.page.ts 2>&1 || echo "TypeScript check (may need config adjustment - verify manually that file has no syntax errors)"</automated>
    <manual>Verify file exists with all required methods: goto, selectClient, selectTopicAndSubtopic, selectTopicOnly, selectDuration, fillDescription, createEntry, getEntryRows, clickEditOnRow, clickDeleteOnRow, confirmDelete, cancelDelete, clickDay, clickPrevWeek, clickNextWeek, clickToday, clickSubmitTimesheet</manual>
  </verify>
  <done>TimesheetsPage POM class exported from app/e2e/pages/timesheets.page.ts with all methods listed in REQ-11 (createEntry, editEntry helpers, deleteEntry helpers, navigateToDate, submitDay, getEntryRows) plus dropdown interaction encapsulation</done>
</task>

<task type="auto">
  <name>Task 2: Create API data factory</name>
  <files>app/e2e/helpers/api-factory.ts</files>
  <action>
Create `app/e2e/helpers/api-factory.ts` with helper functions for creating time entries via the API.

**Import:** `Page` from `@playwright/test`, seed data constants from `./seed-data`

**Interface:** `CreateEntryOptions`
```typescript
interface CreateEntryOptions {
  date: string;        // YYYY-MM-DD
  clientId: string;
  subtopicId?: string | null;
  topicId?: string | null;
  hours: number;
  description: string;
}
```

**Core function:** `createEntryViaAPI(page: Page, options: CreateEntryOptions): Promise<{ id: string; hours: number; description: string }>`
- Uses `page.request.post("/api/timesheets", { data: options })`
- `page.request` inherits auth cookies from storageState automatically
- Assert `response.ok()` is truthy (throw if API returns error)
- Return parsed JSON response body

**Convenience functions:**
- `createRegularEntry(page: Page, date: string, hours: number = 1, description: string = "Test regular entry for e2e")` - Uses `CLIENTS.regular.id`, `SUBTOPICS.correspondence.id`, `TOPICS.corporate.id`
- `createInternalEntry(page: Page, date: string, hours: number = 1, description: string = "Internal admin work for e2e")` - Uses `CLIENTS.internal.id`, `TOPICS.firmAdmin.id`, `topicId` set, `subtopicId` null

**Helper:** `getToday(): string` - Returns today's date as `YYYY-MM-DD` string via `new Date().toISOString().split("T")[0]`

**Notes:**
- Import `expect` from `@playwright/test` for the ok() assertion
- Keep it simple -- these are test utilities, not production code
  </action>
  <verify>
    <automated>cd app && npx tsc --noEmit e2e/helpers/api-factory.ts 2>&1 || echo "TypeScript check (verify manually)"</automated>
    <manual>Verify file exports createEntryViaAPI, createRegularEntry, createInternalEntry, getToday</manual>
  </verify>
  <done>API data factory exported from app/e2e/helpers/api-factory.ts with createEntryViaAPI (generic), createRegularEntry (convenience), createInternalEntry (convenience), and getToday helper</done>
</task>

</tasks>

<verification>
1. `app/e2e/pages/timesheets.page.ts` exists and exports `TimesheetsPage` class
2. `app/e2e/helpers/api-factory.ts` exists and exports `createEntryViaAPI`, `createRegularEntry`, `createInternalEntry`, `getToday`
3. Both files compile without TypeScript errors
4. Existing smoke test still passes: `cd app && npx playwright test smoke`
</verification>

<success_criteria>
- TimesheetsPage POM has all methods needed by Plans 02 and 03 (create entry, edit helpers, delete helpers, navigation, submission)
- API factory creates entries via POST /api/timesheets using page.request (inheriting auth cookies)
- No CSS class selectors in POM -- only Playwright locators (getByTestId, getByRole, getByText, getByTitle, getByPlaceholder)
- No page.waitForTimeout() calls -- only auto-waiting assertions and waitForResponse()
- Smoke test remains green
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-timesheet-workflow-tests/06-01-SUMMARY.md`
</output>
