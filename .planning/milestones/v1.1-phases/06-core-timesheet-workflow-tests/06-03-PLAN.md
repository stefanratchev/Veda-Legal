---
phase: 06-core-timesheet-workflow-tests
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - app/e2e/specs/navigation.spec.ts
  - app/e2e/specs/submission.spec.ts
autonomous: true
requirements: [REQ-19, REQ-20, REQ-21, REQ-22, REQ-23, REQ-24]

must_haves:
  truths:
    - "Clicking a day in WeekStrip loads that day's entries"
    - "Prev/next week arrows shift the displayed week"
    - "Today button returns to the current day"
    - "An entry created on day A persists when navigating away and back"
    - "A user can submit a timesheet after logging 8+ hours and see the submitted indicator"
    - "A submit prompt modal auto-appears when creating an entry that crosses the 8-hour threshold"
  artifacts:
    - path: "app/e2e/specs/navigation.spec.ts"
      provides: "E2E tests for WeekStrip date navigation and entry persistence"
      contains: "test.describe"
      min_lines: 60
    - path: "app/e2e/specs/submission.spec.ts"
      provides: "E2E tests for daily submission flow and auto-prompt"
      contains: "test.describe"
      min_lines: 40
  key_links:
    - from: "app/e2e/specs/navigation.spec.ts"
      to: "app/e2e/pages/timesheets.page.ts"
      via: "import TimesheetsPage"
      pattern: "import.*TimesheetsPage.*from.*pages/timesheets.page"
    - from: "app/e2e/specs/navigation.spec.ts"
      to: "app/e2e/helpers/api-factory.ts"
      via: "import createRegularEntry, getToday"
      pattern: "import.*create.*Entry.*from.*helpers/api-factory"
    - from: "app/e2e/specs/submission.spec.ts"
      to: "app/e2e/helpers/api-factory.ts"
      via: "import createRegularEntry for 8h setup"
      pattern: "import.*create.*Entry.*from.*helpers/api-factory"
---

<objective>
Create navigation.spec.ts (WeekStrip tests) and submission.spec.ts (daily submission tests) -- the remaining two spec files.

Purpose: Navigation tests validate that users can move between days and weeks, and that entries are correctly scoped to their date. Submission tests validate the daily timesheet submission flow and the auto-prompt modal at 8 hours.

Output: `navigation.spec.ts` (~4 tests) + `submission.spec.ts` (~3 tests)
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-timesheet-workflow-tests/06-RESEARCH.md
@.planning/phases/06-core-timesheet-workflow-tests/06-01-SUMMARY.md
@app/e2e/helpers/seed-data.ts
@app/e2e/pages/timesheets.page.ts
@app/e2e/helpers/api-factory.ts
@app/e2e/fixtures/test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeekStrip navigation spec</name>
  <files>app/e2e/specs/navigation.spec.ts</files>
  <action>
Create `app/e2e/specs/navigation.spec.ts`. Import `{ test, expect }` from `../fixtures/test`, `TimesheetsPage` from `../pages/timesheets.page`, `{ createRegularEntry, getToday }` from `../helpers/api-factory`.

**Top-level describe:** `"WeekStrip Navigation"`

**beforeEach:** Create `TimesheetsPage` instance, call `timesheets.goto()`.

**Test 1 - REQ-19: "selects a specific day and entries reload"**
1. Create an entry via API factory for today: `createRegularEntry(page, getToday(), 1, "Entry for today's date")`
2. Navigate to the page: `timesheets.goto()`
3. Assert entry is visible: `expect(page.getByText("Entry for today's date")).toBeVisible()`
4. Click a different day in the WeekStrip (e.g., compute yesterday or a different day of the current week). Set up `waitForResponse` BEFORE clicking.
5. After navigation completes, assert that today's entry is NOT visible (that day has no entries): `expect(page.getByText("Entry for today's date")).not.toBeVisible()`
6. Navigate back to today: set up `waitForResponse`, click today's day number
7. Assert entry is visible again

**Approach for day selection:** Get today's date (day of month number), then compute a different day within the same week. Use `new Date()` in the test to determine which day to click. If today is Monday, click Tuesday; if today is Sunday, click Saturday -- any different day within the week works.

**Test 2 - REQ-20: "prev/next week arrows shift the week"**
1. Note the current week's day numbers displayed in WeekStrip (read the visible day button text values)
2. Click next week: `timesheets.clickNextWeek()`
3. Verify the displayed days have changed (the day numbers should be ~7 days later)
4. Click prev week: `timesheets.clickPrevWeek()`
5. Verify original day numbers are back

**Practical approach:** Read a specific day element's text content before and after clicking next/prev. For example, check that the Monday date number changes after clicking next week.

**Test 3 - REQ-21: "Today button returns to current day"**
1. Navigate to a different week: `timesheets.clickNextWeek()`
2. Verify we're on a different week (today's date not highlighted or visible)
3. Click Today: `timesheets.clickToday()`
4. Set up `waitForResponse` before clicking Today
5. Verify we're back on today's date -- check that the currently selected day matches today's date number

**Test 4 - REQ-22: "entry persists when navigating away and back"**
1. Create entry via API for today
2. Navigate to page, verify entry visible
3. Navigate to different day (click another day in WeekStrip), wait for response
4. Verify entry not visible on different day
5. Navigate back to today, wait for response
6. Verify entry is visible again (persisted correctly)

**Important implementation notes:**
- Set up `page.waitForResponse()` BEFORE clicking day buttons -- assign the promise, then click, then await. This prevents race conditions (see Pitfall 7 from research).
- Use `{ exact: true }` for day number text matching to avoid partial matches.
- Don't hardcode specific dates -- work relative to "today" using `new Date()` in the test.
- Use `toBeVisible()` / `not.toBeVisible()` auto-waiting assertions.

After writing all tests, run: `cd app && npx playwright test navigation` to verify all 4 pass.

If locator issues arise with WeekStrip day selection, debug by checking what text/attributes the day buttons actually render, and adjust the POM method accordingly.
  </action>
  <verify>
    <automated>cd app && npx playwright test navigation 2>&1 | tail -20</automated>
    <manual>All 4 navigation tests pass</manual>
  </verify>
  <done>Four navigation tests pass: select day with entries reload (REQ-19), prev/next week arrows (REQ-20), Today button (REQ-21), entry persistence across navigation (REQ-22)</done>
</task>

<task type="auto">
  <name>Task 2: Create daily submission spec</name>
  <files>app/e2e/specs/submission.spec.ts</files>
  <action>
Create `app/e2e/specs/submission.spec.ts`. Import `{ test, expect }` from `../fixtures/test`, `TimesheetsPage` from `../pages/timesheets.page`, `{ createRegularEntry, createInternalEntry, getToday }` from `../helpers/api-factory`.

**Top-level describe:** `"Daily Submission"`

**beforeEach:** Create `TimesheetsPage` instance.

**Test 1 - REQ-23: "submits timesheet after 8+ hours"**
1. Create entries via API factory totaling 8+ hours for today:
   - `createRegularEntry(page, getToday(), 4, "Morning client correspondence work")`
   - `createRegularEntry(page, getToday(), 3, "Afternoon contract review tasks")`
   - `createInternalEntry(page, getToday(), 2, "Internal team admin and sync")`
   (Total: 9 hours -- safely above 8h threshold)
2. Navigate to timesheets page: `timesheets.goto()`
3. Verify entries are visible (at least one entry description should appear)
4. Verify "Submit Timesheet" button is visible (appears when >= 8h and not yet submitted)
5. Click submit timesheet: `timesheets.clickSubmitTimesheet()`
6. ConfirmModal should appear asking to confirm submission
7. Confirm submission: `timesheets.confirmSubmission()`
8. Wait for POST response to `/api/timesheets/submit`
9. Assert submission indicator visible: `expect(page.getByText("Timesheet Submitted")).toBeVisible()`

**Test 2 - REQ-24: "auto-prompt modal appears at 8h threshold"**
1. Create entries via API factory totaling ~7 hours for today:
   - `createRegularEntry(page, getToday(), 4, "First block of client work")`
   - `createRegularEntry(page, getToday(), 3, "Second block of client work")`
   (Total: 7 hours -- just below threshold)
2. Navigate to timesheets page: `timesheets.goto()`
3. Verify entries loaded (check that at least one entry text is visible)
4. Now create a 1.5h entry through the UI to cross the 8h threshold:
   - `timesheets.selectClient(CLIENTS.regular.name)`
   - `timesheets.selectTopicAndSubtopic(TOPICS.corporate.name, SUBTOPICS.correspondence.name)`
   - `timesheets.fillDescription("Client correspondence: pushing over 8 hours")`
   - `timesheets.selectDuration(1, 30)`
   - `timesheets.clickLog()`
5. Wait for POST response
6. The submit prompt modal should auto-appear since total hours now exceed 8h
7. Assert the modal is visible: `expect(page.getByText(/Submit Timesheet/)).toBeVisible()` (check for the modal title/heading)
8. Dismiss the modal: `timesheets.dismissSubmission()` (click "Not yet")
9. Assert modal is gone

**Test 3 (optional, if context allows) - Submission revocation:**
This is NOT in requirements, skip it. Stick to REQ-23 and REQ-24 only.

**Important implementation notes:**
- REQ-23: After creating entries via API, `page.goto('/timesheets')` fetches totalHours from the server, so the Submit button should appear correctly.
- REQ-24: The auto-prompt relies on client-side totalHours state. After page.goto, the server provides totalHours in the GET response. When the UI creates a new entry, the client-side code adds to totalHours. If it crosses MIN_SUBMISSION_HOURS (8), the modal auto-appears. The key is: create 7h via API -> goto page (server returns totalHours=7) -> create 1.5h via UI (client adds to 8.5h) -> modal appears.
- Use `page.waitForResponse()` for API calls before making assertions.
- The "Not yet" button text is the dismiss option in the submission ConfirmModal. If the actual text differs, adjust -- check the ConfirmModal component's cancel label for submission context.

After writing both tests, run: `cd app && npx playwright test submission` to verify both pass.

Then run the full suite: `cd app && npm run test:e2e` to verify all tests pass together (smoke + entry-crud + navigation + submission).
  </action>
  <verify>
    <automated>cd app && npx playwright test submission 2>&1 | tail -20</automated>
    <manual>Both submission tests pass, then full suite: cd app && npm run test:e2e passes all tests</manual>
    <sampling_rate>After this task, run full suite: cd app && npm run test:e2e</sampling_rate>
  </verify>
  <done>Two submission tests pass: submit timesheet with status indicator (REQ-23) and auto-prompt modal at 8h threshold (REQ-24). Full suite (smoke + entry-crud + navigation + submission) is green.</done>
</task>

</tasks>

<verification>
1. `cd app && npx playwright test navigation` -- all 4 tests pass
2. `cd app && npx playwright test submission` -- both tests pass
3. `cd app && npm run test:e2e` -- full suite green (smoke + entry-crud + navigation + submission, ~12-15 tests total)
4. No `page.waitForTimeout()` in any spec file
5. No CSS class selectors in any spec file
6. Navigation tests work relative to "today" (no hardcoded dates)
7. Submission auto-prompt test creates entries via API + one via UI to cross threshold
</verification>

<success_criteria>
- navigation.spec.ts has 4 passing tests: day select (REQ-19), prev/next week (REQ-20), Today button (REQ-21), persistence (REQ-22)
- submission.spec.ts has 2 passing tests: submit flow (REQ-23), auto-prompt modal (REQ-24)
- Full e2e suite passes: `npm run test:e2e` shows all tests green
- ~12-15 total e2e tests across all spec files
- Zero page.waitForTimeout() calls across all spec files
- Zero CSS class selectors across all spec files
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-timesheet-workflow-tests/06-03-SUMMARY.md`
</output>
