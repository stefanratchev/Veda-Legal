---
phase: 02-overview-revenue-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/app/globals.css
  - app/src/components/reports/charts/RevenueBarChart.tsx
  - app/src/components/reports/charts/RevenueBarChart.test.tsx
autonomous: true
requirements: [REV-01, REV-02]

must_haves:
  truths:
    - "RevenueBarChart renders a vertical bar chart with EUR-formatted axis labels"
    - "Top 10 items shown by revenue, remainder grouped as 'Other'"
    - "Per-bar % change badges appear when comparison data is provided"
    - "No badge on 'Other' bar or items without comparison match"
    - "Tooltip shows exact EUR amount + % change (e.g., EUR 12,450 (+22%))"
    - "Empty data shows a 'No revenue data' message"
    - "Revenue color is a distinct teal, not coral pink"
  artifacts:
    - path: "app/src/components/reports/charts/RevenueBarChart.tsx"
      provides: "Reusable vertical bar chart for EUR revenue with comparison badges"
      min_lines: 80
    - path: "app/src/components/reports/charts/RevenueBarChart.test.tsx"
      provides: "Unit tests for data transformation, formatting, and rendering"
      min_lines: 60
    - path: "app/src/app/globals.css"
      provides: "--accent-revenue CSS variable"
      contains: "--accent-revenue"
  key_links:
    - from: "RevenueBarChart.tsx"
      to: "recharts"
      via: "BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LabelList, Cell"
      pattern: "import.*from.*recharts"
    - from: "RevenueBarChart.tsx"
      to: "globals.css"
      via: "CSS variable reference"
      pattern: "var\\(--accent-revenue\\)"
---

<objective>
Create the RevenueBarChart component -- a standalone vertical bar chart for EUR revenue data with top-10 grouping, abbreviated EUR labels, per-bar comparison % change badges, and custom tooltip. Also add the `--accent-revenue` CSS variable to the design system.

Purpose: This component is used by both Revenue by Client and Revenue by Employee charts in the overview tab (Plan 02). Building it standalone first enables focused testing of data transformation logic, EUR formatting, and comparison badge rendering.

Output: `RevenueBarChart.tsx`, `RevenueBarChart.test.tsx`, updated `globals.css`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-overview-revenue-charts/02-CONTEXT.md
@.planning/phases/02-overview-revenue-charts/02-RESEARCH.md
@app/src/components/reports/charts/BarChart.tsx
@app/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --accent-revenue CSS variable and create RevenueBarChart component</name>
  <files>
    app/src/app/globals.css
    app/src/components/reports/charts/RevenueBarChart.tsx
  </files>
  <action>
1. In `globals.css`, add a revenue accent color to the `:root` block (alongside the existing Brand Accent section):
   ```
   --accent-revenue: #4ECDC4;
   --accent-revenue-dim: #3BA89F;
   ```
   Also add corresponding Tailwind theme entries in the `@theme inline` block:
   ```
   --color-accent-revenue: var(--accent-revenue);
   --color-accent-revenue-dim: var(--accent-revenue-dim);
   ```

2. Create `app/src/components/reports/charts/RevenueBarChart.tsx` as a "use client" component with the following:

   **Props interface:**
   ```typescript
   interface RevenueBarChartProps {
     data: { name: string; value: number; id?: string }[];
     comparisonData?: { name: string; value: number; id?: string }[];
     onBarClick?: (id: string) => void;
     maxBars?: number; // default 10
   }
   ```

   **Data transformation (exported for testing):**
   - Export a `prepareRevenueData` function that: filters out items with value <= 0, sorts descending by value, takes top N (maxBars), aggregates the rest as "Other" (no id on "Other").
   - Export a `mergeComparisonData` function that: takes prepared current data and raw comparison data, matches by `id` using a Map for O(1) lookup, computes `percentChange = ((current - previous) / previous) * 100`, returns data array with `percentChange` field (null for "Other" and unmatched items).

   **EUR formatters (exported for testing):**
   - `formatEurAbbreviated(value: number): string` -- EUR 12.5K, EUR 1.2M, EUR 850. Use euro sign directly. Trim trailing ".0" from K and M values.
   - `formatEurExact(value: number): string` -- Use `Intl.NumberFormat("en-GB", { style: "currency", currency: "EUR", minimumFractionDigits: 0, maximumFractionDigits: 0 })`.

   **Chart rendering:**
   - Use Recharts `BarChart` (NOT layout="vertical" -- this is a standard vertical bar chart where bars go up, X axis has names, Y axis has EUR values). This is DISTINCT from the existing hours `BarChart` which uses `layout="vertical"` for horizontal bars.
   - XAxis: `dataKey="name"`, tick style matching existing charts (`fill: "var(--text-muted)", fontSize: 11`), angled labels if needed (`angle={-35}, textAnchor="end"`) for long client names, `height={60}` to accommodate angled labels.
   - YAxis: `tickFormatter={formatEurAbbreviated}`, matching tick style.
   - Tooltip: Custom `content` prop using a `RevenueTooltip` component. Shows item name on first line, then exact EUR + % change on second line. Format: "EUR 12,450 (+22%)" or just "EUR 12,450" when no comparison. Style matches existing tooltip (bg-elevated, border-subtle, 4px radius).
   - Bar: `dataKey="value"`, `fill="var(--accent-revenue)"`, `fillOpacity={0.8}`, `radius={[4, 4, 0, 0]}` (rounded top corners only for vertical bars), cursor pointer if `onBarClick` provided.
   - Cell: Individual cells like existing BarChart pattern.
   - LabelList: `dataKey="percentChange"`, `position="top"`, custom `content` renderer. Render % change text above each bar. Green (`var(--success)`) for positive, red (`var(--danger)`) for negative. Format: "+22%" or "-8%". Don't render if `percentChange` is null/undefined.
   - Empty state: If data is empty after filtering, show "No revenue data" centered, matching existing BarChart empty state style.

   **Performance:** Use `useMemo` for data transformation results (prepareRevenueData and mergeComparisonData calls) to avoid recreating arrays on every render per research Pitfall 6. Import useMemo from React.

   **Click handling:** On bar click, call `onBarClick(id)` for items with an id. Do not call for "Other" (no id).
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit src/components/reports/charts/RevenueBarChart.tsx 2>&1 | head -20</automated>
    <manual>Check that the component compiles without TypeScript errors</manual>
  </verify>
  <done>RevenueBarChart.tsx exists with exported component, data transformation utilities, and EUR formatters. globals.css has --accent-revenue variable. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Write unit tests for RevenueBarChart</name>
  <files>
    app/src/components/reports/charts/RevenueBarChart.test.tsx
  </files>
  <action>
Create `app/src/components/reports/charts/RevenueBarChart.test.tsx` with the following test groups. Use Vitest + React Testing Library. Import the exported utility functions directly for pure function tests.

**Test group 1: formatEurAbbreviated**
- 0 returns "EUR 0" (or "EUR 0" equivalent)
- 100 returns "EUR 100"
- 999 returns "EUR 999"
- 1000 returns "EUR 1K" (not "EUR 1.0K")
- 1500 returns "EUR 1.5K"
- 12500 returns "EUR 12.5K"
- 999999 returns "EUR 1000K" (boundary)
- 1000000 returns "EUR 1M" (not "EUR 1.0M")
- 1200000 returns "EUR 1.2M"

**Test group 2: formatEurExact**
- 0 returns "EUR 0" (verify includes euro sign)
- 12450 returns "EUR 12,450" (verify comma grouping)
- 1234567 returns "EUR 1,234,567"

**Test group 3: prepareRevenueData**
- Empty array returns empty array
- Filters out items with value 0 or negative
- Sorts by value descending
- Returns top 10 when more than 10 items
- Aggregates items beyond top 10 into "Other" with summed value
- "Other" has no `id` field
- Fewer than 10 items returns all (no "Other")

**Test group 4: mergeComparisonData**
- Returns data with null percentChange when no comparison data
- Computes correct positive % change (current 120, previous 100 -> +20%)
- Computes correct negative % change (current 80, previous 100 -> -20%)
- Items with no match in comparison get null percentChange
- "Other" item (no id) gets null percentChange
- Items with 0 in comparison period get null percentChange (avoid division by zero)

**Test group 5: Component rendering**
- Renders "No revenue data" when data is empty
- Renders Recharts BarChart when data provided (check for SVG elements)
- Calls onBarClick with id when bar is clicked (use fireEvent)
- Does not crash when comparisonData is undefined

Note: Recharts renders SVGs in jsdom. Test for presence of expected elements and text content rather than pixel-perfect layout. Use `@testing-library/react` `render` and `screen`. Use `fireEvent` (not userEvent, which is not installed).
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run RevenueBarChart 2>&1 | tail -30</automated>
    <manual>All tests pass</manual>
  </verify>
  <done>RevenueBarChart.test.tsx exists with tests covering EUR formatting, data transformation (top-10 + Other), comparison badge computation, empty state rendering, and bar click handling. All tests pass.</done>
</task>

</tasks>

<verification>
- `cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test -- --run RevenueBarChart` -- all tests pass
- `cd /Users/stefan/projects/veda-legal-timesheets/app && npx tsc --noEmit` -- no new TypeScript errors
- `globals.css` contains `--accent-revenue: #4ECDC4`
- `RevenueBarChart.tsx` exports: `RevenueBarChart`, `prepareRevenueData`, `mergeComparisonData`, `formatEurAbbreviated`, `formatEurExact`
</verification>

<success_criteria>
- RevenueBarChart component renders a vertical bar chart with teal bars, EUR-abbreviated Y axis, custom tooltip, and per-bar % change badges
- Data transformation correctly handles top-10 grouping with "Other" aggregation
- EUR formatting works for values from 0 to millions
- Comparison badge logic handles all edge cases (no match, zero previous, "Other")
- All unit tests pass
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/02-overview-revenue-charts/02-01-SUMMARY.md`
</output>
