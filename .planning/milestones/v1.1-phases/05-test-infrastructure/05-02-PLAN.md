---
phase: 05-test-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - app/src/components/ui/ClientSelect.tsx
  - app/src/components/ui/TopicCascadeSelect.tsx
  - app/src/components/ui/DurationPicker.tsx
  - app/src/components/timesheets/EntryCard.tsx
  - app/src/components/timesheets/WeekStrip.tsx
  - app/src/components/timesheets/EntryForm.tsx
  - app/e2e/specs/smoke.spec.ts
autonomous: true
requirements:
  - REQ-06
  - REQ-10

must_haves:
  truths:
    - "The smoke test navigates to /timesheets and sees the timesheets page (not a redirect to /login)"
    - "Key UI components have data-testid attributes usable as Playwright locators"
    - "The timesheets page renders ClientSelect, TopicCascadeSelect, and DurationPicker with seed data visible in dropdowns"
    - "Running the smoke test twice in sequence produces the same result (no state leakage)"
  artifacts:
    - path: "app/e2e/specs/smoke.spec.ts"
      provides: "Smoke test proving auth bypass, seed data, and data-testid work"
      contains: "getByTestId"
    - path: "app/src/components/ui/ClientSelect.tsx"
      provides: "data-testid='client-select' on outermost element"
      contains: "data-testid"
    - path: "app/src/components/ui/TopicCascadeSelect.tsx"
      provides: "data-testid='topic-cascade-select' on outermost element"
      contains: "data-testid"
    - path: "app/src/components/ui/DurationPicker.tsx"
      provides: "data-testid='duration-picker' on outermost element"
      contains: "data-testid"
    - path: "app/src/components/timesheets/EntryCard.tsx"
      provides: "data-testid='entry-card' on outermost element"
      contains: "data-testid"
    - path: "app/src/components/timesheets/WeekStrip.tsx"
      provides: "data-testid='week-strip' on outermost element"
      contains: "data-testid"
    - path: "app/src/components/timesheets/EntryForm.tsx"
      provides: "data-testid='submit-button' on submit button(s)"
      contains: "data-testid"
  key_links:
    - from: "app/e2e/specs/smoke.spec.ts"
      to: "app/e2e/fixtures/test.ts"
      via: "import { test, expect }"
      pattern: "from.*fixtures/test"
    - from: "app/e2e/specs/smoke.spec.ts"
      to: "app/src/components/ui/ClientSelect.tsx"
      via: "getByTestId('client-select')"
      pattern: "client-select"
    - from: "app/e2e/specs/smoke.spec.ts"
      to: "app/e2e/helpers/seed-data.ts"
      via: "references seed data names for assertions"
      pattern: "Balkanova"
---

<objective>
Add data-testid attributes to 6 key production components and write a smoke test that proves the entire test infrastructure works: auth bypass, test database seeding, DB fixture cleanup, and Playwright locators.

Purpose: This is the proof-of-life for Phase 5. The smoke test is the phase's primary deliverable — if it passes, all infrastructure from Plan 01 is validated. If it fails, it pinpoints exactly which layer broke (auth redirect = JWT issue, missing elements = data-testid issue, empty dropdowns = seed data issue).
Output: data-testid attributes on 6 components, passing smoke test.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-test-infrastructure/GOAL.md
@.planning/phases/05-test-infrastructure/05-CONTEXT.md
@.planning/phases/05-test-infrastructure/05-RESEARCH.md
@.planning/phases/05-test-infrastructure/05-01-SUMMARY.md
@app/src/components/ui/ClientSelect.tsx
@app/src/components/ui/TopicCascadeSelect.tsx
@app/src/components/ui/DurationPicker.tsx
@app/src/components/timesheets/EntryCard.tsx
@app/src/components/timesheets/WeekStrip.tsx
@app/src/components/timesheets/EntryForm.tsx
@app/e2e/helpers/seed-data.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-testid attributes to 6 key production components</name>
  <files>
    app/src/components/ui/ClientSelect.tsx
    app/src/components/ui/TopicCascadeSelect.tsx
    app/src/components/ui/DurationPicker.tsx
    app/src/components/timesheets/EntryCard.tsx
    app/src/components/timesheets/WeekStrip.tsx
    app/src/components/timesheets/EntryForm.tsx
  </files>
  <action>
Add `data-testid` attributes to the outermost element of each component. Use kebab-case names matching component names per user decision.

1. **ClientSelect.tsx** — Add `data-testid="client-select"` to the outermost `<div>` (the one with `ref={dropdownRef}`):
   ```tsx
   <div ref={dropdownRef} className={...} data-testid="client-select">
   ```

2. **TopicCascadeSelect.tsx** — Add `data-testid="topic-cascade-select"` to the outermost `<div>`:
   ```tsx
   <div ref={dropdownRef} className={...} data-testid="topic-cascade-select">
   ```

3. **DurationPicker.tsx** — Add `data-testid="duration-picker"` to the outermost `<div>`:
   ```tsx
   <div className={...} data-testid="duration-picker">
   ```

4. **EntryCard.tsx** — Add `data-testid="entry-card"` to the outermost `<div>`:
   ```tsx
   <div className="bg-[var(--bg-surface)] rounded-lg p-3" data-testid="entry-card">
   ```

5. **WeekStrip.tsx** — Add `data-testid="week-strip"` to the outermost `<div>`:
   ```tsx
   <div className="bg-[var(--bg-elevated)] ..." data-testid="week-strip">
   ```

6. **EntryForm.tsx** — Add `data-testid="submit-button"` to the submit button(s). There may be two (mobile and desktop, controlled by responsive classes). Both get the same testid since only one is visible at a time:
   ```tsx
   <button onClick={onSubmit} ... data-testid="submit-button">
   ```

**Rules:**
- Add ONLY the `data-testid` attribute — do not modify any other attributes, classes, or logic
- Verify no existing `data-testid` attributes exist on these components (research confirmed zero exist)
- Run `npm run lint` after changes to ensure no lint errors introduced
- Run `npm run test -- --run` to ensure existing unit tests still pass
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && grep -l 'data-testid="client-select"' src/components/ui/ClientSelect.tsx && grep -l 'data-testid="topic-cascade-select"' src/components/ui/TopicCascadeSelect.tsx && grep -l 'data-testid="duration-picker"' src/components/ui/DurationPicker.tsx && grep -l 'data-testid="entry-card"' src/components/timesheets/EntryCard.tsx && grep -l 'data-testid="week-strip"' src/components/timesheets/WeekStrip.tsx && grep -l 'data-testid="submit-button"' src/components/timesheets/EntryForm.tsx && npm run test -- --run 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All 6 components have the correct data-testid attribute on their outermost element (or submit button for EntryForm)
    - Existing unit tests still pass
    - No lint errors introduced
  </done>
</task>

<task type="auto">
  <name>Task 2: Write smoke test and verify full infrastructure</name>
  <files>
    app/e2e/specs/smoke.spec.ts
  </files>
  <action>
1. **Pre-requisite check:** Before writing the test, verify the test database exists:
   ```bash
   psql -lqt | grep veda_legal_test
   ```
   If it doesn't exist, create it:
   ```bash
   createdb veda_legal_test
   ```
   Then apply migrations:
   ```bash
   cd app && DATABASE_URL=postgresql://localhost:5432/veda_legal_test npm run db:migrate
   ```

2. Create `app/e2e/specs/smoke.spec.ts`:
   ```typescript
   import { test, expect } from "../fixtures/test";

   test.describe("Smoke Test", () => {
     test("loads timesheets page without redirect to /login", async ({ page }) => {
       await page.goto("/timesheets");

       // Should NOT be redirected to /login — proves JWT auth bypass works
       await expect(page).not.toHaveURL(/\/login/);
       await expect(page).toHaveURL(/\/timesheets/);

       // Key UI components should be visible — proves data-testid attributes work
       await expect(page.getByTestId("client-select")).toBeVisible();
       await expect(page.getByTestId("topic-cascade-select")).toBeVisible();
       await expect(page.getByTestId("duration-picker")).toBeVisible();
       await expect(page.getByTestId("week-strip")).toBeVisible();
     });

     test("dropdowns contain seed data", async ({ page }) => {
       await page.goto("/timesheets");

       // Open client dropdown and verify seed clients are present
       // This proves test database seeding works
       await page.getByTestId("client-select").click();
       await expect(page.getByText("Balkanova Industries")).toBeVisible();
       // Note: Internal client may or may not appear depending on the ClientSelect filter
       // (INTERNAL clients might be filtered based on client type). If so, just verify
       // the REGULAR client is visible. Adjust assertion based on actual dropdown behavior.
     });
   });
   ```

3. **Run the smoke test:**
   ```bash
   cd app && npm run test:e2e
   ```
   This should:
   - Load `.env.test` and connect to `veda_legal_test`
   - Run `globalSetup` to seed reference data
   - Run the `setup` project to generate auth storageState
   - Start the dev server on port 3001 (or reuse existing)
   - Run the smoke test in Chromium
   - Both tests should pass

4. **Verify idempotency — run it a second time:**
   ```bash
   cd app && npm run test:e2e
   ```
   Same result expected. The UPSERT in globalSetup and TRUNCATE in db fixture ensure no state leakage.

5. **If the smoke test fails**, debug based on the failure mode:
   - **Redirected to /login:** JWT cookie issue — check salt, cookie name, NEXTAUTH_SECRET match
   - **Components not visible:** data-testid missing or wrong — check component files
   - **Seed data not in dropdown:** globalSetup failed — check column names in INSERT statements match actual DB schema
   - **Timeout:** Dev server didn't start — check port 3001, DATABASE_URL propagation

6. **Adjust the test as needed** based on actual UI behavior. The research-provided assertions are best-effort; the actual component behavior (e.g., whether the client dropdown requires clicking a specific trigger element, or whether internal clients are filtered from the dropdown) may require locator adjustments. Use Playwright's `--ui` mode to debug:
   ```bash
   cd app && npm run test:e2e:ui
   ```
  </action>
  <verify>
    <automated>cd /Users/stefan/projects/veda-legal-timesheets/app && npm run test:e2e 2>&1 | tail -20</automated>
    <manual>Run `npm run test:e2e` twice in sequence to verify idempotent results (same pass/fail for both runs)</manual>
    <sampling_rate>Run after this task commits. This is the phase-complete gate.</sampling_rate>
  </verify>
  <done>
    - `e2e/specs/smoke.spec.ts` exists and imports from `../fixtures/test`
    - `npm run test:e2e` runs and the smoke test passes (navigates to /timesheets, sees components, verifies seed data)
    - Running the test twice produces the same passing result
    - The test database `veda_legal_test` exists with migrations applied and seed data present
  </done>
</task>

</tasks>

<verification>
Phase 5 is complete when ALL of the following are true:
1. `cd app && npm run test:e2e` passes with 2 passing tests
2. The output shows: setup project ran, chromium project ran, both tests green
3. Running `npm run test:e2e` a second time produces the same passing result
4. `grep -r 'data-testid' app/src/components/` shows 6+ occurrences across the target files
5. `cd app && npm run test -- --run` still passes (existing unit tests unaffected)
6. `cd app && npm run lint` passes (no lint errors from data-testid additions)
</verification>

<success_criteria>
- 6 production components have data-testid attributes with kebab-case names
- Smoke test navigates to /timesheets without redirect to /login (auth bypass proven)
- Smoke test sees ClientSelect, TopicCascadeSelect, DurationPicker, WeekStrip (data-testid proven)
- Smoke test verifies seed data appears in dropdowns (test database seeding proven)
- Running twice produces identical results (TRUNCATE cleanup proven)
- Existing unit tests and lint pass unmodified
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-infrastructure/05-02-SUMMARY.md`
</output>
