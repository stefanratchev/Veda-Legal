---
phase: 06-core-timesheet-workflow-tests
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - app/e2e/specs/entry-crud.spec.ts
autonomous: true
requirements: [REQ-13, REQ-14, REQ-15, REQ-16, REQ-17, REQ-18]

must_haves:
  truths:
    - "A REGULAR client entry with prefix subtopic can be created through the UI and appears in the entry list"
    - "An INTERNAL client entry with topic-only selection can be created through the UI and appears in the entry list"
    - "An existing entry's description and hours can be edited and the changes persist"
    - "Cancelling an edit discards changes and preserves original values"
    - "Confirming delete removes the entry from the list"
    - "Cancelling delete preserves the entry in the list"
  artifacts:
    - path: "app/e2e/specs/entry-crud.spec.ts"
      provides: "E2E tests for entry create, edit, delete workflows"
      contains: "test.describe"
      min_lines: 100
  key_links:
    - from: "app/e2e/specs/entry-crud.spec.ts"
      to: "app/e2e/pages/timesheets.page.ts"
      via: "import TimesheetsPage"
      pattern: "import.*TimesheetsPage.*from.*pages/timesheets.page"
    - from: "app/e2e/specs/entry-crud.spec.ts"
      to: "app/e2e/helpers/api-factory.ts"
      via: "import createEntryViaAPI/createRegularEntry"
      pattern: "import.*create.*Entry.*from.*helpers/api-factory"
    - from: "app/e2e/specs/entry-crud.spec.ts"
      to: "app/e2e/fixtures/test.ts"
      via: "import { test, expect }"
      pattern: "import.*test.*expect.*from.*fixtures/test"
---

<objective>
Create the entry-crud.spec.ts with ~8 e2e tests covering the full create/edit/delete lifecycle for time entries.

Purpose: This is the largest spec file, covering the core CRUD operations that users perform daily. It tests both REGULAR client entries (with subtopic prefix behavior) and INTERNAL client entries (topic-only), plus edit and delete flows with their cancel counterparts.

Output: `entry-crud.spec.ts` with passing tests for REQ-13 through REQ-18
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-timesheet-workflow-tests/06-RESEARCH.md
@.planning/phases/06-core-timesheet-workflow-tests/06-01-SUMMARY.md
@app/e2e/helpers/seed-data.ts
@app/e2e/pages/timesheets.page.ts
@app/e2e/helpers/api-factory.ts
@app/e2e/fixtures/test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entry tests (REGULAR + INTERNAL)</name>
  <files>app/e2e/specs/entry-crud.spec.ts</files>
  <action>
Create `app/e2e/specs/entry-crud.spec.ts`. Import `{ test, expect }` from `../fixtures/test`, `TimesheetsPage` from `../pages/timesheets.page`, seed data constants from `../helpers/seed-data`.

**Top-level describe:** `"Entry CRUD"`

**beforeEach:** Create `TimesheetsPage` instance, call `timesheets.goto()`.

**Test 1 - REQ-13: "creates entry for REGULAR client with prefix subtopic"**
1. Call `timesheets.selectClient(CLIENTS.regular.name)` ("Balkanova Industries")
2. Call `timesheets.selectTopicAndSubtopic(TOPICS.corporate.name, SUBTOPICS.correspondence.name)` ("Corporate Advisory" -> "Client correspondence:")
3. Assert description input has been pre-filled with `"Client correspondence: "` (note trailing space -- this is the prefix behavior)
4. Append additional text to make it at least 10 chars: `timesheets.fillDescription("Client correspondence: regarding new contract terms")` (or use appendDescription if POM has it)
5. Call `timesheets.selectDuration(2, 0)` (2 hours, 0 minutes)
6. Click Log button and wait for API response
7. Assert the entry appears: `expect(page.getByText("regarding new contract terms")).toBeVisible()`
8. Assert entry count is 1: `expect(timesheets.getEntryRows()).toHaveCount(1)`

**Test 2 - REQ-14: "creates entry for INTERNAL client with topic-only"**
1. Call `timesheets.selectClient(CLIENTS.internal.name)` ("Veda Legal (Internal)")
2. Call `timesheets.selectTopicOnly(TOPICS.firmAdmin.name)` ("Firm Administration")
3. Description should be auto-filled with topic name. Fill with a valid description (>= 10 chars): `timesheets.fillDescription("Firm Administration - weekly team sync meeting")`
4. Call `timesheets.selectDuration(1, 30)` (1 hour, 30 minutes)
5. Click Log button and wait for API response
6. Assert the entry appears in the list
7. Assert entry count is 1

**Important implementation notes:**
- Use `page.waitForResponse('**/api/timesheets')` after clicking Log to wait for POST to complete before asserting
- The TRUNCATE cleanup in beforeEach (from db fixture) ensures a clean slate every test
- Use seed data constants for all client/topic/subtopic names and IDs -- never hardcode strings that exist in seed-data.ts
- Description must be >= 10 chars (MIN_DESCRIPTION_LENGTH from api-utils.ts)

After writing these two tests, run: `cd app && npx playwright test entry-crud` to verify both pass.

If tests fail due to locator issues with the POM, fix the POM in `app/e2e/pages/timesheets.page.ts` -- the POM is the abstraction layer and should be adjusted to match real component behavior. Document any POM fixes as deviations.
  </action>
  <verify>
    <automated>cd app && npx playwright test entry-crud --grep "creates entry" 2>&1 | tail -20</automated>
    <manual>Both create-entry tests pass: REGULAR with prefix subtopic, INTERNAL with topic-only</manual>
  </verify>
  <done>Two create-entry tests pass: REGULAR client with prefix subtopic pre-fill (REQ-13) and INTERNAL client with topic-only selection (REQ-14)</done>
</task>

<task type="auto">
  <name>Task 2: Edit and delete entry tests</name>
  <files>app/e2e/specs/entry-crud.spec.ts</files>
  <action>
Add edit and delete tests to the existing `entry-crud.spec.ts` file.

**Nested describe:** `"Edit entry"` (within the top-level "Entry CRUD" describe)

**beforeEach for edit describe:** Use API factory to create a test entry:
```typescript
const today = getToday();
await createRegularEntry(page, today, 2, "Original description text");
await timesheets.goto(); // Reload to see the entry
```

**Test 3 - REQ-15: "edits entry description and hours"**
1. Verify the entry is visible: `expect(page.getByText("Original description text")).toBeVisible()`
2. Click edit on row 0: `timesheets.clickEditOnRow(0)`
3. Wait for the inline edit form to appear (description input should now be editable and contain "Original description text")
4. Clear and fill description with new text: `timesheets.fillDescription("Updated description for edit test")`
5. Change duration: `timesheets.selectDuration(3, 30)` (change from 2:00 to 3:30)
6. Click Save button: `timesheets.clickSave()`
7. Wait for PATCH response: `page.waitForResponse('**/api/timesheets/**')`
8. Assert new description visible: `expect(page.getByText("Updated description for edit test")).toBeVisible()`
9. Assert old description gone: `expect(page.getByText("Original description text")).not.toBeVisible()`

**Test 4 - REQ-16: "cancel edit discards changes"**
1. Verify entry visible
2. Click edit on row 0
3. Fill description with different text: "This should not be saved"
4. Click Cancel: `timesheets.clickCancel()`
5. Assert original description is still visible: `expect(page.getByText("Original description text")).toBeVisible()`
6. Assert the unsaved text is NOT visible: `expect(page.getByText("This should not be saved")).not.toBeVisible()`

**Nested describe:** `"Delete entry"` (within the top-level "Entry CRUD" describe)

**beforeEach for delete describe:** Same as edit -- create entry via API, goto page.

**Test 5 - REQ-17: "confirm delete removes entry"**
1. Verify entry visible, assert entry count is 1
2. Click delete on row 0: `timesheets.clickDeleteOnRow(0)`
3. Wait for ConfirmModal to appear: `expect(page.getByText("Delete Entry")).toBeVisible()`
4. Click confirm: `timesheets.confirmDelete()`
5. Wait for DELETE response: `page.waitForResponse('**/api/timesheets/**')`
6. Assert entry count is 0: `expect(timesheets.getEntryRows()).toHaveCount(0)`

**Test 6 - REQ-18: "cancel delete preserves entry"**
1. Verify entry visible, assert entry count is 1
2. Click delete on row 0
3. Wait for ConfirmModal
4. Click cancel: `timesheets.cancelDelete()`
5. Assert ConfirmModal is gone
6. Assert entry is still visible and count is still 1

**Implementation notes:**
- For edit tests, the entry form replaces the table row inline. The POM's selectDuration, fillDescription methods should work within the edit form context since there's only one EntryForm visible at a time.
- Set up `page.waitForResponse()` BEFORE the action that triggers the API call (assign promise first, then click, then await promise).
- If edit tests reveal issues with POM methods in edit mode context, fix the POM accordingly.

After writing all tests, run: `cd app && npx playwright test entry-crud` to verify all 6 pass.
  </action>
  <verify>
    <automated>cd app && npx playwright test entry-crud 2>&1 | tail -20</automated>
    <manual>All 6 entry-crud tests pass: 2 create + 2 edit + 2 delete</manual>
  </verify>
  <done>Six entry-crud tests pass covering: create REGULAR entry (REQ-13), create INTERNAL entry (REQ-14), edit with changes (REQ-15), edit cancel (REQ-16), delete confirm (REQ-17), delete cancel (REQ-18)</done>
</task>

</tasks>

<verification>
1. `cd app && npx playwright test entry-crud` -- all 6 tests pass
2. Tests use POM methods (no raw locators in spec file except for specific assertions)
3. Edit/delete tests use API factory for setup (not UI interaction)
4. Create tests use full UI interaction (validating the form workflow)
5. Existing smoke test still passes: `cd app && npx playwright test smoke`
</verification>

<success_criteria>
- 6 tests in entry-crud.spec.ts all pass
- REGULAR client test verifies prefix subtopic pre-fills description (REQ-13)
- INTERNAL client test verifies topic-only selection works (REQ-14)
- Edit test verifies description and hours changes persist (REQ-15)
- Cancel edit test verifies changes are discarded (REQ-16)
- Delete confirm test verifies entry removed from list (REQ-17)
- Delete cancel test verifies entry preserved in list (REQ-18)
- Zero page.waitForTimeout() calls
- Zero CSS class selectors
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-timesheet-workflow-tests/06-02-SUMMARY.md`
</output>
