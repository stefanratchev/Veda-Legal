---
phase: 12-tab-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/billing/BillingContent.tsx
  - app/src/components/billing/BillingContent.test.tsx
autonomous: true
requirements:
  - TABS-01
  - TABS-02
  - TABS-03
  - TABS-04
  - TABS-05

must_haves:
  truths:
    - "User sees a tab bar with 'Ready to Bill' and 'Service Descriptions' tabs on the billing page"
    - "Clicking 'Ready to Bill' shows the unbilled clients grid with create/continue actions"
    - "Clicking 'Service Descriptions' shows the SD table with status filter and search"
    - "Navigating to ?tab=service-descriptions opens that tab directly"
    - "No query param defaults to Ready to Bill tab"
    - "Tab state survives page refresh (URL is source of truth)"
  artifacts:
    - path: "app/src/components/billing/BillingContent.tsx"
      provides: "Tabbed billing layout with URL-persisted active tab"
      contains: "useSearchParams"
    - path: "app/src/components/billing/BillingContent.test.tsx"
      provides: "Tests for tab navigation, URL persistence, default tab"
      min_lines: 50
  key_links:
    - from: "app/src/components/billing/BillingContent.tsx"
      to: "URL search params"
      via: "useSearchParams from next/navigation"
      pattern: "useSearchParams.*tab"
    - from: "app/src/components/billing/BillingContent.tsx"
      to: "UnbilledClientsSection"
      via: "Conditional render inside Ready to Bill tab"
      pattern: "activeTab.*ready-to-bill.*UnbilledClientsSection"
    - from: "app/src/components/billing/BillingContent.tsx"
      to: "DataTable + TableFilters"
      via: "Conditional render inside Service Descriptions tab"
      pattern: "activeTab.*service-descriptions.*DataTable"
---

<objective>
Refactor the billing page into a tabbed layout with "Ready to Bill" and "Service Descriptions" tabs, persisted via URL query parameter.

Purpose: Users navigate billing workflows through distinct tabs instead of a single monolithic page. This is a restructuring of existing content -- no new features.
Output: Updated BillingContent.tsx with tab bar and URL-persisted tab state, plus tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@app/src/components/billing/BillingContent.tsx
@app/src/components/billing/UnbilledClientsSection.tsx
@app/src/components/reports/ReportsContent.tsx (tab bar pattern reference)

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From app/src/components/billing/BillingContent.tsx (current structure to refactor):
```typescript
interface ServiceDescriptionListItem {
  id: string;
  clientId: string;
  clientName: string;
  periodStart: string;
  periodEnd: string;
  status: ServiceDescriptionStatus;
  totalAmount: number;
  updatedAt: string;
}

interface Client {
  id: string;
  name: string;
}

interface BillingContentProps {
  initialServiceDescriptions: ServiceDescriptionListItem[];
  clients: Client[];
}
```

From app/src/components/reports/ReportsContent.tsx (tab bar pattern to follow):
```typescript
// Tab bar pattern used in reports -- follow this visual pattern exactly
<div className="flex border-b border-[var(--border-subtle)]">
  {tabs.map((tab) => (
    <button
      key={tab.id}
      onClick={() => handleTabClick(tab.id)}
      className={`px-4 py-2.5 text-[13px] font-medium transition-colors relative
        ${activeTab === tab.id
          ? "text-[var(--accent-pink)]"
          : "text-[var(--text-secondary)] hover:text-[var(--text-primary)]"
        }`}
    >
      {tab.label}
      {activeTab === tab.id && (
        <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-[var(--accent-pink)]" />
      )}
    </button>
  ))}
</div>
```

From app/src/components/billing/UnbilledClientsSection.tsx:
```typescript
export interface UnbilledClientsSectionProps {
  onCreateServiceDescription: (clientId: string, periodStart: string, periodEnd: string) => Promise<void>;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor BillingContent into tabbed layout with URL persistence</name>
  <files>app/src/components/billing/BillingContent.tsx</files>
  <action>
Refactor BillingContent.tsx to add a tabbed layout. The component's props and external interface do NOT change -- this is purely an internal restructuring.

**Add URL-based tab state:**
- Import `useSearchParams` and `useRouter` from `next/navigation` (useRouter already imported)
- Read active tab from URL: `const searchParams = useSearchParams()` then `searchParams.get("tab")`
- Define tab type: `type BillingTab = "ready-to-bill" | "service-descriptions"`
- Derive active tab: if `searchParams.get("tab") === "service-descriptions"` use that, otherwise default to `"ready-to-bill"` (TABS-05)
- Tab switching: update URL via `router.push(\`/billing?tab=\${tabId}\`)` (or `router.push("/billing")` for ready-to-bill since it's default)
- Use `usePathname` from next/navigation if needed to construct the URL, OR just use `router.replace(\`?tab=\${tabId}\`, { scroll: false })` to avoid full navigation

**Add tab bar (follow ReportsContent.tsx pattern exactly):**
- Place tab bar between the page header and the content area
- Two tabs: `{ id: "ready-to-bill", label: "Ready to Bill" }` and `{ id: "service-descriptions", label: "Service Descriptions" }`
- Use identical tab bar styling from ReportsContent: `flex border-b border-[var(--border-subtle)]`, button with `px-4 py-2.5 text-[13px] font-medium`, active state uses `text-[var(--accent-pink)]` with bottom underline indicator
- No animation on tab switch (per project animation rule)

**Restructure content rendering:**
- When `activeTab === "ready-to-bill"`: render `<UnbilledClientsSection>` only (no SD table)
- When `activeTab === "service-descriptions"`: render the Service Descriptions h2, TableFilters, DataTable, and delete confirm modal
- The `CreateServiceDescriptionModal` stays available in both tabs (it's triggered from UnbilledClientsSection)
- The page header ("Billing" h1 + subtitle) stays above the tab bar, always visible

**Important details:**
- Remove the `border-t border-[var(--bg-surface)] pt-6` separator div that currently sits between UnbilledClientsSection and SD section -- tabs replace this visual separation
- Remove the "Service Descriptions" h2 heading -- the tab label serves this purpose now
- Keep all existing state (searchQuery, statusFilter, serviceDescriptions, etc.) -- they persist across tab switches per CONTEXT.md Claude's discretion
- Keep all existing callbacks (handleCreate, handleRowClick, handleDelete, handleConfirmDelete) unchanged
- The `showCreateModal` state and CreateServiceDescriptionModal should remain functional in both tabs
  </action>
  <verify>
cd /Users/stefan/projects/veda-legal-timesheets/app && npm run build 2>&1 | tail -5
  </verify>
  <done>
BillingContent renders a tab bar with "Ready to Bill" and "Service Descriptions" tabs. Active tab derived from URL ?tab= param. Default is "ready-to-bill". Tab content conditionally renders existing UnbilledClientsSection or SD table+filters. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for tab navigation behavior</name>
  <files>app/src/components/billing/BillingContent.test.tsx</files>
  <action>
Create BillingContent.test.tsx with tests covering all 5 requirements.

**Mock setup:**
- Mock `next/navigation` with `useRouter` (returning `mockPush`/`mockReplace`), `useSearchParams` (returning configurable params), and `usePathname` if used
- Mock the UnbilledClientsSection component to a simple div with data-testid (avoids its internal fetch)
- Mock DataTable and TableFilters similarly to simplify rendering

**Test cases:**

1. **TABS-01 — Tab bar renders both tabs:**
   - Render BillingContent with default params (no ?tab)
   - Assert two tab buttons exist: "Ready to Bill" and "Service Descriptions"

2. **TABS-02 — Ready to Bill tab shows UnbilledClientsSection:**
   - Render with no ?tab param
   - Assert UnbilledClientsSection mock is rendered (via data-testid)
   - Assert DataTable is NOT rendered

3. **TABS-03 — Service Descriptions tab shows SD table:**
   - Render with ?tab=service-descriptions
   - Assert DataTable mock is rendered
   - Assert TableFilters mock is rendered
   - Assert UnbilledClientsSection is NOT rendered

4. **TABS-04 — Tab state persisted in URL:**
   - Render with no ?tab param
   - Click "Service Descriptions" tab button via fireEvent.click
   - Assert router.replace (or router.push) was called with URL containing ?tab=service-descriptions

5. **TABS-05 — Default tab is Ready to Bill:**
   - Render with no ?tab param
   - Assert "Ready to Bill" tab has active styling (text-[var(--accent-pink)] or check for the underline span)
   - Assert UnbilledClientsSection is visible

6. **Edge case — Unknown tab value defaults to Ready to Bill:**
   - Render with ?tab=invalid-value
   - Assert "Ready to Bill" tab is active and UnbilledClientsSection is rendered

**Test patterns to follow:**
- Use `vi.mock()` for module mocking (same pattern as UnbilledClientsSection.test.tsx)
- Use `fireEvent` from @testing-library/react (NOT user-event, which is not installed)
- Use `screen.getByRole("button", { name: "Ready to Bill" })` for tab buttons
- Provide minimal valid props: `initialServiceDescriptions: []` and `clients: []`
  </action>
  <verify>
cd /Users/stefan/projects/veda-legal-timesheets/app && npx vitest run BillingContent.test --reporter=verbose 2>&1 | tail -20
  </verify>
  <done>
All 6 test cases pass. Tests verify: tab bar renders, Ready to Bill shows unbilled clients, Service Descriptions shows SD table, URL param drives tab state, default is Ready to Bill, unknown tab values default correctly.
  </done>
</task>

</tasks>

<verification>
1. `cd app && npm run build` — no TypeScript or build errors
2. `cd app && npx vitest run BillingContent.test --reporter=verbose` — all tests pass
3. `cd app && npm run lint` — no lint errors in modified files
4. Manual: visit /billing — see tab bar, "Ready to Bill" active by default
5. Manual: click "Service Descriptions" — URL updates to ?tab=service-descriptions, SD table shows
6. Manual: refresh page on ?tab=service-descriptions — tab persists
7. Manual: remove ?tab param — defaults back to Ready to Bill
</verification>

<success_criteria>
- Tab bar with two tabs visible on billing page
- "Ready to Bill" is default when no ?tab param
- Clicking tabs updates URL and swaps content
- Direct navigation to ?tab=service-descriptions works
- All existing billing functionality preserved (create SD, delete SD, filters, search)
- All tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-tab-navigation/12-01-SUMMARY.md`
</output>
